var user_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>';
var user_checked = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M173.898 439.404l-166.4-166.4c-9.997-9.997-9.997-26.206 0-36.204l36.203-36.204c9.997-9.998 26.207-9.998 36.204 0L192 312.69 432.095 72.596c9.997-9.997 26.207-9.997 36.204 0l36.203 36.204c9.997 9.997 9.997 26.206 0 36.204l-294.4 294.401c-9.998 9.997-26.207 9.997-36.204-.001z"></path></svg>';
var screen_short_icon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M20 3H4c-1.11 0-2 .89-2 2v12a2 2 0 002 2h4v2h8v-2h4c1.1 0 2-.9 2-2V5a2 2 0 00-2-2zm0 14H4V5h16v12z"></path><path d="M6.5 7.5H9V6H5v4h1.5zM19 12h-1.5v2.5H15V16h4z"></path></svg>';
var share_icon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 220 200" height="18" width="18" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve"> <path fill="currentColor" d="M128.002,174.893c-25.824,10.856-55.761,5.63-76.456-13.409c17.481-18.517,4.467-49.346-21.274-49.346 C14.131,112.138,1,125.27,1,141.411c0,19.861,19.495,34.034,38.408,27.805c24.83,24.902,62.124,31.979,94.016,18.573 c3.56-1.496,5.234-5.598,3.735-9.16C135.664,175.069,131.564,173.396,128.002,174.893L128.002,174.893z M14.989,141.411 c0-8.427,6.855-15.283,15.283-15.283c8.426,0,15.282,6.856,15.282,15.283s-6.855,15.282-15.282,15.282 C21.845,156.693,14.989,149.838,14.989,141.411z"/> <path fill="currentColor" d="M23.708,88.273c3.644,1.325,7.648-0.566,8.965-4.181C39.639,64.94,54.739,49.47,73.56,41.929 c4.619,10.106,14.815,17.149,26.632,17.149c16.14,0,29.272-13.131,29.272-29.272c0-16.14-13.132-29.271-29.272-29.271 c-15.512,0-28.238,12.132-29.205,27.404c-23.95,8.684-42.817,27.608-51.461,51.371C18.206,82.939,20.077,86.953,23.708,88.273 L23.708,88.273z M100.193,14.523c8.426,0,15.281,6.855,15.281,15.282s-6.854,15.283-15.281,15.283 c-8.428,0-15.283-6.855-15.283-15.283C84.911,21.378,91.766,14.523,100.193,14.523z"/> <path fill="currentColor" d="M185.615,116.597c0.248-1.387,0.393-5.853,0.393-7.949c0-24.25-10.332-47.48-28.349-63.734 c-2.868-2.587-7.29-2.36-9.879,0.508c-2.588,2.868-2.361,7.291,0.508,9.879c15.778,14.234,24.703,35.034,23.641,56.899 c-17.003-1.046-31.086,12.519-31.086,29.212c0,16.14,13.13,29.271,29.271,29.271c16.142,0,29.272-13.132,29.272-29.271 C199.386,130.96,193.877,121.776,185.615,116.597L185.615,116.597z M170.112,156.693c-8.425,0-15.281-6.855-15.281-15.282 c0-8.428,6.856-15.284,15.281-15.284c8.429,0,15.282,6.856,15.282,15.284C185.396,149.838,178.541,156.693,170.112,156.693z"/> </svg>';
var priority_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="m21 16-4 4-4-4"></path><path d="M17 20V4"></path><path d="m3 8 4-4 4 4"></path><path d="M7 4v16"></path></svg>';
var status_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>';
var info_icon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"></path><path d="M464 336a48 48 0 1 0 96 0 48 48 0 1 0-96 0zm72 112h-48c-4.4 0-8 3.6-8 8v272c0 4.4 3.6 8 8 8h48c4.4 0 8-3.6 8-8V456c0-4.4-3.6-8-8-8z"></path></svg>';
var image_download_icon = '<svg viewBox="0 0 512 512" id="ion-android-download" width="18" height="18" fill="#fff"><path d="M403.002 217.001C388.998 148.002 328.998 96 256 96c-57.998 0-107.998 32.998-132.998 81.001C63.002 183.002 16 233.998 16 296c0 65.996 53.999 120 120 120h260c55 0 100-45 100-100 0-52.998-40.996-96.001-92.998-98.999zM224 268v-76h64v76h68L256 368 156 268h68z"></path></svg>';
var push_to_media_icon='<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="32px" height="31px" viewBox="0 0 32 31" version="1.1">';
push_to_media_icon += '<g id="surface1"><path style=" stroke:none;fill-rule:nonzero;fill:#ffffff;fill-opacity:1;" d="M 16.234375 16.746094 L 13.558594 24.3125 L 13.550781 24.3125 L 11.476562 30.09375 C 11.621094 30.132812 11.761719 30.164062 11.910156 30.203125 C 11.917969 30.203125 11.925781 30.203125 11.933594 30.203125 C 13.222656 30.535156 14.578125 30.71875 15.972656 30.71875 C 16.667969 30.71875 17.34375 30.679688 18.007812 30.574219 C 18.921875 30.464844 19.800781 30.277344 20.660156 30.015625 C 20.871094 29.953125 21.082031 29.878906 21.296875 29.808594 C 21.066406 29.335938 20.578125 28.28125 20.554688 28.234375 Z M 16.234375 16.746094 "/>';
push_to_media_icon += '<path style=" stroke:none;fill-rule:nonzero;fill:#ffffff;fill-opacity:1;" d="M 1.6875 9.5625 C 0.871094 11.351562 0.316406 13.550781 0.316406 15.535156 C 0.316406 16.03125 0.339844 16.53125 0.390625 17.019531 C 0.953125 22.652344 4.707031 27.382812 9.867188 29.507812 C 10.078125 29.59375 10.300781 29.683594 10.519531 29.761719 L 2.929688 9.570312 C 2.277344 9.546875 2.152344 9.585938 1.6875 9.5625 Z M 1.6875 9.5625 "/>';
push_to_media_icon += '<path style=" stroke:none;fill-rule:nonzero;fill:#ffffff;fill-opacity:1;" d="M 30.210938 9.160156 C 29.859375 8.425781 29.441406 7.722656 28.976562 7.058594 C 28.847656 6.867188 28.699219 6.675781 28.5625 6.488281 C 26.804688 4.210938 24.414062 2.421875 21.628906 1.378906 C 19.882812 0.714844 17.972656 0.351562 15.980469 0.351562 C 11.058594 0.351562 6.660156 2.566406 3.785156 6.019531 C 3.253906 6.652344 2.78125 7.332031 2.355469 8.046875 C 3.515625 8.054688 4.953125 8.054688 5.117188 8.054688 C 6.59375 8.054688 8.871094 7.878906 8.871094 7.878906 C 9.640625 7.832031 9.71875 8.914062 8.960938 9.003906 C 8.960938 9.003906 8.195312 9.089844 7.34375 9.128906 L 12.480469 23.917969 L 15.566406 14.957031 L 13.378906 9.136719 C 12.609375 9.097656 11.898438 9.011719 11.898438 9.011719 C 11.132812 8.972656 11.230469 7.839844 11.980469 7.886719 C 11.980469 7.886719 14.308594 8.0625 15.695312 8.0625 C 17.171875 8.0625 19.453125 7.886719 19.453125 7.886719 C 20.210938 7.839844 20.308594 8.921875 19.539062 9.011719 C 19.539062 9.011719 18.78125 9.097656 17.933594 9.136719 L 23.019531 23.816406 L 24.429688 19.257812 C 25.140625 17.488281 25.5 16.023438 25.5 14.855469 C 25.5 13.171875 24.871094 12 24.332031 11.089844 C 23.621094 9.960938 22.953125 9.011719 22.953125 7.894531 C 22.953125 6.636719 23.933594 5.46875 25.320312 5.46875 C 25.378906 5.46875 25.441406 5.46875 25.5 5.46875 C 27.640625 5.414062 28.339844 7.46875 28.429688 8.867188 C 28.429688 8.867188 28.429688 8.898438 28.429688 8.914062 C 28.464844 9.484375 28.4375 9.902344 28.4375 10.402344 C 28.4375 11.777344 28.167969 13.335938 27.371094 15.289062 L 24.1875 24.210938 L 22.367188 29.40625 C 22.511719 29.34375 22.652344 29.277344 22.796875 29.207031 C 27.425781 27.042969 30.796875 22.722656 31.507812 17.605469 C 31.613281 16.933594 31.664062 16.246094 31.664062 15.550781 C 31.664062 13.265625 31.140625 11.097656 30.210938 9.160156 Z M 30.210938 9.160156 "/>';
push_to_media_icon += '</g></svg>';
var image_close_icon = '<svg data-v-07452373="" height="18" width="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x feather__content"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
var image_external_icon = '<svg version="1.1" height="18" width="18" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="511.626px" height="511.627px" viewBox="0 0 511.626 511.627" style="enable-background:new 0 0 511.626 511.627;" xml:space="preserve"> <g> <g> <path d="M392.857,292.354h-18.274c-2.669,0-4.859,0.855-6.563,2.573c-1.718,1.708-2.573,3.897-2.573,6.563v91.361 c0,12.563-4.47,23.315-13.415,32.262c-8.945,8.945-19.701,13.414-32.264,13.414H82.224c-12.562,0-23.317-4.469-32.264-13.414 c-8.945-8.946-13.417-19.698-13.417-32.262V155.31c0-12.562,4.471-23.313,13.417-32.259c8.947-8.947,19.702-13.418,32.264-13.418 h200.994c2.669,0,4.859-0.859,6.57-2.57c1.711-1.713,2.566-3.9,2.566-6.567V82.221c0-2.662-0.855-4.853-2.566-6.563 c-1.711-1.713-3.901-2.568-6.57-2.568H82.224c-22.648,0-42.016,8.042-58.102,24.125C8.042,113.297,0,132.665,0,155.313v237.542 c0,22.647,8.042,42.018,24.123,58.095c16.086,16.084,35.454,24.13,58.102,24.13h237.543c22.647,0,42.017-8.046,58.101-24.13 c16.085-16.077,24.127-35.447,24.127-58.095v-91.358c0-2.669-0.856-4.859-2.574-6.57 C397.709,293.209,395.519,292.354,392.857,292.354z"/> <path d="M506.199,41.971c-3.617-3.617-7.905-5.424-12.85-5.424H347.171c-4.948,0-9.233,1.807-12.847,5.424 c-3.617,3.615-5.428,7.898-5.428,12.847s1.811,9.233,5.428,12.85l50.247,50.248L198.424,304.067 c-1.906,1.903-2.856,4.093-2.856,6.563c0,2.479,0.953,4.668,2.856,6.571l32.548,32.544c1.903,1.903,4.093,2.852,6.567,2.852 s4.665-0.948,6.567-2.852l186.148-186.148l50.251,50.248c3.614,3.617,7.898,5.426,12.847,5.426s9.233-1.809,12.851-5.426 c3.617-3.616,5.424-7.898,5.424-12.847V54.818C511.626,49.866,509.813,45.586,506.199,41.971z"/> </g> </g> </svg>';
var image_open_icon = '<svg height="18px" version="1.1" viewBox="0 0 100 100" width="18px" xmlns="http://www.w3.org/2000/svg" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns" xmlns:xlink="http://www.w3.org/1999/xlink"><title/><desc/><defs/><g fill="none" fill-rule="evenodd" id="MiMedia---Web" stroke="none" stroke-width="1"><g fill="#fff" id="icon24pt_new_window" transform="translate(2.000000, 2.000000)"><path d="M73.7883228,16 L44.56401,45.2243128 C42.8484762,46.9398466 42.8459918,49.728257 44.5642987,51.4465639 C46.2791092,53.1613744 49.0684023,53.1650001 50.7865498,51.4468526 L80,22.2334024 L80,32.0031611 C80,34.2058797 81.790861,36 84,36 C86.2046438,36 88,34.2105543 88,32.0031611 L88,11.9968389 C88,10.8960049 87.5527117,9.89722307 86.8294627,9.17343595 C86.1051125,8.44841019 85.1063303,8 84.0031611,8 L63.9968389,8 C61.7941203,8 60,9.790861 60,12 C60,14.2046438 61.7894457,16 63.9968389,16 L73.7883228,16 L73.7883228,16 Z M88,56 L88,36.9851507 L88,78.0296986 C88,83.536144 84.0327876,88 79.1329365,88 L16.8670635,88 C11.9699196,88 8,83.5274312 8,78.0296986 L8,17.9703014 C8,12.463856 11.9672124,8 16.8670635,8 L59.5664682,8 L40,8 C42.209139,8 44,9.790861 44,12 C44,14.209139 42.209139,16 40,16 L18.2777939,16 C17.0052872,16 16,17.1947367 16,18.668519 L16,77.331481 C16,78.7786636 17.0198031,80 18.2777939,80 L77.7222061,80 C78.9947128,80 80,78.8052633 80,77.331481 L80,56 C80,53.790861 81.790861,52 84,52 C86.209139,52 88,53.790861 88,56 L88,56 Z" id="Rectangle-2064"/></g></g></svg>';
var preview_image_icon = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" class="wpf_preview_icon" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0z"></path><path d="M19 19H5V5h7V3H5a2 2 0 00-2 2v14a2 2 0 002 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"></path></svg>';
var delete_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="wpf_delete_icon" height="18" width="18" xmlns="http://www.w3.org/2000/svg"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';
var download_file_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="wpf_download_file" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><title>download file</title><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>';
var edit_comment_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="at-ch-taskPopover-editIcon" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><title>Edit this comment</title><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>';
var delete_comment_icon = '<svg stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" class="at-ch-taskPopover-deleteIcon" height="16" width="16" xmlns="http://www.w3.org/2000/svg"><title>Delete this comment</title><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>';

const milestone_clock_icon            = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill="none" d="M0 0h24v24H0V0z"></path><path d="M15.07 1.01h-6v2h6v-2zm-4 13h2v-6h-2v6zm8.03-6.62l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42A8.962 8.962 0 0012.07 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.11-.74-4.06-1.97-5.61zm-7.03 12.62c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"></path></svg>';
const milestone_calender_icon         = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2V2h-2v2H9V2H7v2H5a2 2 0 0 0-2 2zm16 14H5V8h14z"></path></svg>';
const milestone_calender_check_icon   = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm.002 16H5V8h14l.002 12z"></path><path d="m11 17.414 5.707-5.707-1.414-1.414L11 14.586l-2.293-2.293-1.414 1.414z"></path></svg>';
const milestone_calender_plus_icon    = '<svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path d="M8 15h3v3h2v-3h3v-2h-3v-3h-2v3H8z"></path><path d="M19 4h-2V2h-2v2H9V2H7v2H5c-1.103 0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103 0 2-.897 2-2V6c0-1.103-.897-2-2-2zm.002 16H5V8h14l.002 12z"></path></svg>';
var wpf_reconnect_taskid = '';
var wpf_reconnect_tasknumber = '';
var wpf_reconnect = '';
var internal_icon_html = '<span class="wpf_chevron_wrapper wpf_internal_task_wrapper"><img src="' + plugin_url + 'images/eye-off-white.svg" alt="eye off white" class="wpf-internal-img"></span>';
var box = '', comments=false, browser='', device_type='', resolution = window.screen.width+' x '+window.screen.height, new_task = [], task_screenshot=[], rightArrowParents = [], current_html_element='', relative_location={}, html_element_location={}, html_element_height=0, html_element_width=0, tasks_on_page = [], onload_wpfb_tasks = [], all_page_tasks_loaded=0, wpf_tasks_loaded=false, wpf_clean_dom_elem_path='', temp_tasks = [], wpf_tab_permission = {'user':false,'status':false,'priority':false,'screenshot':false,'information':false,'delete_task':'no','auto_screenshot':false},wpf_reconnect = false,wpf_reconnect_meta = [],wpf_tag_initialized = [],img_dwn_icon = "",open_per=0,in_progress_per=0,pending_review_per=0,complete_per=0,total_task=0;
var current_bubble = 0;
var upg_url = upgrade_url.url;
var plugin_url = upgrade_url.plugin_url;
wpf_mark_internal_btn = '<img src="' + plugin_url + 'images/eye-off.svg" alt="eye off" class="wpf-internal-img"><span class="wpf_tooltiptext unmark_internal_tooltip_text">'+ switch_to_normal +'</span><span class="wpf_tooltiptext new_internal_tooltip_text">'+ create_internal_task +'</span><span class="wpf_tooltiptext mark_internal_tooltip_text">'+ switch_to_internal +'</span>';
var edit_comment_text = "Update";
var cancel_edit_comment_text = "Cancel";
var unsaved_task = true;
var wpf_all_tags = [];
var task_on_page = false;

function wpf_confirm(title, msg, ttrue, ffalse, temp_funct) {
    var $content =  "<div class='wpf_confirm_dialog_overlay'>" +
        "<div class='wpf_confirm_dialog'><header>" +
        " <h3> " + title + " </h3> " +
        "<i class='wpf-close'>X</i>" +
        "</header>" +
        "<div class='wpf_confirm_dialog_msg'>" +
        " <p> " + msg + " </p> " +
        "</div>" +
        "<footer>" +
        "<div class='wpf_confirm_dialog_controls'>" +
        " <button class='wpf_confirm_yes'>" + ttrue + "</button> " +
        " <button class='wpf_confirm_cancle'>" + ffalse + "</button> " +
        "</div>" +
        "</footer>" +
        "</div>" +
        "</div>";
    jQuery_WPF('body').prepend($content);
    jQuery_WPF('.wpf_confirm_yes').click(function () {
        jQuery_WPF(this).parents('.wpf_confirm_dialog_overlay').fadeOut(500, function () {
            jQuery_WPF(this).remove();
        });
        window[temp_funct]();
        return true;
    });
    jQuery_WPF('.wpf_confirm_cancle, .wpf-close').click(function () {
        jQuery_WPF(this).parents('.wpf_confirm_dialog_overlay').fadeOut(500, function () {
            jQuery_WPF(this).remove();
        });
        return false;
    });
}
// Get the URL parameters.
const getParams = function (url) {
    var params = {};
    var parser = document.createElement('a');
    parser.href = url;
    var query = parser.search.substring(1);
    var vars = query.split('&');
    for (var i = 0; i < vars.length; i++) {
        var pair = vars[i].split('=');
        params[pair[0]] = decodeURIComponent(pair[1]);
    }
    return params;
};
function new_comment(id, internal=0, note=false){
    if(tasks_on_page[id]!=0) {
        if(internal==1){
            if(jQuery_WPF('#wpf_mark_internal_'+id).hasClass('wpf_is_internal')){
                mark_internal(id,0);
            }else{ /*updated by Pratap*/
                jQuery_WPF.ajax({
                    url: ajaxurl,
                    type: 'POST',
                    data: {action:'wpf_is_internal_allowed' },
                    success: function(data){
                        if(data == 'false'){
                            jQuery_WPF('.wpf-uf-popup-image img').attr('src', plugin_url + '/images/internal-task.png');
                            jQuery_WPF('.wpf-uf-plan-title').text('Internal Tasks');
                            jQuery_WPF('.wpf-uf-plan-detail').html('Make it easy to collaborate with your team on tasks that your clients cannot see with internal tasks. Change the logo, icon and main color to give your clients’ a unique experience.');
                            jQuery_WPF('.wpf-uf-plan-link').attr('href', upg_url + '?&feature=internal');
                            jQuery_WPF('.wpf-uf-pop-wrapper').show();
                        } else {
                            mark_internal(id,1);
                        }
                    }
                });
            }
            return;
        }
    }

    jQuery_WPF('#popover-content-c' + id).parents('.popover').attr("data-html2canvas-ignore", "true");
    if(jQuery_WPF.trim(jQuery_WPF('textarea#comment-'+id).val()).length == 0 && allFiles.length == 0){
        jQuery_WPF('textarea#comment-'+id).attr('style','border: 1px solid red;');
        jQuery_WPF('textarea#comment-'+id).focus();
        jQuery_WPF('#wpf_task_error_'+id).show();
        jQuery_WPF('#wpf_error_'+id).hide();
        jQuery_WPF('#wpf_note_error_'+id).hide();
        return false;
    } else {
        jQuery_WPF('#wpf_task_error_'+id).hide();
        if ( internal == 0 ) {
            if(jQuery_WPF('input[name="author_list_'+id+'"]:checked').length > 0){
                jQuery_WPF('#wpf_error_'+id).hide();
            } else {
                jQuery_WPF('#wpfbuser-tab-'+id).click();
                jQuery_WPF('#wpf_task_error_'+id).hide();
                jQuery_WPF('#wpf_error_'+id).show();
                return false;
            }
        }
    }
    if(tasks_on_page[id] == 0){
        if ( note ) {
            jQuery_WPF('#wpf_note_error_'+id).show();
            return false;
        } else {
            jQuery_WPF('#wpf_note_error_'+id).hide();
            generate_task(id, internal, note);
        }
    } else {
        generate_comment(id, note);
    }
}
var old_rendered_box_el = null;
// Code to generate new task.
function generate_task(id, internal, note) {
    // Initialize base64 URL variable
    var base64URL = '';

    // Capture screenshot of the document body
    html2canvas(document.body, {
        x: window.scrollX,
        y: window.scrollY,
        width: window.innerWidth,
        height: window.innerHeight,
        useCORS: true,
        proxy: plugin_url + 'imagehelper.php',
        logging: true
    }).then(function(canvas) {
        base64URL = canvas.toDataURL('image/jpeg', 1);
    });

    // Generate unique ID and class for the task
    var temp_id = Math.floor(100000 + Math.random() * 900000);
    var temp_class = 'temp_class_' + temp_id;

    // Initialize variables
    var wpside = logged_user.wpside;
    var curr_browser = get_browser();
    var task_priority = jQuery_WPF('input[name=wpfbpriority' + id + ']:checked').val();
    var task_status = jQuery_WPF('input[name=wpfbtaskstatus' + id + ']:checked').val();
    var raw_comment = jQuery_WPF('textarea#comment-' + id).val();
    var task_comment = raw_comment.replace(/(<p><br><\/p>)+$/, '');
    var task_notify_users = [];
    var task_notify_usernames = [];

    // Collect notified users and usernames
    jQuery_WPF.each(jQuery_WPF('input[name=author_list_' + id + ']:checked'), function() {
        task_notify_users.push(jQuery_WPF(this).val());
        task_notify_usernames.push(jQuery_WPF(this).data('wp-usrn'));
    });

    var task_notify_users = task_notify_users.join(",");

    // Create new task object
    var new_task = {
        task_number: id,
        task_priority: task_priority,
        task_status: task_status,
        task_config_author_browser: curr_browser.name,
        task_config_author_browserVersion: curr_browser.version,
        task_config_author_browserOS: curr_browser.OS,
        task_config_author_name: current_user_name,
        task_config_author_id: current_user_id,
        task_config_author_resX: window.screen.width,
        task_config_author_resY: window.screen.height,
        task_title: task_comment,
        task_page_url: current_page_url,
        task_page_title: current_page_title,
        current_page_id: current_page_id,
        task_comment_message: task_comment,
        task_notify_users: task_notify_users,
        is_note: note,
    };

    // Set additional properties based on conditions
    if (wpside === 'frontend') {
        new_task.page_type = page_type;
        if ( fallback_link_check == 1 ) {
            new_task.task_type = 'element';
        } else {
            if ( current_page_id == '' || current_page_id == 0 ) {
                new_task.task_type = 'general';
            } else {
                new_task.task_type = 'element';
            }
        }
    }

    if (wpside === 'backend') {
        new_task.wpf_current_screen = wpf_current_screen || '';
        new_task.task_page_title = '';
        new_task.is_admin_task = 1;
        new_task.task_type = 'element';
    }

    if (internal === 1) {
        new_task.internal = '1';
    }

    if (typeof temp_tasks[id] !== 'undefined') {
        var task_element_path = temp_tasks[id]['rightArrowParents'].join(" > ");
        Object.assign(new_task, {
            task_element_path: task_element_path,
            task_clean_dom_elem_path: temp_tasks[id]['wpf_clean_dom_elem_path'],
            task_element_html: temp_tasks[id]['current_html_element'],
            task_X: temp_tasks[id]['relative_location'].x,
            task_Y: temp_tasks[id]['relative_location'].y,
            task_elementX: temp_tasks[id]['html_element_location'].x,
            task_elementY: temp_tasks[id]['html_element_location'].y,
            task_relativeX: '',
            task_relativeY: '',
            task_element_height: temp_tasks[id]['html_element_height'],
            task_element_width: temp_tasks[id]['html_element_width']
        });
    } else {
        new_task.task_type = 'general';
    }

    // Process comment for URL or video
    var temp_task_text = task_comment;
    var strippedString = task_comment.replace(/(<([^>]+)>)/gi, "");
    if (wpf_is_valid_url(strippedString)) {
        if (is_video_Url(strippedString)) {
            temp_task_text = wpf_is_valid_video_url(strippedString);
        } else {
            temp_task_text = URLify(strippedString);
        }
    }

    // Create FormData object for upload
    var wpf_upload_form = new FormData();
    wpf_upload_form.append('action', 'wpf_add_new_task');
    wpf_upload_form.append('wpf_nonce', wpf_nonce);
    wpf_upload_form.append('new_task', JSON.stringify(new_task));

    if (allFiles.length > 0) {
        allFiles.forEach(function(file) {
            wpf_upload_form.append('wpf_upload_file[]', file);
        });
    } else {
        wpf_upload_form.append('wpf_upload_file[]', '');
    }

    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data: wpf_upload_form,
        contentType: false,
        processData: false,
        beforeSend: function() {
            if ( jQuery_WPF('ul#wpf_thispage_container_today li').length == 0 ) {
                jQuery_WPF('.wpf_no_task').hide();
            }

            var wpf_task_status_label;
            var wpf_task_priority_label;
            if (wpf_tab_permission.display_stickers === 'yes') {
                wpf_task_status_label = `
                    <div class="wpf_task_label">
                        <span class="task_status wpf_${new_task['task_status']} wpf_${new_task['task_status']}_custom">${status_icon}</span>
                    </div>`;
                wpf_task_priority_label = `
                    <span class="priority wpf_${new_task['task_priority']} wpf_${new_task['task_priority']}_custom">${priority_icon}</span>`;
            } else {
                wpf_task_status_label = `
                    <div class="wpf_task_label">
                        <span class="task_status wpf_${new_task['task_status']}">${status_icon}</span>
                    </div>`;
                wpf_task_priority_label = `
                    <span class="priority wpf_${new_task['task_priority']}">${priority_icon}</span>`;
            }

            var wpfb_tags_html ='';
            var user_html = '';
            if (Object.keys(task_notify_usernames).length > 0) {
                jQuery_WPF.each(task_notify_usernames, function(index, value) {
                    user_html += `<span class="wpf_user_avat">${value.slice(0, 2)}</span>`;
                });
            }

            var view_id;
            if (new_task['task_type'] === 'general') {
                view_id = bubble_comment_count;
                bubble_comment_count++;
            } else {
                view_id = bubble_comment_count;
            }

            var display_check_mark = '';
            if(wpf_tab_permission.display_task_id !== 'yes') {
                display_check_mark = '<i class="gg-check"></i>';
            } else {
                display_check_mark = view_id;
            }

            if (internal === 1) {
                var internal_icon = internal_icon_html;
                jQuery_WPF('#bubble-' + id).append(internal_icon);
                jQuery_WPF('#wpf_mark_internal_' + id)
                    .addClass('wpf_is_internal')
                    .removeClass('new_internal_tooltip')
                    .addClass('unmark_internal_tooltip');
                jQuery_WPF('#bubble-' + id).addClass('wpfb-internal');
            } else {
                internal_icon = '';
            }

            var sticker_span = '';
            if (wpf_tab_permission.display_stickers === 'yes') {
                sticker_span = `<span class="sticker ${task_priority}_custom"></span> `;
            }

            let bubble_label = '';
            if (new_task['task_status'] === 'complete') {
                bubble_label = sticker_span + display_check_mark;
            } else {
                bubble_label = sticker_span + `<span class="wpf_bubble_num_wrapper">${view_id}</span>`;
            }

            var wpf_dal_taskmeta = jQuery_WPF('#wpf_display_all_taskmeta').is(":checked");
            if(wpf_dal_taskmeta) {
                var wpfactv = 'wpf_active';
            }

            let internall = '';
            if (internal) {
                internall = '<span class="wpf_task_type" title="Task type">Internal</span>';
            }
            
            const tag = new_task['task_type'] === 'general' ? wpf_general_tag : wpf_email_tag;
            const taskTypeClass = new_task['task_type'] === 'general' ? 'current_page_general_task' : 'current_page_task';
            const taskStatussticker = wpf_tab_permission.display_stickers === 'yes' ? `${task_status}_custom` : '';
            const generalTag = new_task['task_type'] === 'general' ? `<span class="wpf_task_type" title="Task type">${tag}</span>` : '';

            let taskHtml = `
                <li class="${temp_class} ${task_status} ${taskStatussticker} ${task_priority} ${taskTypeClass}" data-taskid="${id}" data-postid="">
                    <div class="wpf_task_info">
                        <div class="wpf_task_number" title="${wpf_remap_text}" data-disp-id="${view_id}">
                            ${bubble_label}${internal_icon}
                        </div>
                        <div class="wpf_task_sum">
                            <level class="task-author">${current_user_name}<span>${wpf_just_now}</span></level>
                            <div class="current_page_task_list">${task_comment}</div>
                        </div>
                    </div>
                    <div class="wpf_task_meta">
                        <div class="wpf_task_tagg">
                            ${internall}${generalTag}${wpfb_tags_html}
                        </div>
                        <div class="wpf_user_avatar">${user_html}</div>
                    </div>
                </li>`;

            jQuery_WPF('#wpf_thispage_container_today').prepend(taskHtml);

            let $class = "wpf_author";
            let note_html = '';
            if (note === true) {
                $class = "wpf_author is_note";
                note_html = '<small class="wpf_note_html">Note</small>';
            }

            let author_html = '';
            if (logged_user.author_img === '' || logged_user.author_img === 'undefined') {
                author_html = logged_user.author !== '' ? logged_user.author.slice(0, 2) : current_user_name.slice(0, 2);
            } else {
                author_html = `<img src="${logged_user.author_img}" alt="author">`;
            }

            // comment_data = responseData['data'];
            var comment_data = [{'id': 0}];

           // Determine HTML for edit/delete buttons based on permissions
           let edit_delete_button_html = getEditDeleteButtonHTML(comment_data['id']);

            var files_html = get_files_html(temp_files);

            // getcomment HTML
            var comment_html = createCommentHtml({
                className: $class,
                tempClass: temp_class,
                authorHtml: author_html,
                currentUserName: current_user_name,
                noteHtml: note_html,
                wpfJustNow: wpf_just_now,
                tempTaskText: temp_task_text,
                editDeleteButtonHtml: edit_delete_button_html,
                filesHtml: files_html,
                commentDataId: comment_data['id'],
                editCommentText: edit_comment_text,
                cancelEditCommentText: cancel_edit_comment_text
            });

            // Append the new comment HTML to the comments list
            var $commentElement = jQuery_WPF(comment_html);
            jQuery_WPF('#task_comments_' + id).append($commentElement);

            const img_dwn_icon = '';
            if (id === 1 && wpf_current_role === 'advisor') {
                const masic_msg = "Awesome! You have just added your first task on the website. Let's start managing it from the dashboard. <a class='wpf_demo_cta' href='https://app.atarim.io/login' target='_blank'>Explore more in the Atarim Dashboard</a>";
                const masic_current_user_name = "Atarim";

                const masic_comment_html = `
                    <li class="wpf_other magic_msg_replied">
                        <level class="task-author">${masic_current_user_name}</level>
                        <div class="meassage_area_main">
                            ${img_dwn_icon}
                            <div class="chat_text">${masic_msg}</div>
                        </div>
                    </li>`;

                setTimeout(() => {
                    jQuery_WPF('#task_comments_' + id).append(masic_comment_html);
                }, 2000);
            }

            const deleteButtonHtml = `
                <span class="wpfbsysinfo_delete_btn_task_id_${id}">
                    <a href="javascript:void(0)" class="wpf_task_delete_btn" data-btn_taskid="${id}" style="color:red;">
                        <i class="gg-trash"></i>${wpf_delete_ticket}
                    </a>
                </span>
                <p class="wpfbsysinfo_delete_task_id_${id} wpf_hide">
                    <b>${wpf_delete_conform_text1}</b><br>
                    ${wpf_delete_conform_text2} 
                    <a href="javascript:void(0)" class="wpf_task_delete" data-taskid="" data-elemid="${id}" style="color:red;">
                        ${wpf_yes}
                    </a>
                </p>`;
            jQuery_WPF(`#wpf_delete_container_${id}`).html(deleteButtonHtml);

            jQuery_WPF('#comment-'+id).val('');
            // empty Task center rich text editor by Pratap
            jQuery_WPF('textarea#comment-'+id).closest('.form-group').find('.ql-editor').html('');
            jQuery_WPF('#task_comments_'+id).animate({scrollTop: jQuery_WPF('#task_comments_'+id).prop("scrollHeight")}, 2000);
            jQuery_WPF('.' + temp_class).closest('.popover').find('.mark_as_complete_lable, .wpf_mark_note').removeClass('wpf_newtask');
            jQuery_WPF('.' + temp_class).closest('.wpf_wizard_modal').find('.mark_as_complete_lable, .wpf_mark_note').removeClass('wpf_newtask');
            comment_count++;
            bubble_comment_count++;
            unsaved_task = false;
            reset_file_upload_field();
        },
        success : function(data){
            let responseData = null;
            try {
                responseData = JSON.parse(data);
            } catch (ex) {}
            if ( responseData['ID'] != 0 ) {
                tasks_on_page[id] = responseData['ID'];
                jQuery_WPF('#wpfbsysinfo_task_id-' + id).html(tasks_on_page[id]);
                jQuery_WPF('#wpf_delete_container_' + id + ' .wpf_task_delete').attr('data-taskid', tasks_on_page[id]);
                new_task_screenshot(id, base64URL);
                // hide the red overlay border when task is created
                if ( old_rendered_box_el !== null ) {
                    old_rendered_box_el.hide();
                }
                if( task_on_page == false ) {
                    task_on_page = true;
                    jQuery_WPF('.wpf_add_page').trigger('click');
                }
                const commentId = responseData['id'];
                update_comment_attributes(temp_class, commentId);
            }
        }
    });
}
// Code to generate new comment.
function generate_comment(id, note) {
    // Create an empty object for the new task
    var new_task = {};

    // Get task priority and status from the form
    var task_priority = jQuery_WPF('input[name=wpfbpriority' + id + ']:checked').val();
    var task_status = jQuery_WPF('input[name=wpfbtaskstatus' + id + ']:checked').val();

    // Get the raw comment text and clean it
    var raw_comment = jQuery_WPF('textarea#comment-' + id).val();
    var task_comment = raw_comment.replace(/(<p><br><\/p>)+$/, '');
    var temp_task_text = task_comment;

    // Collect the list of users to notify
    var task_notify_users = [];
    jQuery_WPF.each(jQuery_WPF('input[name=author_list_' + id + ']:checked'), function() {
        task_notify_users.push(jQuery_WPF(this).val());
    });
    task_notify_users = task_notify_users.join(",");

    // Set up new task data
    new_task['task_id'] = tasks_on_page[id];
    new_task['task_comment_message'] = task_comment;
    new_task['comment_content'] = task_comment;
    new_task['is_note'] = note;

    // Process comment content to detect and handle URLs
    const strippedString = task_comment.replace(/(<([^>]+)>)/gi, "");
    if (wpf_is_valid_url(strippedString) === true) {
        if (is_video_Url(strippedString)) {
            temp_task_text = wpf_is_valid_video_url(strippedString);
        } else {
            temp_task_text = URLify(strippedString);
        }
    }

    // Prepare form data for AJAX request
    var wpf_upload_form = new FormData();
    wpf_upload_form.append('action', 'wpfb_add_comment');
    wpf_upload_form.append('wpf_nonce', wpf_nonce);
    wpf_upload_form.append('task_id', tasks_on_page[id]);
    wpf_upload_form.append('comment_content', task_comment);
    wpf_upload_form.append('is_note', note);
    if (allFiles.length > 0) {
        allFiles.forEach(function(file) {
            wpf_upload_form.append('wpf_upload_file[]', file);
        });
    } else {
        wpf_upload_form.append("wpf_upload_file[]", '');
    }

    // Generate a temporary class name
    var temp_id = Math.floor(100000 + Math.random() * 900000);
    var temp_class = 'temp_class_' + temp_id;

    // Send the AJAX request to add the comment
    jQuery_WPF.ajax({
        method: "POST",
        url: ajaxurl,
        data: wpf_upload_form,
        contentType: false,
        processData: false,
        beforeSend: function() {
            // Hide any previous error messages
            jQuery_WPF('#wpf_error_' + id).hide();

            // Placeholder comment data until server response
            var comment_data = [{'id': 0}];

            // Determine HTML for edit/delete buttons based on permissions
            let edit_delete_button_html = getEditDeleteButtonHTML(comment_data['id']);

            // Set class based on whether the comment is a note
            var $class = "wpf_author";
            var note_html = '';
            if (note === true) {
                $class = "wpf_author is_note";
                note_html = '<small class="wpf_note_html">Note</small>';
            }

            // Create author HTML based on user's image or initials
            var author_html = '';
            if (logged_user.author_img === '' || logged_user.author_img === 'undefined') {
                if (logged_user.author !== '') {
                    author_html = logged_user.author.slice(0, 2);
                } else {
                    author_html = current_user_name.slice(0, 2);
                }
            } else {
                author_html = '<img src="' + logged_user.author_img + '" alt="author"></img>';
            }

            // Get HTML for any attached files
            var files_html = get_files_html(temp_files);

            // getcomment HTML
            var comment_html = createCommentHtml({
                className: $class,
                tempClass: temp_class,
                authorHtml: author_html,
                currentUserName: current_user_name,
                noteHtml: note_html,
                wpfJustNow: wpf_just_now,
                tempTaskText: temp_task_text,
                editDeleteButtonHtml: edit_delete_button_html,
                filesHtml: files_html,
                commentDataId: comment_data['id'],
                editCommentText: edit_comment_text,
                cancelEditCommentText: cancel_edit_comment_text
            });

            // Append the new comment HTML to the comments list
            var $commentElement = jQuery_WPF(comment_html);
            jQuery_WPF('#task_comments_' + id).append($commentElement);

            // Clear the original textarea and reset file uploads
            jQuery_WPF('textarea#comment-' + id).val('');
            jQuery_WPF('textarea#comment-' + id).closest('.form-group').find('.ql-editor').html('');
            jQuery_WPF('#task_comments_' + id).animate({ scrollTop: jQuery_WPF('#task_comments_' + id).prop("scrollHeight") }, 2000);

            // Update task status if marked complete
            if (task_status === 'complete') {
                let bubble_label = '';

                if (wpf_tab_permission.display_stickers === 'yes') {
                    bubble_label = ' <span class="' + task_priority + '_custom"></span>';
                }
                jQuery_WPF('#bubble-' + id).html(id + bubble_label);
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number").html(id + bubble_label);
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "']").removeClass('complete').removeClass('open').removeClass('pending-review').removeClass('in-progress');
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "']").addClass(task_status);
            }

            // Reset file upload field
            reset_file_upload_field();
        },
        success: function(data) {
            let responseData = null;
            try {
                responseData = JSON.parse(data);
            } catch (ex) {}

            const comment_data = responseData['data'];
            const commentId = comment_data['id'];
            update_comment_attributes(temp_class, commentId)
        }
    });
}
// create edit_delete_button_html
function getEditDeleteButtonHTML(commentId) {

    if(logged_user.author === '' || logged_user.author === 'undefined') {
        return '';
    }
    // Determine HTML for edit/delete buttons based on permissions
    const isEditBlocked = jQuery_WPF.inArray('edit', blocked) >= 0;
    const editAction = isEditBlocked ? 'edit_delete_plan()' : `wpf_edit_box_active('${commentId}')`;
    const deleteAction = isEditBlocked ? 'edit_delete_plan()' : `wpf_delete_comment('${commentId}')`;
    const isActiveClass = isEditBlocked ? '' : 'is_active';

    return `
        <div class="wpf-edit-delete-wrapper">
            <a href="javascript:void(0)" onclick="${editAction}" class="wpf_edit_box_active ${isActiveClass}" id="wpf_edit_box_active">${edit_comment_icon}</a>
            <a href="javascript:void(0)" onclick="${deleteAction}" class="wpf_comment_delete_btn ${isActiveClass}">${delete_comment_icon}</a>
        </div>`;
}

// Construct the comment HTML
function createCommentHtml({className, tempClass, authorHtml, currentUserName, noteHtml, wpfJustNow, tempTaskText, editDeleteButtonHtml, filesHtml, commentDataId, editCommentText, cancelEditCommentText}) {
    return `
        <li class="${className} ${tempClass} temp_comment_class">
            <div class="wpf-comment-container">
                <div class="wpf-author-img">${authorHtml}</div>
                <div class="wpf-comment-wrapper">
                    <level class="task-author">
                        <div class="author-name">${currentUserName} ${noteHtml}</div>
                        <span>${wpfJustNow}</span>
                    </level>
                    <div class="meassage_area_main">
                        <div class="chat_text" id="wpf-chat-text-${commentDataId}">${tempTaskText}</div>
                        ${editDeleteButtonHtml}
                    </div>
                    ${filesHtml}
                    <div id="wpfb-edit-comment-wrapper-${commentDataId}" class="wpfb-edit-comment-wrapper">
                        <div class="wpf-editor"></div>
                        <textarea class="form-control wpfb-edit-comment" data-comment_id="${commentDataId}" placeholder="Edit the comment..." spellcheck="false">${tempTaskText}</textarea>
                        <button class="wpf_edit_comment_btn" onclick="wpfb_edit_comment(${commentDataId})">${editCommentText}</button>
                        <a class="wpf-cancel-edit-comment" onclick="wpfb_cancel_edit_comment(${commentDataId})" href="javascript:void(0)">${cancelEditCommentText}</a>
                        <div class="wpf_update_error wpf_hide">Please post your comment before performing this action</div>
                    </div>
                </div>
            </div>
        </li>`;
}
// Update attributes and IDs for the newly added comment
function update_comment_attributes(temp_class, commentId) {
    jQuery_WPF('.' + temp_class).find('.wpf_edit_box_active.is_active').attr('onclick', 'wpf_edit_box_active(\'' + commentId + '\')');
    jQuery_WPF('.' + temp_class).find('.wpf_comment_delete_btn.is_active').attr('onclick', 'wpf_delete_comment(\'' + commentId + '\')');
    jQuery_WPF('.' + temp_class).find('.chat_text').attr('id', 'wpf-chat-text-' + commentId);
    jQuery_WPF('.' + temp_class).find('.wpfb-edit-comment-wrapper').attr('id', 'wpfb-edit-comment-wrapper-' + commentId);
    jQuery_WPF('.' + temp_class).find('.wpfb-edit-comment').attr('data-comment_id', commentId);
    jQuery_WPF('.' + temp_class).find('.wpf_edit_comment_btn').attr('onclick', 'wpfb_edit_comment(\'' + commentId + '\')');
    jQuery_WPF('.' + temp_class).find('.wpf-cancel-edit-comment').attr('onclick', 'wpfb_cancel_edit_comment(\'' + commentId + '\')');
    jQuery_WPF('.' + temp_class).removeClass('temp_comment_class');
    jQuery_WPF('.' + temp_class).attr('data-comment_id', commentId);

    // Initialize the Quill editor for the newly added comment
    initializeQuillForComment(commentId);
}
// Function to initialize Quill editor for a specific comment
function initializeQuillForComment(comment_id) {
    var editor = jQuery_WPF('#wpfb-edit-comment-wrapper-' + comment_id).find('.wpf-editor');

    if (!jQuery_WPF(editor).hasClass('activee')) {
        jQuery_WPF(editor).addClass('activee');

        try {
            var quill = new Quill(editor[0], {
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['link', 'code-block'],
                    ]
                },
                placeholder: '',
                theme: 'bubble'
            });
            editor.data('quill', quill);

            // Update the textarea with Quill editor content on change
            quill.on('text-change', function(delta, oldDelta, source) {
                var isempty = isQuillEmpty(quill);
                var textarea = jQuery_WPF('#wpfb-edit-comment-wrapper-' + comment_id).find('textarea');
                textarea.val(isempty ? '' : quill.root.innerHTML);
            });

            // Handle Enter key press in the editor
            editor.on('keydown', function(event) {
                if ((event.keyCode === 13 || event.key === "Enter") && !event.shiftKey) {
                    // Add logic to handle Enter key if needed
                }
            });

            // Focus on the editor after initialization
            setTimeout(() => {
                quill.focus();
            }, 100);
        } catch (error) {
            console.error('Error initializing Quill editor for comment ID:', comment_id, error);
        }
    }
}
// Mark task as internal;
function mark_internal(id,internal){
    var task_info = [];
    var task_notify_users = [];
    var task_comment = jQuery_WPF('#comment-'+id).val();
    jQuery_WPF.each(jQuery_WPF('input[name=author_list_'+id+']:checked'), function(){
        task_notify_users.push(jQuery_WPF(this).val());
    });
    task_info['task_id'] = tasks_on_page[id];
    task_info['internal'] = internal;
    var task_info_obj = jQuery_WPF.extend({}, task_info);
    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {
            action: "wpfb_mark_as_internal",
            wpf_nonce:wpf_nonce,
            task_info:task_info_obj
        },
        beforeSend: function(){
            let tagged_area_container = jQuery_WPF(".wpf_sidebar_content #wpf_thispage [data-taskid="+ id +"]");
            if(internal == '1') {
                jQuery_WPF('#wpf_mark_internal_'+id).addClass('wpf_is_internal').removeClass('mark_internal_tooltip').addClass('unmark_internal_tooltip');
                jQuery_WPF('#bubble-'+id).addClass('wpfb-internal');
                jQuery_WPF('#bubble-'+id).append(internal_icon_html);
                jQuery('#wpf_mark_internal_'+id).find('.wpf-internal-img').attr('src', plugin_url + 'images/eye-off-white.svg');

                // hide the notifu users block
                const notify_user_block = jQuery_WPF('#wpf_mark_internal_'+id).parents('.popover-body').find('#wpfbuser-'+id);
                jQuery_WPF(notify_user_block).find('ul').hide();
                jQuery_WPF(notify_user_block).find('ul').before('<span class="wpf_hide_users_for_internal_tasks" id="wpf_success_wpf_share_page_link">Notifications for internal tasks are handled through your Atarim Dashboard</span>');

                // show the tag in the sidebar
                jQuery_WPF(tagged_area_container).find(".wpf_task_meta .wpf_task_tagg").append('<span class="wpf_task_type wpf_type_internal" title="Task type">Internal</span>');
                jQuery_WPF(tagged_area_container).find('.wpf_task_number').append(internal_icon_html);
                jQuery_WPF(tagged_area_container).find('.wpf_task_number .wpf_bubble_num_wrapper').addClass('marked_internal');
            } else {
                jQuery_WPF('#wpf_mark_internal_'+id).removeClass('wpf_is_internal').removeClass('unmark_internal_tooltip').addClass('mark_internal_tooltip');
                jQuery_WPF('#bubble-'+id).removeClass('wpfb-internal');
                jQuery_WPF('#bubble-'+id).find('.wpf_chevron_wrapper').remove();
                jQuery('#wpf_mark_internal_'+id).find('.wpf-internal-img').attr('src', plugin_url + 'images/eye-off.svg');

                // diplay the notifu users block
                const notify_user_block = jQuery_WPF('#wpf_mark_internal_'+id).parents('.popover-body').find('#wpfbuser-'+id);
                jQuery_WPF(notify_user_block).find('span').remove();
                jQuery_WPF(notify_user_block).find('ul').show();

                // remove the tag from the sidebar
                jQuery_WPF(tagged_area_container).find(".wpf_task_meta .wpf_task_tagg .wpf_type_internal").remove();
                jQuery_WPF(tagged_area_container).find('.wpf_task_number .wpf_internal_task_wrapper').remove();
                jQuery_WPF(tagged_area_container).find('.wpf_task_number .wpf_bubble_num_wrapper').removeClass('marked_internal');
            }          
        },
        success : function(data){
            const jsonData = JSON.parse(data);
        }
    });
}
// Code to generate sidebar html.
function generate_wpfb_task_html(wpfb_task_id,wpfb_metas){
    var notify_users = '';
    if(wpfb_metas.task_notify_users !== '' && wpfb_metas.task_notify_users  !== null && wpfb_metas.task_notify_users !== undefined){
        notify_users =  wpfb_metas.task_notify_users.split(',');
    }
    var user_html = '';
    var user_avatar = wpfb_metas.task_auth_img;
    if( user_avatar != 'undefined' && user_avatar != null ) {
        if( Object.keys(user_avatar).length > 0 ) {
            jQuery_WPF.each( user_avatar, function (index, value) {
                if( value.img != '' && value.img != null ) {
                    user_html += '<span class="wpf_user_avat"><img src="' + value.img + '" alt="author" ></span>';
                } else if( value.displayname != '' && value.displayname != null ) {
                    user_html += '<span class="wpf_user_avat">' + value.displayname.slice(0, 2) + '</span>';
                }
            });
        }
    }
    
    var wpfb_users_arr = JSON.parse(wpfb_users);
    var comment_count = wpfb_metas.wpf_task_id;
    let sticker_span = '';
    let custom_status_class = '';
    let sidebar_class = "";
    if(wpfb_metas.class !== ""){
        //sidebar_class = "_"+wpfb_metas.class;
        sidebar_class = "_today";
    }
    if(wpf_tab_permission.display_stickers == 'yes'){
        custom_status_class = wpfb_metas.task_status+'_custom';
    }
    
    if(wpf_tab_permission.display_stickers == 'yes'){
        sticker_span = '<span class="sticker '+wpfb_metas.task_priority+'_custom"></span> ';
    }
    let display_check_mark = '';
    if(wpf_tab_permission.display_task_id != 'yes'){
        display_check_mark = '<i class="gg-check"></i>';
    }else{
        display_check_mark = wpfb_metas.site_task_id;//comment_count;
    }
    var internal_icon = '';
    var internal = '';
    var marked_internal = '';
    if(wpfb_metas.is_internal=='1'){
        internal_icon = internal_icon_html;
        internal = '<span class="wpf_task_type wpf_type_internal" title="Task type">Internal</span>';
        marked_internal = 'marked_internal';
        display_check_mark = '';
    }
    if(wpfb_metas.task_status=='complete'){
        var bubble_label = sticker_span+display_check_mark;
    } else {
        var bubble_label = sticker_span+'<span class="wpf_bubble_num_wrapper ' +marked_internal + '">' + wpfb_metas.site_task_id + '</span>';
    }
    
    
    var all_wpfb_metas = wpfb_metas.wpf_tags;
    var all_other_tag = '';
    var wpfb_tags_html = '';
    if(all_wpfb_metas){
        var tag_length = all_wpfb_metas.length;
        const all_tag = Object.keys(all_wpfb_metas);
        var i = 1;
        jQuery_WPF.each(all_tag,function (index, value) {
            if(i == 1){
                wpfb_tags_html +=  '<span class="wpf_task_tag">' + all_wpfb_metas[value]["name"]+'</span>';
            } else {
                if(tag_length == i){
                    all_other_tag +=  all_wpfb_metas[value]["name"];
                }else{
                    all_other_tag +=  all_wpfb_metas[value]["name"]+', ';
                }
            }
            i++;
        });
        if(all_wpfb_metas.length > 1){
            wpfb_tags_html += '<span class="wpf_task_tag_more" title="'+all_other_tag+'">...</span>';
        }
    }
    if(wpf_tab_permission.display_stickers == 'yes'){
        var wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+wpfb_metas.task_status+' wpf_'+wpfb_metas.task_status+'_custom" title="Status: '+wpfb_metas.task_status+'">'+status_icon+'</span>';
        var wpf_task_priority_label= '<span class="priority wpf_'+wpfb_metas.task_priority+' wpf_'+wpfb_metas.task_priority+'_custom" title="Priority: '+wpfb_metas.task_priority+'">'+priority_icon+'</span></div>';
    }else{
        var wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+wpfb_metas.task_status+'" title="Status: '+wpfb_metas.task_status+'">'+status_icon+'</span>';
        var wpf_task_priority_label= '<span class="priority wpf_'+wpfb_metas.task_priority+'" title="Priority: '+wpfb_metas.task_priority+'">'+priority_icon+'</span></div>';
    }
    if(wpfb_metas.task_type=='general' || wpfb_metas.task_type=='email'){
        const tag = (wpfb_metas.task_type=='general') ? '<span class="wpf_task_type" title="Task type">'+ wpf_general_tag +'</span>' : '<span class="wpf_task_type" title="Task type">'+ wpf_email_tag +'</span>'; //! email
        if(wpf_tab_permission.display_stickers == 'yes'){
            var wpfb_current_page_task_list_html = '<li class="current_page_general_task '+wpfb_metas.task_status+' '+custom_status_class+' '+ wpfb_metas.task_priority+'" data-taskid="'+comment_count+'" data-postid="'+wpfb_task_id+'"><div class="wpf_task_info"><div class="wpf_task_number '+wpfb_metas.task_status+'_custom" title="' + wpf_remap_text + '" data-disp-id="'+wpfb_metas.site_task_id+'">'+bubble_label+internal_icon+'</div><div class="wpf_task_sum"><level class="task-author">'+wpfb_metas.task_config_author_name+'<span>'+wpfb_metas.task_time+'</span></level><div class="current_page_task_list">'+wpfb_metas.task_title+'</div></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+internal + tag + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';
        } else {
            var wpfb_current_page_task_list_html = '<li class="current_page_general_task '+wpfb_metas.task_status+' '+custom_status_class+' '+ wpfb_metas.task_priority+'" data-taskid="'+comment_count+'" data-postid="'+wpfb_task_id+'"><div class="wpf_task_info"><div class="wpf_task_number" title="' + wpf_remap_text + '" data-disp-id="'+wpfb_metas.site_task_id+'">'+bubble_label+internal_icon+'</div><div class="wpf_task_sum"><level class="task-author">'+wpfb_metas.task_config_author_name+'<span>'+wpfb_metas.task_time+'</span></level><div class="current_page_task_list">'+wpfb_metas.task_title+'</div></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+internal + tag + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';
        }
        jQuery_WPF("#wpf_thispage_container"+sidebar_class).append(wpfb_current_page_task_list_html);
    } else {
        var wpfb_users_html = get_user_list(wpfb_users_arr, comment_count, notify_users);
        var temp_task_priority_low=temp_task_priority_medium=temp_task_priority_high=temp_task_priority_critical='';
        if(wpfb_metas.task_priority=='low'){temp_task_priority_low='checked';}
        else if(wpfb_metas.task_priority=='medium'){temp_task_priority_medium='checked';}
        else if(wpfb_metas.task_priority=='high'){temp_task_priority_high='checked';}
        else{temp_task_priority_critical='checked';}
        if(wpf_tab_permission.display_stickers == 'yes'){
            var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority low_radio" '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'" class="low_label">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority medium_radio" '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'" class="medium_label">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority high_radio" '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'" class="high_label">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority critical_radio" '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'" class="critical_label">'+wpf_priority_critical+'</label>';
        }else{
            var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority " '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'" class="">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority " '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'" class="">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority " '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'" class="">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority " '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'" >'+wpf_priority_critical+'</label>';
        }    
        var temp_task_status_open=temp_task_status_inprogress=temp_task_status_pending_review=temp_task_status_complete='';
        if(wpfb_metas.task_status=='open'){temp_task_status_open='checked';}
        else if(wpfb_metas.task_status=='in-progress'){temp_task_status_inprogress='checked';}
        else if(wpfb_metas.task_status=='pending-review'){temp_task_status_pending_review='checked';}
        else{temp_task_status_complete='checked';}
        if(wpf_tab_permission.display_stickers == 'yes'){
            var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus open_radio" '+temp_task_status_open+'><label for="status_open-'+comment_count+'" class="open_label">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus in_progress_radio" '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'" class="in_progress_label">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus pending_radio" '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'" class="pending_label">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus complete_radio" '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'" class="complete_label">'+wpf_status_complete+'</label>';
        } else {
            var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus " '+temp_task_status_open+'><label for="status_open-'+comment_count+'" class="">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus " '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'" class="">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus " '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'" class="">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus " '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'" class="">'+wpf_status_complete+'</label>';
        }
        var wpfb_messages_html='';
    
        for (var key in wpfb_metas.comments) {
            let new_class = "";
            let author = "";
            author =  wpfb_metas.comments[key].author;
            if(wpfb_metas.comments[key].is_log == 1){
                    new_class = " is_info";
                    author = "";
            }   
            
            if ( typeof wpfb_metas.comments[key].response !== 'undefined' ) {
                if ( wpfb_metas.comments[key].response.delivery_status === 'incoming' ) {
                    var task_author = "wpf_other "+new_class;
                } else {
                    var task_author = "wpf_author "+new_class;
                }
            } else {
                if(wpfb_metas.comments[key].wpf_user_id==wpfb_metas.current_user_id){
                    var task_author = "wpf_author "+new_class;
                }
                else{
                    var task_author = "wpf_other "+new_class;
                }
            }
            var edited_html='';
            if(wpfb_metas.comments[key].is_edited && !wpfb_metas.comments[key].is_deleted){
                edited_html='<span class="wpf-is-edited">(edited)<span class="wpf_tooltiptext edit_tooltip_text">'+wpfb_metas.comments[key].updated_at+'</span></span>';
            }else{
                edited_html='';
            }
            let edit_delete_button_html = '';
            if ( ( eval(current_user_id) === eval(wpfb_metas.comments[key]['wpf_user_id']) ) && (!wpfb_metas.comments[key]['is_log']) && (!wpfb_metas.comments[key].is_deleted) ) {
                // Determine HTML for edit/delete buttons based on permissions
                edit_delete_button_html = getEditDeleteButtonHTML(key);
            }
            
            if( wpfb_metas.comments[key].comment_type == 0 ) {
                let  img_dwn_icon = "";
                wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+key+'"><level class="task-author">'+author+'<span>'+wpfb_metas.comments[key].time+'</span>'+edited_html+'</level><div class="meassage_area_main"><div id="wpf-chat-text-'+key+'" class="chat_text">'+ wpfb_metas.comments[key].message +'</div>'+edit_delete_button_html+'</div><div id="wpfb-edit-comment-wrapper-'+key+'" class="wpfb-edit-comment-wrapper"><div class="wpf-editor"></div><textarea class="form-control wpfb-edit-comment" data-comment_id="'+key+'" placeholder="Edit the comment..." spellcheck="false">'+URLify(wpfb_metas.comments[key].message)+'</textarea><button class="wpf_edit_comment_btn" onclick="wpfb_edit_comment(\''+key+'\')">'+edit_comment_text+'</button><a class="wpf-cancel-edit-comment" onclick="wpfb_cancel_edit_comment(\''+key+'\')" href="javascript:void(0)">'+cancel_edit_comment_text+'</a><div class="wpf_update_error wpf_hide">Please post your comment before performing this action</div></div></li>';
            }
            else if ( wpfb_metas.comments[key].comment_type == 3 ) {
                let img_dwn_icon = "";
                wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+key+'"><level class="task-author">'+author+'<span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<iframe width="100%" height="150" src="https://www.youtube.com/embed/'+wpfb_metas.comments[key].message+'"></iframe></div><div id="wpfb-edit-comment-wrapper-'+key+'" class="wpfb-edit-comment-wrapper"><div class="wpf-editor"></div><textarea class="form-control wpfb-edit-comment" data-comment_id="'+key+'" placeholder="Edit the comment..." spellcheck="false">'+wpfb_metas.comments[key].message+'</textarea><button class="wpf_edit_comment_btn" onclick="wpfb_edit_comment(\''+key+'\')">'+edit_comment_text+'</button><a class="wpf-cancel-edit-comment" onclick="wpfb_cancel_edit_comment(\''+key+'\')" href="javascript:void(0)">'+cancel_edit_comment_text+'</a><div class="wpf_update_error wpf_hide">Please post your comment before performing this action</div></div></li>';
            }
            else if ( wpfb_metas.comments[key].comment_type == 1 ) {
                wpfb_messages_html += '<li class="'+task_author+' is_image" data-comment_id="'+key+'"><level class="task-author">'+author+'<span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main"><a href="'+wpfb_metas.comments[key].message+'" target="_blank">'+'</a>'+img_dwn_icon+'<img src="'+wpfb_metas.comments[key].message+'" class="wpf_task_uploaded_image"  alt="upload image" /></div></li>';
            } else{
                var wpf_download_file  = wpfb_metas.comments[key].message.split("/").pop();
                let img_dwn_icon = "";
                wpfb_messages_html += '<li class="'+task_author+' is_file" data-comment_id="'+key+'"><level class="task-author">'+author+'<span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<a href="'+wpfb_metas.comments[key].message+'" download="'+wpf_download_file+'" target="_blank"><i class="gg-software-download"></i> '+ wpf_download_file+'</a></div></li>';
            }
            jQuery_WPF('#task_comments_'+comment_count).append(wpfb_messages_html);
        }
        if(wpfb_metas.task_page_title == null){
            wpfb_metas.task_page_title = "";
        }
    
        var is_new_start = "";
        for (var key in wpfb_users_arr) {
            if (wpfb_users_arr.hasOwnProperty(key)) {
                if(wpfb_users_arr[key]['username']==wpfb_metas.task_config_author_name){
                    wpfb_metas.task_config_author_name = wpfb_users_arr[key]['displayname'];
                    break;
                }
            }
        }
        var wpfb_current_page_task_list_html = '';
        /**
         * Need to add note on orphant task (tasks that had assigned on element before but that element is now
         * deleted or moved or changed)
         */
        const note = 'We could not find the original location of this task. You can remap it by clicking the task number';
        let search_buble;
        try {
        if(jQuery_WPF(document).find(wpfb_metas.wpfb_task_bubble).length === 0){
            let search_bubble_str=wpfb_metas.wpfb_task_bubble;
            let search_bubble_cutout_1=search_bubble_str ? search_bubble_str.substr(0,search_bubble_str.indexOf('>')) : '';
            let search_bubble_cutout_2=search_bubble_str ? search_bubble_str.substr(search_bubble_str.indexOf('>')+1) : '';
            let search_bubble_cutout_3=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(search_bubble_cutout_2.indexOf('>')+1) : '';
            
    
            let search_bubble_mid_element=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(0,search_bubble_cutout_2.indexOf('>')) : '';
            if(search_bubble_mid_element.indexOf("div:eq")>-1){
                let div_index=parseInt(search_bubble_mid_element.match(/(\d+)/)[0])+1;
                search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > div:eq("+div_index+") > "+search_bubble_cutout_3 : '';
            }else{
                search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > "+search_bubble_mid_element+" > "+search_bubble_cutout_3 : '';
            }
        }else{
            search_buble=wpfb_metas.wpfb_task_bubble;
        }
        } catch(ex1){}
        if ( (wpfb_metas.task_type === 'element') && (jQuery_WPF(document).find(search_buble).length === 0) ) {
            wpfb_current_page_task_list_html = '<li class="current_page_task ' + wpfb_metas.task_status + ' ' + custom_status_class + ' ' + wpfb_metas.task_priority + '" data-taskid="' + comment_count + '" data-postid="' + wpfb_task_id + '"><div class="wpf_task_info"><div data-disp-id="' + wpfb_metas.site_task_id + '" class="wpf_task_number" title="' + wpf_remap_text + '">' + bubble_label +internal_icon + '</div><div class="wpf_task_sum"><level class="task-author">' + wpfb_metas.task_config_author_name + '<span class="note-tooltip" data-note-tooltip="'+ note +'">!</span><span>' + wpfb_metas.task_time + '</span></level><div class="current_page_task_list">' + wpfb_metas.task_title + '</div><p class="note_task_become_general"></p></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+ internal + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';   
        } else {
            wpfb_current_page_task_list_html = '<li class="current_page_task ' + wpfb_metas.task_status + ' ' + custom_status_class + ' ' + wpfb_metas.task_priority + '" data-taskid="' + comment_count + '" data-postid="' + wpfb_task_id + '"><div class="wpf_task_info"><div data-disp-id="' + wpfb_metas.site_task_id + '" class="wpf_task_number" title="' + wpf_remap_text + '">' + bubble_label + internal_icon + '</div><div class="wpf_task_sum"><level class="task-author">' + wpfb_metas.task_config_author_name + '<span>' + wpfb_metas.task_time + '</span></level><div class="current_page_task_list">' + wpfb_metas.task_title + '</div></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+ internal + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';
        }
        jQuery_WPF("#wpf_thispage_container"+sidebar_class).append(wpfb_current_page_task_list_html);
        response_html_new = wpf_task_popover_html(0,comment_count,wpfb_task_id,wpfb_metas,wpfb_users_html,wpfb_task_priority_html,wpfb_task_status_html,wpfb_messages_html);
        jQuery_WPF('#wpf_launcher').after(response_html_new);
        wpf_bubble_tracker(comment_count,wpfb_metas.task_clean_dom_elem_path);
        init_custom_popover_first(comment_count);
    }
}
function load_wpfb_tasks(){
    if(atarim_server_down=='true'){
        return;
    }
    jQuery_WPF.ajax({
        method:"POST",
        url: ajaxurl,
        data: {
            action: 'load_wpfb_tasks',
            wpf_nonce: wpf_nonce,
            current_page_url: current_page_url,
            fallback_link_check: fallback_link_check,
            current_page_id: current_page_id,
            wpf_current_screen: wpf_current_screen,
            page_type: page_type,
            wpside: logged_user.wpside
        },
        success: function(data){
            var uncompleted_task;
            jQuery_WPF('.wpf_page_loader').hide();
            wpf_tasks_loaded = true;
            jQuery_WPF('body #wpf_launcher').addClass("wpf_launcher_loaded");
            onload_wpfb_tasks = JSON.parse(data);
            if(onload_wpfb_tasks !== '' && onload_wpfb_tasks !== null && onload_wpfb_tasks !== undefined){

                // load tags.
                if ( onload_wpfb_tasks['wpf_all_tags'] ) {
                    wpf_all_tags = onload_wpfb_tasks['wpf_all_tags'];
                    delete onload_wpfb_tasks.wpf_all_tags;
                }

                const k = Object.keys(onload_wpfb_tasks).sort(timeSort);
                comment_count_initial = Object.keys(onload_wpfb_tasks).length;

                /* load milestone */
                if ( onload_wpfb_tasks['milestone'] ) {
                    const milestone = onload_wpfb_tasks['milestone'];
                    const html      = `${milestone_clock_icon}
                        <div class="wpf_milestone_content">
                            <div class="wpf_countdown_title">${milestone['title']}</div>
                            <div class="wpf_countdown_timer" id="wpf_countdown_timer">${milestone['countdown_text']}</div>
                        </div>`;
                    jQuery_WPF('#wpf_site_milestone').html(html);

                    // start the milestone countdown
                    start_milestone_timer( milestone );
                }

                /* loading sidebar tasks */
                if ( k.length > 0 ) {
                    jQuery_WPF.each(k,function (index, value) {
                        if(onload_wpfb_tasks[value].is_internal=='1'){
                            if(wpf_current_role!='advisor'){
                                return;
                            }
                        }
                        tasks_on_page[onload_wpfb_tasks[value].wpf_task_id]=value;
                        if(onload_wpfb_tasks[value].task_status == "open"){
                            open_per = open_per+1;
                        }

                        if(onload_wpfb_tasks[value].task_status == "in-progress"){
                            in_progress_per = in_progress_per+1;
                        }

                        if(onload_wpfb_tasks[value].task_status == "pending-review"){
                            pending_review_per = pending_review_per+1;
                        }

                        if(onload_wpfb_tasks[value].task_status == "complete"){
                            complete_per = complete_per+1;
                        }

                        total_task = total_task+1;
                        generate_wpfb_task_html(value,onload_wpfb_tasks[value]);

                        jQuery_WPF( function() {
                            jQuery_WPF( "#bubble-"+onload_wpfb_tasks[value].wpf_task_id).draggable({ containment: "document" });
                        });

                        comment_count_initial--;
                    });
                
                    /* end of loading sidebar tasks */
                    var total_count = open_per+in_progress_per+pending_review_per;
                    jQuery_WPF('.wpf_total_task_number').text(total_count).css('display', 'flex');
                    if(open_per > 0){
                        open_per = (open_per*100)/total_task;
                    }

                    if(in_progress_per > 0){
                        in_progress_per = (in_progress_per*100)/total_task;
                    }

                    if(pending_review_per > 0){
                        pending_review_per = (pending_review_per*100)/total_task;
                    }

                    if(complete_per > 0){
                        complete_per = (complete_per*100)/total_task;
                    }

                    uncompleted_task = (((open_per/100)*total_task) + ((in_progress_per/100) *total_task) + ((pending_review_per/100)*total_task));

                    jQuery_WPF('.wpf_progress_bar #open_progress').css("width", parseFloat(open_per).toFixed(2)+'%');
                    jQuery_WPF('.wpf_progress_bar #inprogress_progress').css('width',parseFloat(in_progress_per).toFixed(2)+'%');
                    jQuery_WPF('.wpf_progress_bar #pending_progress').css('width',parseFloat(pending_review_per).toFixed(2)+'%');
                    jQuery_WPF('.wpf_progress_bar #completed_progress').css('width',parseFloat(complete_per).toFixed(2)+'%');
                    task_on_page = true;
                } else {
                    jQuery_WPF('.wpf_total_task_number').text('0');
                    jQuery_WPF('.wpf_no_task').removeClass('wpf_hide');
                    task_on_page = false;
                }
                if ( ! comment_mode() ) {
                    jQuery_WPF('.wpf_bottom_middle .wpf_bc_switch_slider').addClass('active_browse');
                    disable_comment();
                }
            }
            jQuery_WPF(document).on("click", ".close" , function(e){
                jQuery_WPF(this).parents(".popover").popover('hide');
            });

            let bubble_click=0;

            jQuery_WPF(document).on("click", ".wpfb-point" , function(e, type){

                current_bubble = jQuery_WPF(this).prop('id').split('bubble-')[1];
                setup_upload_file(current_bubble);

                if(bubble_click==1){
                    return;
                }

                if ( jQuery_WPF(this).data('comments-available') ) {
                    load_popover_content(this);
                    bubble_click=1;
                }
            });
            
            jQuery_WPF(document).find("#wpf_thispage").on("click","li.current_page_task",function(e) {
                jQuery_WPF('#wpf_thispage li.current_page_task').removeClass('wpf_active');
                jQuery_WPF('#wpf_thispage li.current_page_general_task').removeClass('wpf_active');
                jQuery_WPF(this).addClass('wpf_active');

                let search_buble;
                let check_undefined=0;
                var data_postid = jQuery_WPF(this).closest('li').data('postid');
                var taskid = jQuery_WPF(this).data('taskid');
                if(wpf_admin_bar==1){
                    let search_bubble_str;
                    if(typeof onload_wpfb_tasks[data_postid] !== 'undefined'){
                        search_bubble_str=onload_wpfb_tasks[data_postid].wpfb_task_bubble;
                    }else{
                        search_bubble_str='';
                        check_undefined=1;
                    }

                    let search_bubble_cutout_1=search_bubble_str ? search_bubble_str.substr(0,search_bubble_str.indexOf('>')) : '';
                    let search_bubble_cutout_2=search_bubble_str ? search_bubble_str.substr(search_bubble_str.indexOf('>')+1) : '';
                    let search_bubble_cutout_3=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(search_bubble_cutout_2.indexOf('>')+1) : '';
                    let search_bubble_mid_element=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(0,search_bubble_cutout_2.indexOf('>')) : '';

                    if(search_bubble_mid_element.indexOf("div:eq")>-1){
                        let div_index=parseInt(search_bubble_mid_element.match(/(\d+)/)[0])+1;
                        search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > div:eq("+div_index+") > "+search_bubble_cutout_3 : '';
                    }else{
                        search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > "+search_bubble_mid_element+" > "+search_bubble_cutout_3 : '';
                    }
                    }else{
                    if(typeof onload_wpfb_tasks[data_postid] !== 'undefined'){
                        search_buble=onload_wpfb_tasks[data_postid].wpfb_task_bubble;
                    }else{
                        search_buble='';
                        check_undefined=1;
                    }
                }
            
                if(jQuery_WPF(document).find(search_buble).length === 0 && check_undefined==0){
                    wpf_load_general_task(taskid, 1);
                    return;
                }

                jQuery_WPF('[rel="popover-'+taskid+'"]').trigger('click');
                jQuery_WPF('html, body').animate({
                    scrollTop: jQuery_WPF("#bubble-"+taskid).offset().top - 200
                }, 200);
            });
            trigger_bubble_label();
            if ( comment_mode() ) {
                jQuery_WPF('.wpf_bottom_middle .wpf_bc_switch_slider').removeClass('active_browse');
                jQuery_WPF('.wpf_bottombar_section').removeClass('wpf_hide');
                jQuery_WPF('.wpf_launch_comment_mode').addClass('hide_comment_mode');
                enable_comment();
            }
        }
    });
}
function load_wpfb_pages() {
    if ( atarim_server_down == 'true' ) {
        return;
    }
    jQuery_WPF.ajax({
        method:"POST",
        url: ajaxurl,
        data: {
            action: 'load_wpfb_pages',
            wpf_nonce: wpf_nonce,
            wpside: logged_user.wpside
        },
        success: function(data) {
            jQuery_WPF('.wpf_page_list').html(data);
        }
    });
}
function wpf_load_general_task(id) {
    var load_general=1;
    jQuery_WPF.ajax({
        url:ajaxurl,
        method:'POST',
        data: {
            action:'load_wpfb_tasks',
            wpf_nonce: wpf_nonce,
            task_id: id,
            page_type: page_type
        },
        beforeSend: function(){
            jQuery_WPF('.wpf_sidebar_loader').show();
        },
        success: function (data) {
            jQuery_WPF('.wpf_sidebar_loader').hide();
            var task_info = JSON.parse(data);
            var task_id = Object.keys(task_info)[0];
            var task_meta = task_info[task_id];
            wpf_generate_general_task_html(task_id,task_meta,load_general);
            jQuery_WPF('#wpf_general_comment').removeClass('wpf_hide');
            setTimeout(function(){ 
                jQuery_WPF('#comment-'+task_meta.task_comment_id).focus(); 
            }, 100);
            // add rich text editor for Task center by Pratap
            jQuery(document).find('.wpf-tc-editor, .wpf-editor').each(function() {
                if ( ! jQuery_WPF(this).hasClass('activee') ) {
                    var $this = jQuery_WPF(this);
                    jQuery_WPF(this).addClass('activee');
                    var quill = new Quill(this, {
                        modules: {
                            toolbar: [
                                ['bold', 'italic', 'underline', 'strike'],
                                [{ list: 'ordered' }, { list: 'bullet' }],
                                ['link', 'code-block'],
                            ]
                        },
                        placeholder: wpf_comment_box_placeholder,
                        theme: 'bubble'   // Specify theme in configuration
                    });
                    quill.on('text-change', function(delta, oldDelta, source) {
                        if(quill.root.innerText != '\n') {
                            $this.closest('.form-group').find('.wpf_comment_btn, .wpf_mark_note').removeClass('disabled');
                        } else {
                            $this.closest('.form-group').find('.wpf_comment_btn, .wpf_mark_note').addClass('disabled');
                        }
                        var isempty = isQuillEmpty( quill );
                        if ( !isempty ) {
                            $this.closest('.form-group').find('textarea').val(quill.root.innerHTML);
                        } else {
                            $this.closest('.form-group').find('textarea').val('');
                        }
                    });
                    $this.on('keydown', function(event) {
                        // Check if the pressed key is Enter (keyCode 13 or key "Enter")
                        if ( (event.keyCode == 13 || event.key === "Enter") && !event.shiftKey ) {
                            $this.closest('.form-group').find('.wpf_comment_btn.task_comment').trigger('click');
                        }
                    });
                }
            });
        }
    });
}
function wpf_generate_general_task_html(wpfb_task_id,wpfb_metas,load_general=0){

    var notify_users = '';
    if(wpfb_metas.task_notify_users !== '' && wpfb_metas.task_notify_users  !== null && wpfb_metas.task_notify_users !== undefined){
        notify_users =  wpfb_metas.task_notify_users.split(',');
    }

    var wpfb_users_arr = JSON.parse(wpfb_users);
    var comment_count = wpfb_metas.wpf_task_id;

    var wpfb_users_html = get_user_list(wpfb_users_arr, comment_count, notify_users);

    var temp_task_priority_low=temp_task_priority_medium=temp_task_priority_high=temp_task_priority_critical='';
    if(wpfb_metas.task_priority=='low'){temp_task_priority_low='checked';}
    else if(wpfb_metas.task_priority=='medium'){temp_task_priority_medium='checked';}
    else if(wpfb_metas.task_priority=='high'){temp_task_priority_high='checked';}
    else{temp_task_priority_critical='checked';}

    if(wpf_tab_permission.display_stickers == 'yes'){
        var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority low_radio" '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'" class="low_label">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority medium_radio" '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'" class="medium_label">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority high_radio" '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'" class="high_label">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority critical_radio" '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'" class="critical_label">'+wpf_priority_critical+'</label>';
    }else{
        var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority" '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority" '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority" '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority" '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'">'+wpf_priority_critical+'</label>';
    }


    var temp_task_status_open=temp_task_status_inprogress=temp_task_status_pending_review=temp_task_status_complete='';
    if(wpfb_metas.task_status=='open'){temp_task_status_open='checked';}
    else if(wpfb_metas.task_status=='in-progress'){temp_task_status_inprogress='checked';}
    else if(wpfb_metas.task_status=='pending-review'){temp_task_status_pending_review='checked';}
    else{temp_task_status_complete='checked';}

    if(wpf_tab_permission.display_stickers == 'yes'){
        var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus open_radio" '+temp_task_status_open+'><label for="status_open-'+comment_count+'" class="open_label">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus in_progress_radio" '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'" class="in_progress_label">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus pending_radio" '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'" class="pending_label">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus complete_radio" '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'" class="complete_label">'+wpf_status_complete+'</label>';
    }else{
        var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus" '+temp_task_status_open+'><label for="status_open-'+comment_count+'">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus" '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus" '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus" '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'">'+wpf_status_complete+'</label>';
    }
    var wpfb_messages_html='';
    for (var key in wpfb_metas.comments) {
        let new_class = "";
        let author = "";
        let author_img = "";
        let author_html = "";
        for (var usr in wpfb_users_arr) {
            if (wpfb_users_arr.hasOwnProperty(usr)) {
                if(wpfb_users_arr[usr]['username']==wpfb_metas.comments[key].author){
                    wpfb_metas.comments[key].author = wpfb_users_arr[usr]['displayname'];
                    break;
                }
            }
        }
        author = wpfb_metas.comments[key].author;
        author_img = wpfb_metas.comments[key].wpf_user_img;

        if(wpfb_metas.comments[key].is_log == 1){
            new_class = " is_info";
            author = "";
            author_img = plugin_url + 'images/bell.svg';
        }

        if ( author_img == '' || author_img == 'undefined') {
            author_html = author.slice(0, 2);
        } else {
            author_html = '<img src="' + author_img + '" alt="author" ></img>';
        }

        var files = wpfb_metas.comments[key].files;
        var files_html = get_files_html(files);

        var note_class = '';
        var note_html = '';
        if( wpfb_metas.comments[key].is_note == true ){
            note_class = " is_note";
            note_html = '<small class="wpf_note_html">Note</small>';
        }

        if ( typeof wpfb_metas.comments[key].response !== 'undefined' ) {
                if ( wpfb_metas.comments[key].response.delivery_status === 'incoming' ) {
                    var task_author = "wpf_other " + new_class + note_class;
                } else {
                    var task_author = "wpf_author " + new_class + note_class;
                }
        } else {
            if(wpfb_metas.comments[key].wpf_user_id==wpfb_metas.current_user_id){
                var task_author = "wpf_author" + new_class + note_class;
            } else {
                var task_author = "wpf_other" + new_class + note_class;
            }
        }

        var edited_html='';
        let edit_delete_button_html = '';
        var show_comment_id = '';
        if(wpfb_metas.comments[key].is_edited && !wpfb_metas.comments[key].is_deleted){
            edited_html='<span class="wpf-is-edited">(Edited)</span>';            
        }else{
            edited_html='';
        }

        if ( ( eval(current_user_id) === eval(wpfb_metas.comments[key]['wpf_user_id']) ) && (!wpfb_metas.comments[key]['is_log']) && (!wpfb_metas.comments[key].is_deleted) ) {
            // Determine HTML for edit/delete buttons based on permissions
            edit_delete_button_html = getEditDeleteButtonHTML(key);
        }


        if( wpfb_metas.comments[key].comment_type == 0 ) {
            let img_dwn_icon = "";
            if ( wpfb_metas.comments[key].is_note != true || (  wpfb_metas.comments[key].is_note == true && wpfb_metas.comments[key].wpf_user_id == wpfb_metas.current_user_id ) ) {
                wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + note_html + '</div><span>' + edited_html + wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<div id="wpf-chat-text-'+key+'" class="chat_text">'+ wpfb_metas.comments[key].message +'</div>' + files_html + edit_delete_button_html+'</div><div id="wpfb-edit-comment-wrapper-'+key+'" class="wpfb-edit-comment-wrapper"><div class="wpf-editor"></div><textarea class="form-control wpfb-edit-comment" data-comment_id="'+key+'" placeholder="Edit the comment..." spellcheck="false">'+URLify(wpfb_metas.comments[key].message)+'</textarea><button class="wpf_edit_comment_btn" onclick="wpfb_edit_comment(\''+key+'\')">'+edit_comment_text+'</button><a class="wpf-cancel-edit-comment" onclick="wpfb_cancel_edit_comment(\''+key+'\')" href="javascript:void(0)">'+cancel_edit_comment_text+'</a><div class="wpf_update_error wpf_hide">Please post your comment before performing this action</div></div></div></div></li>';
            }
        } else if ( wpfb_metas.comments[key].comment_type == 1 ) {
            wpfb_messages_html += '<li class="'+task_author+' is_image" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + '</div><span>' + wpfb_metas.comments[key].time + '</span></level><div class="meassage_area_main">'+img_dwn_icon+'<a href="'+wpfb_metas.comments[key].message+'" target="_blank"><img src="'+wpfb_metas.comments[key].message+'" class="wpf_task_uploaded_image" title="WPF Screenshot" alt="WPF Screenshot"/></a></div></div></div></li>';
        } else if ( wpfb_metas.comments[key].comment_type == 3 ) {
            let img_dwn_icon = "";
            wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + '</div><span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<iframe width="100%" height="150" src="https://www.youtube.com/embed/'+wpfb_metas.comments[key].message+'"></iframe></div></div></div></li>';
        } else {
            let img_dwn_icon = "";
            var wpf_download_file  = wpfb_metas.comments[key].message.split("/").pop();
            wpfb_messages_html += '<li class="'+task_author+' is_file" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + wpfb_metas.comments[key].author + '</div><span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<a href="'+wpfb_metas.comments[key].message+'" download="'+wpf_download_file+'" target="_blank"><i class="gg-software-download"></i> '+ wpf_download_file+'</a></div></div></div></li>';
        }
        jQuery_WPF('#task_comments_'+comment_count).append(wpfb_messages_html);
    }

    var wpf_tmp_general_response_html = wpf_task_popover_html(3,comment_count,wpfb_task_id,wpfb_metas,wpfb_users_html,wpfb_task_priority_html,wpfb_task_status_html,wpfb_messages_html,0,load_general);
    jQuery_WPF('#wpf_general_comment_tabs').html(wpf_tmp_general_response_html);

    jQuery_WPF('#task_comments_'+comment_count).animate({scrollTop: (jQuery_WPF('#task_comments_'+comment_count).children().length * 200)}, 2000);
}
var reload_task = false;
var page_no = 1;
function load_all_page_tasks(){
    jQuery_WPF.ajax({
        method:"POST",
        url: ajaxurl,
        data: {
            action:'load_wpfb_tasks',
            wpf_nonce: wpf_nonce,
            page_no: page_no,
            wpside: logged_user.wpside,
        },
        beforeSend: function(){
            if ( page_no <= 1 ) {
                jQuery_WPF('.wpf_sidebar_loader').show();
            }
        },
        success: function(data){
            jQuery_WPF('.wpf_sidebar_loader').hide();
            var onload_wpfb_tasks = JSON.parse(data);
            if(onload_wpfb_tasks != null && onload_wpfb_tasks != "null") {
                const k = Object.keys(onload_wpfb_tasks).sort(timeSort);

                comment_count_initial = Object.keys(onload_wpfb_tasks).length;
                if ( comment_count_initial < 20 ) {
                    jQuery_WPF('.wpf_loading').hide();
                } else {
                    jQuery_WPF('.wpf_loading').show();
                }
                var wpfb_users_arr = JSON.parse(wpfb_users);
                let sticker_span = '';
                let old_sidebar_class = '_' + onload_wpfb_tasks[k[0]].class;
                
                jQuery_WPF.each(k,function (index, value) {
                    var wpfb_all_page_task_list_htmls = '';

                    if(wpf_tab_permission.display_stickers == 'yes'){
                        sticker_span = '<span class="sticker '+onload_wpfb_tasks[value].task_priority+'_custom"></span> ';
                    }

                    tasks_on_page[comment_count_initial]=value;

                    var display_check_mark = '';
                    if(wpf_tab_permission.display_task_id != 'yes'){
                        display_check_mark = '<i class="gg-check"></i>';
                    }else{
                        display_check_mark = onload_wpfb_tasks[value].site_task_id;
                    }
                    var internal_icon = '';
                    var internal='';
                    if ( onload_wpfb_tasks[value].is_internal == '1' ) {
                        internal_icon = internal_icon_html;
                        internal = '<span class="wpf_task_type" title="Task type">Internal</span>';
                        display_check_mark = '';
                    }

                    if(onload_wpfb_tasks[value].task_status == 'complete'){
                        var bubble_label = sticker_span+display_check_mark;    
                    }else{
                        var bubble_label = sticker_span+onload_wpfb_tasks[value].site_task_id;//task_comment_id;
                    }
                    

                    var user_html = '';
                    var user_avatar = onload_wpfb_tasks[value].task_auth_img;
                    if (user_avatar !== null && user_avatar !== undefined) {
                        if( Object.keys(user_avatar).length > 0 ) {
                            jQuery_WPF.each( user_avatar, function (index, value) {
                                if( value.img != '' && value.img != null ) {
                                    user_html += '<span class="wpf_user_avat"><img src="' + value.img + '" alt="author" ></span>';
                                } else if( value.displayname != '' && value.displayname != null ) {
                                    user_html += '<span class="wpf_user_avat">' + value.displayname.slice(0, 2) + '</span>';
                                }
                            });
                        }
                    }

                    var all_wpfb_metas = onload_wpfb_tasks[value].wpf_tags;
                    var all_other_tag = '';
                    var wpfb_tags_html = '';
                    if(all_wpfb_metas){
                        var tag_length = all_wpfb_metas.length;
                        const all_tag = Object.keys(all_wpfb_metas);
                        var i = 1;
                        jQuery_WPF.each(all_tag,function (index, value) {
                            if(i == 1){
                                wpfb_tags_html +=  '<span class="wpf_task_tag">' + all_wpfb_metas[value]["name"]+'</span>';
                            } else {
                                if(tag_length == i){
                                    all_other_tag +=  all_wpfb_metas[value]["name"];
                                }else{
                                    all_other_tag +=  all_wpfb_metas[value]["name"]+', ';
                                }
                            }
                            i++;
                        });
                        if(all_wpfb_metas.length > 1){
                            wpfb_tags_html += '<span class="wpf_task_tag_more" title="'+all_other_tag+'">...</span>';
                        }
                    }
                    let sidebar_class = "";
                    if(onload_wpfb_tasks[value].class !== ""){
                        sidebar_class = "_"+onload_wpfb_tasks[value].class;
                    }

                    var wpf_task_status_label = '';
                    var wpf_task_priority_label = '';
                    if(wpf_tab_permission.display_stickers == 'yes'){
                        wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+onload_wpfb_tasks[value].task_status+' wpf_'+onload_wpfb_tasks[value].task_status+'_custom" title="Status: '+onload_wpfb_tasks[value].task_status+'">'+status_icon+'</span>';
                        wpf_task_priority_label= '<span class="priority wpf_'+onload_wpfb_tasks[value].task_priority+' wpf_'+onload_wpfb_tasks[value].task_priority+'_custom" title="Priority: '+onload_wpfb_tasks[value].task_priority+'">'+priority_icon+'</span></div>';
                    } else {
                        wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+onload_wpfb_tasks[value].task_status+'" title="Status: '+onload_wpfb_tasks[value].task_status+'">'+status_icon+'</span>';
                        wpf_task_priority_label= '<span class="priority wpf_'+onload_wpfb_tasks[value].task_priority+'" title="Priority: '+onload_wpfb_tasks[value].task_priority+'">'+priority_icon+'</span></div>';
                    }

                    var wpf_page_url = onload_wpfb_tasks[value].task_page_url;
                    var saperater = '';
                    if (wpf_page_url !== null && wpf_page_url !== undefined) {
                        if ( wpf_page_url.indexOf('?') != -1 ) {
                            saperater = '&';
                        } else {
                            saperater = '?';
                        }
                    }

                    let custom_status_calss = '';
                    if(wpf_tab_permission.display_stickers == 'yes'){
                        custom_status_calss = onload_wpfb_tasks[value].task_status+'_custom';
                    }

                    if(onload_wpfb_tasks[value].task_page_title == null){
                        onload_wpfb_tasks[value].task_page_title = "";
                    }

                    for (var usr in wpfb_users_arr) {
                        if (wpfb_users_arr.hasOwnProperty(usr)) {
                            if(wpfb_users_arr[usr]['username']==onload_wpfb_tasks[value].task_config_author_name){
                                onload_wpfb_tasks[value].task_config_author_name = wpfb_users_arr[usr]['displayname'];
                                break;
                            }
                        }
                    }

                    page_title = '';
                    if ( logged_user.wpside == 'frontend' ) {
                        page_title = '<div class="wpf_task_pagename">'+ onload_wpfb_tasks[value].task_page_title +'</div>';
                    }

                    if ( onload_wpfb_tasks[value].task_type == 'general' || onload_wpfb_tasks[value].task_type == 'email' ) {
                        const tag = (onload_wpfb_tasks[value].task_type == 'general') ? '<span class="wpf_task_type" title="Task type">'+ wpf_general_tag +'</span>' : '<span class="wpf_task_type" title="Task type">'+ wpf_email_tag +'</span>';
                        wpfb_all_page_task_list_htmls += '<li class="current_page_task '+custom_status_calss+' '+ onload_wpfb_tasks[value].task_status+ ' ' + onload_wpfb_tasks[value].task_priority + '" data-taskid="'+onload_wpfb_tasks[value].wpf_task_id+'" data-task_url="'+onload_wpfb_tasks[value].task_page_url+saperater+'wpf_general_taskid='+onload_wpfb_tasks[value].wpf_task_id+'"><div class="wpf_task_info"><div data-disp-id="'+ onload_wpfb_tasks[value].site_task_id + '" class="wpf_task_number">' + bubble_label + internal_icon + '</div><div class="wpf_task_sum"><level class="task-author">'+ onload_wpfb_tasks[value].task_config_author_name +'<span>'+ onload_wpfb_tasks[value].task_time +'</span></level>'+ page_title +'<div class="current_page_task_list">'+ onload_wpfb_tasks[value].task_title +'</div></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+ internal + tag + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';
                    } else {
                        wpfb_all_page_task_list_htmls += '<li class="current_page_task '+custom_status_calss+' '+ onload_wpfb_tasks[value].task_status+ ' ' + onload_wpfb_tasks[value].task_priority + '" data-taskid="'+onload_wpfb_tasks[value].wpf_task_id+'" data-task_url="'+onload_wpfb_tasks[value].task_page_url+saperater+'wpf_taskid='+onload_wpfb_tasks[value].wpf_task_id+'"><div class="wpf_task_info"><div data-disp-id="'+ onload_wpfb_tasks[value].site_task_id + '" class="wpf_task_number">' + bubble_label + internal_icon + '</div><div class="wpf_task_sum"><level class="task-author">'+ onload_wpfb_tasks[value].task_config_author_name +'<span>'+ onload_wpfb_tasks[value].task_time +'</span></level>'+ page_title +'<div class="current_page_task_list">'+ onload_wpfb_tasks[value].task_title +'</div></div></div><div class="wpf_task_meta"><div class="wpf_task_tagg">'+ internal + wpfb_tags_html + '</div><div class="wpf_user_avatar">' + user_html + '</div></div></li>';
                    }

                    jQuery_WPF("#wpf_allpages_container"+sidebar_class).append(wpfb_all_page_task_list_htmls);

                    // eliminate the duplication of the previous block's item
                    if ( old_sidebar_class !== sidebar_class ) {
                        wpfb_all_page_task_list_htmls = '';
                    }
                    old_sidebar_class = sidebar_class;

                    comment_count_initial--;
                });
                reload_task = true;
                page_no = page_no + 1;
            } else {
                page_no = 0;
                jQuery_WPF('.wpf_loading').hide();
            }
        }
    });
}
function wpf_task_popover_html(wpf_task_type, comment_count, wpfb_task_id, wpfb_metas, wpfb_users_html, wpfb_task_priority_html, wpfb_task_status_html, wpfb_messages_html,new_task_popover,load_general) {
    let search_buble;
    if(wpf_admin_bar==1 && new_task_popover!=1 && load_general!=1){
        let search_bubble_str=wpfb_metas.wpfb_task_bubble;
        let search_bubble_cutout_1=search_bubble_str ? search_bubble_str.substr(0,search_bubble_str.indexOf('>')) : '';
        let search_bubble_cutout_2=search_bubble_str ? search_bubble_str.substr(search_bubble_str.indexOf('>')+1) : '';
        let search_bubble_cutout_3=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(search_bubble_cutout_2.indexOf('>')+1) : '';

        
        let search_bubble_mid_element=search_bubble_cutout_2 ? search_bubble_cutout_2.substr(0,search_bubble_cutout_2.indexOf('>')) : '';

        if(search_bubble_mid_element.indexOf("div:eq")>-1){
            let div_index=parseInt(search_bubble_mid_element.match(/(\d+)/)[0])+1;
            search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > div:eq("+div_index+") > "+search_bubble_cutout_3 : '';
        }else{
            search_buble=search_bubble_cutout_3 ? search_bubble_cutout_1+" > "+search_bubble_mid_element+" > "+search_bubble_cutout_3 : '';
        }

     }else{
        search_buble=wpfb_metas.wpfb_task_bubble;
    }

	
	let search_buble_length = 0;
	try {
		if(jQuery_WPF(document).find(search_buble).length == 0){
			search_buble=wpfb_metas.wpfb_task_bubble;
		}
	
		search_buble_length = jQuery_WPF(document).find(search_buble).length;
	} catch (e) {}

    if(search_buble_length === 0 && new_task_popover!=1 && load_general!=1){
        var response_html="";
    } else {
        var all_wpfb_metas = wpfb_metas.wpf_tags;
        var wpfb_users_arr = JSON.parse(wpfb_users);
        var is_general = false;
        wpf_tag_html = '';
        if (all_wpfb_metas) {
            const k = Object.keys(all_wpfb_metas);
            jQuery_WPF.each(k, function (index, value) {
                wpf_tag_html += "<span class='wpf_tag_name " + all_wpfb_metas[value]['slug'] + "'>" + all_wpfb_metas[value]['name'] + "<a href='javascript:void(0)' onclick='wpf_delete_tag(\"" + all_wpfb_metas[value]['name'] + "\",\"" + all_wpfb_metas[value]['slug'] + "\"," + wpfb_task_id + ")' data-tag_slug='" + all_wpfb_metas[value]['slug'] + "'><i class='gg-close-o'></i></a></span>";
            });
        }

        var wpf_hide = '';
        if (wpf_task_type == 2 || wpf_task_type == 3) {
            curr_browser_temp = get_browser();
            browser = curr_browser_temp['name'] + ' ' + curr_browser_temp['version'];
            var wpf_config_resolution = resolution;
            var wpf_config_browser = browser;
            var wpf_config_author_name = current_user_name;
            if (wpfb_task_id != 0) {
                var wpf_config_task_id = wpfb_task_id;
            } else {
                var wpf_config_task_id = '';
            }
        } else if (wpf_task_type == 1) {
            var wpf_config_resolution = resolution;
            var wpf_config_browser = browser;
            var wpf_config_author_name = current_user_name;
            var wpf_config_task_id = '';
            var element_center = getelementcenter(rightArrowParents.join(" > "));
            element_center['left'] = element_center['left'] - 25;
            element_center['top'] = element_center['top'] - 25;
        }

        if (wpfb_metas) {
            var wpf_config_resolution = wpfb_metas.task_config_author_resX + ' x ' + wpfb_metas.task_config_author_resY;
            var wpf_config_browser = wpfb_metas.task_config_author_browser;
            var wpf_config_author_name = wpfb_metas.task_config_author_name;
            var wpf_config_task_id = wpfb_task_id;
            var element_center = getelementcenter(wpfb_metas.wpfb_task_bubble);
        }

        if (wpf_task_type == 2 || wpf_task_type == 3) {
            var button_html = '';
        } else {
            if (wpfb_metas.task_status != 'complete') {
                jQuery_WPF(wpfb_metas.task_element_path).addClass('wpfb_task_bubble');
                jQuery_WPF(wpfb_metas.task_element_path).attr('data-task_id', wpfb_metas.task_comment_id);
            }
            if (element_center['left'] == 0 && element_center['top'] == 0) {
                /*======run script when element delete======*/
                data = wpfb_task_id;
                jQuery_WPF(document).find('#popover-content-c' + comment_count).remove();
                jQuery_WPF(document).find('#currentpage_' + comment_count).removeClass('current_page_task');
                jQuery_WPF(document).find('#currentpage_' + comment_count).addClass('current_page_general_task');
                jQuery_WPF('#currentpage_' + comment_count).attr('data-postid', wpfb_task_id);
                jQuery_WPF(document).find('#currentpage_' + comment_count + ' level').append('<span>General</span>');
                temp_task_text = data;

                // change the task's class so that it will open the popup as a General task => v2.0.9
                var item = jQuery_WPF("#wpf_thispage").find("[data-postid='" + wpfb_task_id + "']");
                jQuery_WPF(item).removeClass('current_page_task');
                jQuery_WPF(item).addClass('current_page_general_task'); // fixed the mixing tasks status when filter => v2.1.2

                var x_per = 100 * (wpfb_metas.task_elementX / wpfb_metas.task_config_author_resX);
                var y_per = 100 * (wpfb_metas.task_elementY / wpfb_metas.task_config_author_resY);
                element_center['left'] = (x_per * window.screen.width) / 100;
                element_center['top'] = (y_per * window.screen.height) / 100;

                is_general = true;
            } else {
                element_center['left'] = element_center['left'] - 25;
                element_center['top'] = element_center['top'] - 25;
            }


            let display_check_mark = '';
            if (wpf_tab_permission.display_task_id != 'yes') {
                display_check_mark = '<i class="gg-check"></i>';
            } else {
                display_check_mark = wpfb_metas.site_task_id;//comment_count;
            }

            if (wpfb_metas.task_status == 'complete') {
                var bubble_label = display_check_mark;
            } else {
                var bubble_label = '<span class="wpf_bubble_num_wrapper">'+wpfb_metas.site_task_id+'</span>';//comment_count;
            }

            if (wpf_tab_permission.display_stickers == 'yes') {

                if (wpfb_metas.task_priority == undefined || wpfb_metas.task_priority == '') {
                    var display_sticker = '<span class="sticker low low_custom" ></span>';
                } else {
                    var display_sticker = '<span class="sticker ' + wpfb_metas.task_priority + ' ' + wpfb_metas.task_priority + '_custom" ></span>';
                }

                if (wpfb_metas.task_status == undefined || wpfb_metas.task_status == '') {
                    var custom_class = 'open open_custom';
                } else {
                    var custom_class = wpfb_metas.task_status + '_custom';
                }

            } else {
                var display_sticker = '';
                var custom_class = '';
            }

            if (wpf_task_type == 1) {
                if (!is_general) {
                    if(wpfb_metas.is_internal=='1') {
                        var button_html = '<a id="bubble-' + comment_count + '" data-html2canvas-ignore="true" href="javascript:void(0)" rel="popover-' + comment_count + '" data-html="true" data-trigger="focus" data-popover-content="#popover-content-c' + comment_count + '" class="wpfb-point wpfb-internal ' + wpf_hide + ' ' + wpfb_metas.task_status + ' ' + custom_class + '" style="top:' + element_center['top'] + 'px;left:' + element_center['left'] + 'px;" data-toggle="popover" data-disp-id="'+wpfb_metas.site_task_id+'" data-comments-available=' + (typeof wpfb_metas.comments !== 'undefined') + '>' + display_sticker + '<span class="wpf_bubble_num_wrapper">'+bubble_comment_count+ '</span><span class="wpf_chevron_wrapper"><img src="' + plugin_url + 'images/eye-off-white.svg" alt="eye off white" class="wpf-internal-img"></span></a>';//+ bubble_comment_count+ '</a>';
                    } else {
                        var button_html = '<a id="bubble-' + comment_count + '" data-html2canvas-ignore="true" href="javascript:void(0)" rel="popover-' + comment_count + '" data-html="true" data-trigger="focus" data-popover-content="#popover-content-c' + comment_count + '" class="wpfb-point ' + wpf_hide + ' ' + wpfb_metas.task_status + ' ' + custom_class + '" style="top:' + element_center['top'] + 'px;left:' + element_center['left'] + 'px;" data-toggle="popover" data-disp-id="'+wpfb_metas.site_task_id+'" data-comments-available=' + (typeof wpfb_metas.comments !== 'undefined') + '>' + display_sticker + '<span class="wpf_bubble_num_wrapper">'+bubble_comment_count+ '</span></a>';
                    }
                } else {
                    var button_html = '';
                }
            } else {
                if (wpf_show_front_stikers == 'yes') {
                    var wpf_hide_class = '';
                } else {
                    var wpf_hide_class = 'wpf_hide';
                }

                if (!is_general) {
                    if(wpfb_metas.is_internal=='1') {
                        var button_html = '<a id="bubble-' + comment_count + '" data-html2canvas-ignore="true" href="javascript:void(0)" rel="popover-' + comment_count + '" data-html="true" data-trigger="focus" data-popover-content="#popover-content-c' + comment_count + '" class="wpfb-point wpfb-internal ' + wpfb_metas.task_status + ' ' + wpf_hide_class + ' ' + wpf_hide + ' ' + custom_class + '" style="top:' + element_center['top'] + 'px;left:' + element_center['left'] + 'px;" data-toggle="popover" data-disp-id="'+wpfb_metas.site_task_id+'" data-comments-available=' + (typeof wpfb_metas.comments !== 'undefined') + '>' + display_sticker +bubble_label + '<span class="wpf_chevron_wrapper"><img src="' + plugin_url + 'images/eye-off-white.svg" alt="eye off white" class="wpf-internal-img"></span></a>';//bubble_label + '</a>';
                    } else {
                        var button_html = '<a id="bubble-' + comment_count + '" data-html2canvas-ignore="true" href="javascript:void(0)" rel="popover-' + comment_count + '" data-html="true" data-trigger="focus" data-popover-content="#popover-content-c' + comment_count + '" class="wpfb-point ' + wpfb_metas.task_status + ' ' + wpf_hide_class + ' ' + wpf_hide + ' ' + custom_class + '" style="top:' + element_center['top'] + 'px;left:' + element_center['left'] + 'px;" data-toggle="popover" data-disp-id="'+wpfb_metas.site_task_id+'" data-comments-available=' + (typeof wpfb_metas.comments !== 'undefined') + '>' + display_sticker + bubble_label + '</a>';
                    }
                } else {
                    var button_html = '';
                }
            }
        }

        if (wpf_task_type == 2 || wpf_task_type == 3) {
            var popover_container = '<div class=""><div data-html2canvas-ignore="true" id="popover-content-c' + comment_count + '"><div class="wpf_loader wpf_loader_' + comment_count + ' wpf_hide"></div>';
        } else {
            var popover_container = '<div class=""><div data-html2canvas-ignore="true" id="popover-content-c' + comment_count + '" class="hide"><div class="wpf_loader wpf_loader_' + comment_count + ' wpf_hide"></div><a href="javascript:void(0)" onclick="close_popover(' + comment_count + ');" class="close" data-dismiss="alert">&times;</a>';
        }

        var tab_nav_html = '<ul class="nav nav-tabs" id="myTab-' + comment_count + '" role="tablist">';
        if (wpf_tab_permission.user == 'yes') {
            tab_nav_html += '<li class="nav-item" title="Users"><a class="nav-link wpf_user_tab" id="wpfbuser-tab-' + comment_count + '" data-toggle="tab" href="#wpfbuser-' + comment_count + '" role="tab" aria-controls="wpfbuser" aria-selected="false">'+user_icon+'<span class="wpf_tooltiptext user_tooltip_text">Toggle whether users should receive notifications on this task, if you created this task, you are assigned automatically.</span></a></li>';
        }
        if (wpf_tab_permission.status == 'yes') {
            tab_nav_html += '<li class="nav-item" title="Status"><a class="nav-link wpf_stat_tab" id="wpfbtaskstatus-tab-' + comment_count + '" data-toggle="tab" href="#wpfbtaskstatus-' + comment_count + '" role="tab" aria-controls="wpfbtaskstatus" aria-selected="false">' + status_icon + '<span class="wpf_tooltiptext status_tooltip_text">Change the status of this task, perfect for when something is done and you want to notify others that it has been completed.</span></a></li>';
        }
        if (wpf_tab_permission.priority == 'yes') {
            tab_nav_html += '<li class="nav-item" title="Priority"><a class="nav-link wpf_prio_tab" id="wpfbpriority-tab-' + comment_count + '" data-toggle="tab" href="#wpfbpriority-' + comment_count + '" role="tab" aria-controls="wpfbpriority" aria-selected="false">' + priority_icon + '<span class="wpf_tooltiptext urgency_tooltip_text">Change the urgency of this task, if something is super urgent, mark it as critical.</span></a></li>';
        }
        if (wpf_tab_permission.screenshot == 'yes') {
            tab_nav_html += '<li class="nav-item" title="Screenshots"><a class="nav-link wpf_scrn_tab" id="wpfbscreenshot-tab-' + comment_count + '" data-toggle="tab" href="#wpfbscreenshot-' + comment_count + '" role="tab" aria-controls="wpfbscreenshot" aria-selected="false">' + screen_short_icon + '<span class="wpf_tooltiptext ss_tooltip_text">This automatic screenshot is the exact view that was seen when this task was created. The area highlighted is also shown with a red outline making every crystal clear!</span></a></li>';
        }
        if (wpf_tab_permission.information == 'yes') {
            tab_nav_html += '<li class="nav-item" title="' + wpf_additional_information + '"><a class="nav-link wpf_deta_tab" id="wpfbsysinfo-tab-' + comment_count + '" data-toggle="tab" href="#wpfbsysinfo-' + comment_count + '" role="tab" aria-controls="wpfbsysinfo" aria-selected="false">' + info_icon + '<span class="wpf_tooltiptext info_tooltip_text">See more information about this task, like the browser and screen size it was created on, helping you debug problems quicker.</span></a></li>';
        }
        tab_nav_html += '<li class="nav-item" title="' + wpf_share_task_link + '"><a class="nav-link wpf_deta_tab" id="sharetasklink-tab-' + comment_count + '" data-toggle="tab" href="#sharetasklink-' + comment_count + '" role="tab" aria-controls="sharetasklink" aria-selected="false">' + share_icon + '</a></li>';
        tab_nav_html += '</ul>';

        if(wpfb_metas.task_config_author_name != "undefined"){
            for (var usr in wpfb_users_arr) {
                if (wpfb_users_arr.hasOwnProperty(usr)) {
                    if(wpfb_users_arr[usr]['username']==wpfb_metas.task_config_author_name){
                        wpf_config_author_name = wpfb_users_arr[usr]['displayname'];
                        break;
                    }
                }
            }
        }
        //new task popover
        var tabs_html='';
        if(new_task_popover==1 || wpf_task_type!=''){
            tabs_html = '<div class="tab-content" id="myTabContent-' + comment_count + '">';
            var wpf_all_tags_html = '';
            if (wpf_current_role == 'advisor') {
                wpf_all_tags_html = '<div class="wpf_icon_title"><i class="gg-tag"></i> ' + wpf_custom_tags + '</div><div class="wpf_tag_autocomplete"><input type="text" name="wpfeedback_tags" class="wpf_tag" value="" id="wpfeedback_tags_' + wpf_config_task_id + '" data-id="' + wpf_config_task_id + '" data-commentid="' + comment_count + '" onkeydown="wpf_search_tags(this,' + wpf_config_task_id + ')"><button class="wpf_tag_submit_btn" onclick="wpf_add_tag(\'wpfeedback_tags_' + wpf_config_task_id + '\')"><i class="gg-corner-down-left"></i></button></div><div id="all_tag_list_' + wpf_config_task_id + '">' + wpf_tag_html + '</div>';
            }
            tabs_html += '<div class="tab-pane" id="wpfbsysinfo-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbsysinfo-tab">' + wpf_all_tags_html + '<ul><li><b>' + wpf_resolution + '</b> <span id="wpfbsysinfo_resolution-' + comment_count + '">' + wpf_config_resolution + '</span></li><li><b>' + wpf_browser + '</b> <span id="wpfbsysinfo_browser-' + comment_count + '">' + wpf_config_browser + '</span></li><li><b>' + wpf_user_name + '</b> <span id="wpfbsysinfo_user_name-' + comment_count + '">' + wpf_config_author_name + '</span></li><li><b>' + wpf_task_id + '</b> <span id="wpfbsysinfo_task_id-' + comment_count + '">' + wpf_config_task_id + '</span></li>';

            if (wpf_task_type == 1 || wpf_task_type == 2) {
                tabs_html += '<li id="wpf_delete_container_' + comment_count + '"><span class="wpfbsysinfo_temp_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_temp_delete_btn" style="color:red;" data-btn_elemid="' + comment_count + '"  ><i class="gg-trash"></i> ' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_temp_delete_task_id_' + comment_count + ' wpf_hide" >' + wpf_delete_conform_text1 + ' ' + wpf_delete_conform_text2 + '<a href="javascript:void(0)" class="wpf_task_temp_delete" data-elemid="' + comment_count + '" style="color:red;"> ' + wpf_yes + '</a></p></li>';
            } else {
                if (wpf_tab_permission.delete_task == 'yes') {
                    tabs_html += '<li><span class="wpfbsysinfo_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_delete_btn" data-btn_taskid="' + wpfb_task_id + '" style="color:red;"><i class="gg-trash"></i>' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_delete_task_id_' + wpfb_task_id + ' wpf_hide" ><b>' + wpf_delete_conform_text1 + '</b><br>' + wpf_delete_conform_text2 + ' <a href="javascript:void(0)" class="wpf_task_delete" data-taskid="' + wpfb_task_id + '" data-elemid="' + comment_count + '" style="color:red;"><b>' + wpf_yes + '</b></a></p></li>';
                } else if (wpf_tab_permission.delete_task == 'no') {
                    if (wpfb_metas.task_config_author_id == current_user_id) {
                        tabs_html += '<li><span class="wpfbsysinfo_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_delete_btn" data-btn_taskid="' + wpfb_task_id + '" style="color:red;"><i class="gg-trash"></i> ' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_delete_task_id_' + wpfb_task_id + ' wpf_hide" ><b>' + wpf_delete_conform_text1 + '</b><br>' + wpf_delete_conform_text2 + ' <a href="javascript:void(0)" class="wpf_task_delete" data-taskid="' + wpfb_task_id + '" data-elemid="' + comment_count + '" style="color:red;"><b>' + wpf_yes + '</b></a></p></li>';
                    }
                }
            }

            tabs_html += '</ul></div>';
            if (wpf_task_type == 3) {
                if (wpfb_task_id != 0) {
                    var task_link_div = '<div class="wpf_task_link_' + wpfb_task_id + '">';
                    var task_link = current_page_url + '?wpf_general_taskid=' + wpfb_task_id + '&wpf_login=1';
                    var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + wpfb_task_id + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + wpfb_task_id + '","general")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + wpfb_task_id + '"> ' + wpf_remove_login_parameter + '</label></div>';
                } else {
                    var task_link_div = '<div class="wpf_task_link_' + comment_count + '">';
                    var task_link = current_page_url + '?wpf_general_taskid=' + wpfb_task_id + '&wpf_login=1';
                    var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + wpfb_task_id + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + wpfb_task_id + '","general")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + wpfb_task_id + '"> ' + wpf_remove_login_parameter + '</label></div>';
                }
            } else {
                if (wpfb_task_id != 0) {
                    var task_link_div = '<div class="wpf_task_link_' + comment_count + '">';
                    var task_link = current_page_url + '?wpf_taskid=' + comment_count + '&wpf_login=1';
                    var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + comment_count + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + comment_count + '","normal")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + comment_count + '">' + wpf_remove_login_parameter + '</label></div>';
                } else {
                    var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + comment_count + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + comment_count + '","normal")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + comment_count + '">' + wpf_remove_login_parameter + '</label></div>';
                    var task_link_div = '<div class="wpf_task_link_' + comment_count + '">';
                    var task_link = current_page_url + '?wpf_taskid=' + comment_count + '&wpf_login=1';
                }
            }

            tabs_html += '<div class="tab-pane" id="sharetasklink-' + comment_count + '" role="tabpanel" aria-labelledby="sharetasklink-tab"><div class="wpf_icon_title">' + wpf_share_task_link + ' </div><input type="text" id="wpf_share_link_' + wpfb_task_id + '" value="' + task_link + '" style="position: absolute; z-index: -999; opacity: 0;"><span class="wpf_share_task_link">' + task_link_div + task_link + '</div><a href="javascript:void(0);" onclick=\'wpf_copy_to_clipboard("wpf_share_link_' + wpfb_task_id + '")\' class="wpf_copy_task_icon" style="display: inline-block; color: var(--main-wpf-color) !important;"><i class="gg-copy"></i></a><span class="wpf_success_wpf_share_link" id="wpf_success_wpf_share_link_' + wpfb_task_id + '" style="display: none;">The link was copied to your clipboard.</span></span>' + wpf_remove_login_checkbox + '</div>';

            tabs_html += '<div class="tab-pane" id="wpfbuser-' + comment_count + '" role="tabpanel" aria-labelledby="home-tab">' + wpfb_users_html + '</div>';
            var wpf_screenshot = '';
            if (wpfb_metas.wpf_task_screenshot != undefined) {
                wpf_screenshot = '<a target="_blank" href="' + wpfb_metas.wpf_task_screenshot + '" class="wpf_screenshot_img_link"><img src="' + wpfb_metas.wpf_task_screenshot + '" alt="screenshot" id="screenshot_img_' + comment_count + '" style="margin-top:10px; border:1px solid #dee2e6;padding: 5px;width: 100%;" /></a>';
            } else {
                wpf_screenshot = '<a target="_blank" href="#" class="wpf_screenshot_img_link"><img src="#" id="screenshot_img_' + comment_count + '" alt="screenshot" style="margin-top:10px; border:1px solid #dee2e6;padding: 5px; display: none;width: 100%;" /></a>';
            }
            if (wpf_task_type == 1 || wpf_task_type == 2) {
                if (wpf_tab_permission.display_stickers == 'yes') {
                    tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider"><input id="priority_low-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="low" class="wpfbpriority low_radio" checked><label for="priority_low-' + comment_count + '" class="low_label">' + wpf_priority_low + '</label><input id="priority_medium-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="medium" class="wpfbpriority medium_radio"><label for="priority_medium-' + comment_count + '" class="medium_label">' + wpf_priority_medium + '</label><input id="priority_high-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="high" class="wpfbpriority high_radio"><label for="priority_high-' + comment_count + '" class="high_label">' + wpf_priority_high + '</label><input id="priority_critical-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="critical" class="wpfbpriority critical_radio"><label for="priority_critical-' + comment_count + '" class="critical_label">' + wpf_priority_critical + '</label></div></div>';
                    tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider"><input id="status_open-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="open" data-elemid="' + comment_count + '" class="wpfbtaskstatus open_radio" checked><label for="status_open-' + comment_count + '" class="open_label">' + wpf_status_open_task + '</label><input id="status_progress-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="in-progress" data-elemid="' + comment_count + '" class="wpfbtaskstatus in_progress_radio" ><label for="status_progress-' + comment_count + '" class="in_progress_label">' + wpf_status_in_progress + '</label><input id="status_pending-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="pending-review" data-elemid="' + comment_count + '" class="wpfbtaskstatus pending_radio" ><label for="status_pending-' + comment_count + '" class="pending_label">' + wpf_status_pending_review + '</label><input id="status_complete-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="complete" data-elemid="' + comment_count + '" class="wpfbtaskstatus complete_radio" ><label for="status_complete-' + comment_count + '" class="complete_label">' + wpf_status_complete + '</label></div></div>';
                } else {
                    tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider"><input id="priority_low-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="low" class="wpfbpriority" checked><label for="priority_low-' + comment_count + '">' + wpf_priority_low + '</label><input id="priority_medium-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="medium" class="wpfbpriority"><label for="priority_medium-' + comment_count + '">' + wpf_priority_medium + '</label><input id="priority_high-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="high" class="wpfbpriority"><label for="priority_high-' + comment_count + '">' + wpf_priority_high + '</label><input id="priority_critical-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="critical" class="wpfbpriority"><label for="priority_critical-' + comment_count + '">' + wpf_priority_critical + '</label></div></div>';
                    tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider"><input id="status_open-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="open" data-elemid="' + comment_count + '" class="wpfbtaskstatus" checked><label for="status_open-' + comment_count + '">' + wpf_status_open_task + '</label><input id="status_progress-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="in-progress" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_progress-' + comment_count + '">' + wpf_status_in_progress + '</label><input id="status_pending-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="pending-review" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_pending-' + comment_count + '">' + wpf_status_pending_review + '</label><input id="status_complete-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="complete" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_complete-' + comment_count + '">' + wpf_status_complete + '</label></div></div>';
                }
                tabs_html += '<div class="tab-pane" id="wpfbscreenshot-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbscreenshot-tab"><a href="javascript:void(0)" onclick="screenshot(' + comment_count + ');"><div class="wpf_screenshot_button">' + wpf_screenshot_view + '</div></a>' + wpf_screenshot + '</div><div  id="task_comments_section_' + comment_count + '"><ul class="wpf_current_chat_box scrollbar-outer" id="task_comments_' + comment_count + '"></ul></div>';
            } else {
                tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider">' + wpfb_task_priority_html + '</div></div>';
                tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider">' + wpfb_task_status_html + '</div></div>';
                tabs_html += '<div class="tab-pane" id="wpfbscreenshot-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbscreenshot-tab"><a href="javascript:void(0)" onclick="screenshot(' + comment_count + ');"><div class="wpf_screenshot_button">' + wpf_screenshot_view + '</div></a>' + wpf_screenshot + '</div><div id="task_comments_section_' + comment_count + '"><ul class="wpf_current_chat_box scrollbar-outer" id="task_comments_' + comment_count + '">' + wpfb_messages_html + '</ul></div>';
            }

            tabs_html += '</div>';
        } //new task popover ends
        let mark_as_complete_checkbox = "";
        let dissabled_attr = "";

        // check the mark complete checkbox if the task has completed
        const task_status_complete_checked = (wpfb_metas['task_status'] === 'complete') ? "checked" : "";

        var newtaskclass = '';
        var disabled = '';
        if( new_task_popover == 1 ) {
            newtaskclass = 'wpf_newtask';
            disabled = 'disabled';
        }

        mark_as_complete_checkbox = "<input type='checkbox' data-id='"+comment_count+"' class='mark_as_complete_checkbox wpf_checkbox' id='mark_complete_"+comment_count+"'" + task_status_complete_checked + "><label class='mark_as_complete_lable " + newtaskclass + "' for='mark_complete_"+comment_count+"'>"+ user_checked + "<span class='wpf_task_complete_text'>" + wpf_complete_task + "</span><span class='wpf_task_completed_text'>" + wpf_completed_task + "</span></label>";
        
        if(wpfb_metas.is_internal=='1'){
            internal_class=' wpf_is_internal';
            wpf_mark_internal_btn='<img src="' + plugin_url + 'images/eye-off-white.svg" alt="eye off white" class="wpf-internal-img"><span class="wpf_tooltiptext unmark_internal_tooltip_text">'+ switch_to_normal +'</span><span class="wpf_tooltiptext new_internal_tooltip_text">'+ create_internal_task +'</span><span class="wpf_tooltiptext mark_internal_tooltip_text">'+ switch_to_internal +'</span>';
        }else{
            wpf_mark_internal_btn='<img src="' + plugin_url + 'images/eye-off.svg" alt="eye off" class="wpf-internal-img"><span class="wpf_tooltiptext unmark_internal_tooltip_text">'+ switch_to_normal +'</span><span class="wpf_tooltiptext new_internal_tooltip_text">'+ create_internal_task +'</span><span class="wpf_tooltiptext mark_internal_tooltip_text">'+ switch_to_internal +'</span>';
            internal_class='';
        }

        if(new_task_popover==1){
            internal_tooltip_class=' new_internal_tooltip';
        }else if(wpfb_metas.is_internal=='1'){
            internal_tooltip_class=' unmark_internal_tooltip';
        }else if(wpfb_metas.is_internal!='1'){
            internal_tooltip_class=' mark_internal_tooltip';
        }

        if(wpf_current_role=='advisor'){
            internal_button='<button class="' + disabled + ' wpf_mark_internal'+internal_class+internal_tooltip_class+'" id="wpf_mark_internal_'+comment_count+'" onclick="new_comment(' + comment_count + ', 1)">' + wpf_mark_internal_btn + '</button>';
        }else{
            internal_button='';
        }
        var note_button = '';
        if ( wpf_current_role == 'advisor' || wpf_current_role == 'council' ) {
            note_button = '<button class="wpf_mark_note disabled ' + newtaskclass + '" id="wpf_note_'+comment_count+'" onclick="new_comment(' + comment_count + ', 0, true)"><img src="' + plugin_url + 'images/note.svg" alt="note"><span class="wpf_tooltiptext note_tooltip_text">'+ add_note +'</span></button>';
        }

        var guest_comment = 'guest_comment';
        if ( wpf_current_role == 'advisor' || wpf_current_role == 'council' ) {
            wpf_add_comment_btn = '<img src="' + plugin_url + 'images/comment.png" alt="comment">';
            guest_comment = '';
        }
        var attachment = '<button class="wpf_upload_button"><img src="' + plugin_url + 'images/attachment.svg" alt="attachment"><div class="wpf_total_files"></div></button>';
        var comment_button = '<button class="disabled wpf_green_btn wpf_comment_btn task_comment ' + guest_comment + '" onclick="new_comment(' + comment_count + ')">' + wpf_add_comment_btn + '<span class="wpf_tooltiptext comment_tooltip_text">Create your comment on this task.</span></button>';
        var comment_html = '<div class="form-group"><div class="wpf_form_group_editor"><div class="wpf-editor" data-id="comment-' + comment_count + '"></div><div class="wpf_upload_file_view_wrapper"><div class="wpf_upload_file_view_container"></div></div>' + attachment + '</div><textarea class="form-control" id="comment-' + comment_count + '" placeholder="' + wpf_comment_box_placeholder + '"></textarea><span id="wpf_error_' + comment_count + '" class="wpf_hide">' + wpf_task_text_error_msg + '</span><span id="wpf_note_error_' + comment_count + '" class="wpf_hide">' + wpf_task_note_error_msg + '</span><span id="wpf_task_error_' + comment_count + '" class="wpf_hide">' + wpf_task_upload_error_msg + '</span><span id="wpf_push_to_media_error_' + comment_count + '" class="wpf_hide">' + wpf_push_to_media_error_msg + '</span><div class="wpf_bottom_buttons"><div class="wpf_button_section1">' + mark_as_complete_checkbox + '</div><div class="wpf_button_section2">' + note_button + internal_button + comment_button + '</div></div><p id="wpf_upload_error_' + comment_count + '" class="wpf_hide">' + wpf_upload_invalid_file_msg + '</p></div></div></div>';
        var response_html = button_html + popover_container + tab_nav_html + tabs_html + comment_html;
    }
    return response_html;
}
function load_popover_content(element){
    jQuery_WPF.ajax({
        method:"POST",
        url: ajaxurl,
        data: {
            action: 'load_wpfb_tasks',
            wpf_nonce: wpf_nonce,
            current_page_url: current_page_url,
            fallback_link_check: fallback_link_check,
            current_page_id: current_page_id,
            wpf_current_screen: wpf_current_screen,
            page_type: page_type,
            wpside: logged_user.wpside
        },
        beforeSend: function(){
            jQuery_WPF(jQuery_WPF(element).attr('data-popover-content')).find('.wpf_loader').show();
        },
        success: function(data){
            var uncompleted_task;
            jQuery_WPF(jQuery_WPF(element).attr('data-popover-content')).find('.wpf_loader').hide();
            wpf_tasks_loaded = true;
            onload_wpfb_tasks = JSON.parse(data);
            if(onload_wpfb_tasks !== '' && onload_wpfb_tasks !== null && onload_wpfb_tasks !== undefined){
                const k = Object.keys(onload_wpfb_tasks).sort(timeSort);
                comment_count_initial = Object.keys(onload_wpfb_tasks).length;
                jQuery_WPF.each(k,function (index, value) {
                tasks_on_page[onload_wpfb_tasks[value].wpf_task_id]=value;
                    if ( jQuery_WPF("#bubble-" + onload_wpfb_tasks[value].wpf_task_id).data('comments-available') ) {
                        generate_popover_html(value, onload_wpfb_tasks[value]);
                    }
                    jQuery_WPF( function() {
                            jQuery_WPF( "#bubble-"+onload_wpfb_tasks[value].wpf_task_id).draggable({ containment: "document" });
                    });
                    comment_count_initial--;
                });
            }
        }
    });
}
function generate_popover_html(wpfb_task_id,wpfb_metas) {
    var notify_users = '';
    if(wpfb_metas.task_notify_users !== '' && wpfb_metas.task_notify_users  !== null && wpfb_metas.task_notify_users !== undefined){
        notify_users =  wpfb_metas.task_notify_users.split(',');
    }

    var wpfb_users_arr = JSON.parse(wpfb_users);
    var comment_count = wpfb_metas.wpf_task_id;
    let sticker_span = '';
    let custom_status_class = '';
    let sidebar_class = "";
    if(wpfb_metas.class !== ""){
        sidebar_class = "_"+wpfb_metas.class;
    }

    if(wpf_tab_permission.display_stickers == 'yes'){
        custom_status_class = wpfb_metas.task_status+'_custom';
    }

    if(wpf_tab_permission.display_stickers == 'yes'){
        sticker_span = '<span class="sticker '+wpfb_metas.task_priority+'_custom"></span> ';
    }

    let display_check_mark = '';
    if(wpf_tab_permission.display_task_id != 'yes'){
        display_check_mark = '<i class="gg-check"></i>';
    }else{
        display_check_mark = wpfb_metas.site_task_id;//comment_count;
    }

    if(wpfb_metas.task_status=='complete'){
        var bubble_label = sticker_span+display_check_mark;
    }
    else{
        var bubble_label = sticker_span+wpfb_metas.site_task_id;//comment_count;
    }

    if(wpfb_metas.is_internal=='1'){
        var internal_icon=internal_icon_html;
        var internal='<span class="wpf_task_type" title="Task type">Internal</span>';
    }else{
        var internal_icon='';
        internal='';
    }
    var all_wpfb_metas = wpfb_metas.wpf_tags;
    var all_other_tag = '';
    var wpfb_tags_html = '';
    if(all_wpfb_metas){
        var tag_length = all_wpfb_metas.length;
        wpfb_tags_html = '<div class="wpf_task_tags">';
        const all_tag = Object.keys(all_wpfb_metas);
        var i = 1;
        jQuery_WPF.each(all_tag,function (index, value) {
            if(i == 1){
                wpfb_tags_html +=  '<span class="wpf_task_tag">' + all_wpfb_metas[value]["name"]+'</span>';
            }
            else {
                if(tag_length == i){
                    all_other_tag +=  all_wpfb_metas[value]["name"];
                }else{
                    all_other_tag +=  all_wpfb_metas[value]["name"]+', ';
                }
            }
            i++;
        });
        if(all_wpfb_metas.length > 1){
            wpfb_tags_html += '<span class="wpf_task_tag_more" title="'+all_other_tag+'">...</span>';
        }
        wpfb_tags_html += '</div>';
    }

    if(wpf_tab_permission.display_stickers == 'yes'){
        var wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+wpfb_metas.task_status+' wpf_'+wpfb_metas.task_status+'_custom" title="Status: '+wpfb_metas.task_status+'">'+status_icon+'</span>';
        var wpf_task_priority_label= '<span class="priority wpf_'+wpfb_metas.task_priority+' wpf_'+wpfb_metas.task_priority+'_custom" title="Priority: '+wpfb_metas.task_priority+'">'+priority_icon+'</span></div>';
    }else{
        var wpf_task_status_label= '<div class="wpf_task_label"><span class="task_status wpf_'+wpfb_metas.task_status+'" title="Status: '+wpfb_metas.task_status+'">'+status_icon+'</span>';
        var wpf_task_priority_label= '<span class="priority wpf_'+wpfb_metas.task_priority+'" title="Priority: '+wpfb_metas.task_priority+'">'+priority_icon+'</span></div>';
    }

    for (var usr in wpfb_users_arr) {
        if (wpfb_users_arr.hasOwnProperty(usr)) {
            if(wpfb_users_arr[usr]['username']==wpfb_metas.task_config_author_name){
                wpfb_metas.task_config_author_name = wpfb_users_arr[usr]['displayname'];
                break;
            }
        }
    }

    if(wpfb_metas.task_type=='general'){

        /* prevent add task on sidebar task list if it's already present of the list => v2.1.1 */
        let flag_found = false;

        jQuery_WPF("#wpf_thispage_container"+sidebar_class).find('li').each(function(index, element) {

            if ( jQuery_WPF(element).attr('data-postid') == wpfb_task_id ) {
                flag_found = true;
                return;
            }
        });

        if ( !flag_found ) {
            var wpfb_current_page_task_list_html = '<li class="current_page_general_task ' + wpfb_metas.task_status + ' ' + custom_status_class + ' ' + wpfb_metas.task_priority + '" data-taskid="' + comment_count + '" data-postid="' + wpfb_task_id + '"><div class="wpf_task_number ' + wpfb_metas.task_status + '_custom" title="Remap the task to an element" data-disp-id="' + wpfb_metas.site_task_id + '">' + bubble_label + '</div><div class="wpf_task_sum"><level class="task-author">' + wpfb_metas.task_config_author_name + '<span>' + wpfb_metas.task_time + '</span></level><div class="current_page_task_list">' + wpfb_metas.task_title + '</div></div><div class="wpf_task_meta"><div class="wpf_task_meta_icon"><i class="gg-chevron-left"></i></div><div class="wpf_task_meta_details"><span class="wpf_task_type" title="Task type">' + wpf_general_tag + '</span>' + wpf_task_status_label + wpf_task_priority_label + wpfb_tags_html + '</div></div></li>';
            jQuery_WPF("#wpf_thispage_container" + sidebar_class).append(wpfb_current_page_task_list_html);
        }
    } else {
        var wpfb_users_html = get_user_list(wpfb_users_arr, comment_count, notify_users);

        var temp_task_priority_low = temp_task_priority_medium = temp_task_priority_high = temp_task_priority_critical = '';
        if(wpfb_metas.task_priority == 'low') {
            temp_task_priority_low = 'checked';
        } else if(wpfb_metas.task_priority == 'medium') {
            temp_task_priority_medium = 'checked';
        } else if(wpfb_metas.task_priority == 'high') {
            temp_task_priority_high = 'checked';
        } else {
            temp_task_priority_critical = 'checked';
        }

        if(wpf_tab_permission.display_stickers == 'yes') {
            var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority low_radio ' + temp_task_priority_low + '" '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'" class="low_label">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority medium_radio ' + temp_task_priority_medium + '" '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'" class="medium_label">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority high_radio ' + temp_task_priority_high + '" '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'" class="high_label">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority critical_radio ' + temp_task_priority_critical + '" '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'" class="critical_label">'+wpf_priority_critical+'</label>';
        } else {
            var wpfb_task_priority_html='<input id="priority_low-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="low" class="wpfbpriority ' + temp_task_priority_low + '" '+temp_task_priority_low+'><label for="priority_low-'+comment_count+'" class="">'+wpf_priority_low+'</label><input id="priority_medium-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="medium" class="wpfbpriority ' + temp_task_priority_medium + '" '+temp_task_priority_medium+'><label for="priority_medium-'+comment_count+'" class="">'+wpf_priority_medium+'</label><input id="priority_high-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="high" class="wpfbpriority ' + temp_task_priority_high + '" '+temp_task_priority_high+'><label for="priority_high-'+comment_count+'" class="">'+wpf_priority_high+'</label><input id="priority_critical-'+comment_count+'" type="radio" name="wpfbpriority'+comment_count+'" data-elemid="'+comment_count+'" value="critical" class="wpfbpriority ' + temp_task_priority_critical + '" '+temp_task_priority_critical+'><label for="priority_critical-'+comment_count+'" >'+wpf_priority_critical+'</label>';
        }
        var temp_task_status_open = temp_task_status_inprogress = temp_task_status_pending_review = temp_task_status_complete = '';
        if(wpfb_metas.task_status == 'open') {
            temp_task_status_open = 'checked';
        } else if(wpfb_metas.task_status == 'in-progress') {
            temp_task_status_inprogress = 'checked';
        } else if(wpfb_metas.task_status == 'pending-review') {
            temp_task_status_pending_review = 'checked';
        } else {
            temp_task_status_complete = 'checked';
        }

        if(wpf_tab_permission.display_stickers == 'yes') {
            var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus open_radio ' + temp_task_status_open + '" '+temp_task_status_open+'><label for="status_open-'+comment_count+'" class="open_label">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus in_progress_radio ' + temp_task_status_inprogress + '" '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'" class="in_progress_label">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus pending_radio ' + temp_task_status_pending_review + '" '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'" class="pending_label">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus complete_radio ' + temp_task_status_complete + '" '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'" class="complete_label">'+wpf_status_complete+'</label>';
        } else {
            var wpfb_task_status_html='<input id="status_open-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="open" data-elemid="'+comment_count+'" class="wpfbtaskstatus ' + temp_task_status_open + '" '+temp_task_status_open+'><label for="status_open-'+comment_count+'" class="">'+wpf_status_open_task+'</label><input id="status_progress-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="in-progress" data-elemid="'+comment_count+'" class="wpfbtaskstatus ' + temp_task_status_inprogress + '" '+temp_task_status_inprogress+' ><label for="status_progress-'+comment_count+'" class="">'+wpf_status_in_progress+'</label><input id="status_pending-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="pending-review" data-elemid="'+comment_count+'" class="wpfbtaskstatus ' + temp_task_status_pending_review + '" '+temp_task_status_pending_review+' ><label for="status_pending-'+comment_count+'" class="">'+wpf_status_pending_review+'</label><input id="status_complete-'+comment_count+'" type="radio" name="wpfbtaskstatus'+comment_count+'" value="complete" data-elemid="'+comment_count+'" class="wpfbtaskstatus ' + temp_task_status_complete + '" '+temp_task_status_complete+'><label for="status_complete-'+comment_count+'" class="">'+wpf_status_complete+'</label>';
        }

        var wpfb_messages_html='';
        for (var key in wpfb_metas.comments) {
            let new_class = "";
            let author = "";
            let author_img = "";
            let author_html = "";
            author =  wpfb_metas.comments[key].author;
            for (var usr in wpfb_users_arr) {
                if (wpfb_users_arr.hasOwnProperty(usr)) {
                    if(wpfb_users_arr[usr]['username']==wpfb_metas.comments[key].author){
                        author = wpfb_users_arr[usr]['displayname'];
                        break;
                    }
                }
            }
            author_img = wpfb_metas.comments[key].wpf_user_img;

            if(wpfb_metas.comments[key].is_log == 1){
                new_class = " is_info";
                author = "";
                author_img = plugin_url + 'images/bell.svg';
            }

            if ( author_img == '' || author_img == 'undefined') {
                author_html = author.slice(0, 2);
            } else {
                author_html = '<img src="' + author_img + '" alt="author" ></img>';
            }

            var note_class = '';
            var note_html = '';
            if( wpfb_metas.comments[key].is_note == true ){
                note_class = " is_note";
                note_html = '<small class="wpf_note_html">Note</small>';
            }

            if ( typeof wpfb_metas.comments[key].response !== 'undefined' ) {
                if ( wpfb_metas.comments[key].response.delivery_status === 'incoming' ) {
                    var task_author = "wpf_other " + new_class + note_class;
                } else {
                    var task_author = "wpf_author " + new_class + note_class;
                }
            } else {
                if(wpfb_metas.comments[key].wpf_user_id==wpfb_metas.current_user_id){
                    var task_author = "wpf_author " + new_class + note_class;
                }
                else{
                    var task_author = "wpf_other " + new_class + note_class;
                }
            }

            var files = wpfb_metas.comments[key].files;
            var files_html = get_files_html(files);

            var edited_html='';
            let edit_delete_button_html = '';
            var show_comment_id = '';
            if(wpfb_metas.comments[key].is_edited && !wpfb_metas.comments[key].is_deleted){
                edited_html='<span class="wpf-is-edited">(Edited)</span>';
            }else{
                edited_html='';
            }

            if ( ( eval(current_user_id) === eval(wpfb_metas.comments[key]['wpf_user_id']) ) && ( (!wpfb_metas.comments[key]['is_log']) && (!wpfb_metas.comments[key].is_deleted) ) ) {
                // Determine HTML for edit/delete buttons based on permissions
                edit_delete_button_html = getEditDeleteButtonHTML(key);
            }

            if( wpfb_metas.comments[key].comment_type == 0 ) {
                let  img_dwn_icon = "";
                if ( wpfb_metas.comments[key].is_note != true || (  wpfb_metas.comments[key].is_note == true && wpfb_metas.comments[key].wpf_user_id==wpfb_metas.current_user_id ) ) {
                    wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + note_html + '</div><span>' + edited_html + wpfb_metas.comments[key].time+'</span>' + edit_delete_button_html + '</level><div class="meassage_area_main"><div id="wpf-chat-text-'+key+'" class="chat_text">'+ wpfb_metas.comments[key].message +'</div>' + files_html + '</div><div id="wpfb-edit-comment-wrapper-'+key+'" class="wpfb-edit-comment-wrapper"><div class="wpf-editor"></div><textarea class="form-control wpfb-edit-comment" data-comment_id="'+key+'" placeholder="Edit the comment..." spellcheck="false">'+URLify(wpfb_metas.comments[key].message)+'</textarea><button class="wpf_edit_comment_btn" onclick="wpfb_edit_comment(\''+key+'\')">'+edit_comment_text+'</button><a class="wpf-cancel-edit-comment" onclick="wpfb_cancel_edit_comment(\''+key+'\')" href="javascript:void(0)">'+cancel_edit_comment_text+'</a><div class="wpf_update_error wpf_hide">Please post your comment before performing this action</div></div></div></div></li>';
                }
            } else if ( wpfb_metas.comments[key].comment_type == 3 ) {
                let img_dwn_icon = "";
                wpfb_messages_html += '<li class="'+task_author+'" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + note_html + '</div><span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<iframe width="100%" height="150" src="https://www.youtube.com/embed/'+wpfb_metas.comments[key].message+'"></iframe></div></div></div></li>';
            } else if ( wpfb_metas.comments[key].comment_type == 1 ) {
                wpfb_messages_html += '<li class="'+task_author+' is_image" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + note_html + '</div><span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main"><a href="'+wpfb_metas.comments[key].message+'" target="_blank">'+'</a>'+img_dwn_icon+'<img src="'+wpfb_metas.comments[key].message+'" alt="uploaded image" class="wpf_task_uploaded_image" /></div></div></div></li>';
            } else {
                var wpf_download_file  = wpfb_metas.comments[key].message.split("/").pop();
                let img_dwn_icon = "";
                wpfb_messages_html += '<li class="'+task_author+' is_file" data-comment_id="'+show_comment_id+'"><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><div class="author-name">' + author + note_html + '</div><span>'+wpfb_metas.comments[key].time+'</span></level><div class="meassage_area_main">'+img_dwn_icon+'<a href="'+wpfb_metas.comments[key].message+'" download="'+wpf_download_file+'" target="_blank"><i class="gg-software-download"></i> '+ wpf_download_file+'</a></div></div></div></li>';
            }
        }

        if(wpfb_metas.task_page_title == null){
            wpfb_metas.task_page_title = "";
        }

	   var is_new_start = "";

        var wpfb_current_page_task_list_html = '<li class="current_page_task '+wpfb_metas.task_status+' '+custom_status_class+' '+wpfb_metas.task_priority+'" data-taskid="'+comment_count+'" data-postid="'+wpfb_task_id+'"><div class="wpf_task_number" title="'+wpf_remap_text+'">'+bubble_label+'</div><div class="wpf_task_sum"><level class="task-author">'+wpfb_metas.task_config_author_name+'<span>'+wpfb_metas.task_time+'</span></level><div class="current_page_task_list">'+wpfb_metas.task_title+'</div></div><div class="wpf_task_meta"><div class="wpf_task_meta_icon"><i class="gg-chevron-left"></i></div><div class="wpf_task_meta_details">'+wpf_task_status_label+wpf_task_priority_label+wpfb_tags_html+'</div></div></li>';
        add_popover_content(0,comment_count,wpfb_task_id,wpfb_metas,wpfb_users_html,wpfb_task_priority_html,wpfb_task_status_html,wpfb_messages_html);
    }

    /* After page load, when user clicks on any sticker, it will scroll to at the bottom of the comments => v2.1.0, v2.1.1 */
    jQuery_WPF('#task_comments_' + wpfb_metas.wpf_task_id).animate({scrollTop: jQuery_WPF('#task_comments_' + wpfb_metas.wpf_task_id).prop("scrollHeight")}, 2000);
}
function add_popover_content(wpf_task_type, comment_count, wpfb_task_id, wpfb_metas, wpfb_users_html, wpfb_task_priority_html, wpfb_task_status_html, wpfb_messages_html) {
    var wpf_hide = '';
    if (wpf_task_type == 2 || wpf_task_type == 3) {
        curr_browser_temp = get_browser();
        browser = curr_browser_temp['name'] + ' ' + curr_browser_temp['version'];
        var wpf_config_resolution = resolution;
        var wpf_config_browser = browser;
        var wpf_config_author_name = current_user_name;
        if (wpfb_task_id != 0) {
            var wpf_config_task_id = wpfb_task_id;
        } else {
            var wpf_config_task_id = '';
        }
    } else if (wpf_task_type == 1) {
        var wpf_config_resolution = resolution;
        var wpf_config_browser = browser;
        var wpf_config_author_name = current_user_name;
        var wpf_config_task_id = '';
        var element_center = getelementcenter(rightArrowParents.join(" > "));
        element_center['left'] = element_center['left'] - 25;
        element_center['top'] = element_center['top'] - 25;
    } else {
        var wpf_config_resolution = wpfb_metas.task_config_author_resX + ' x ' + wpfb_metas.task_config_author_resY;
        var wpf_config_browser = wpfb_metas.task_config_author_browser;
        var wpf_config_author_name = wpfb_metas.task_config_author_name;
        var wpf_config_task_id = wpfb_task_id;
        var element_center = getelementcenter(wpfb_metas.wpfb_task_bubble);
    }

    var tabs_html = '<div class="tab-content" id="myTabContent-' + comment_count + '">';
    var wpf_all_tags_html = '';
    if (wpf_current_role == 'advisor') {
	    wpf_all_tags_html = '<div class="wpf_icon_title"><i class="gg-tag"></i> ' + wpf_custom_tags + '</div><div class="wpf_tag_autocomplete"><input type="text" name="wpfeedback_tags" class="wpf_tag" value="" id="wpfeedback_tags_' + wpf_config_task_id + '" data-id="' + wpf_config_task_id + '" data-commentid="' + comment_count + '" onkeydown="wpf_search_tags(this,' + wpf_config_task_id + ')"><button class="wpf_tag_submit_btn" onclick="wpf_add_tag(\'wpfeedback_tags_' + wpf_config_task_id + '\')"><i class="gg-corner-down-left"></i></button></div><div id="all_tag_list_' + wpf_config_task_id + '">' + wpf_tag_html + '</div>';
    }
        tabs_html += '<div class="tab-pane" id="wpfbsysinfo-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbsysinfo-tab">' + wpf_all_tags_html + '<ul><li><b>' + wpf_resolution + '</b> <span id="wpfbsysinfo_resolution-' + comment_count + '">' + wpf_config_resolution + '</span></li><li><b>' + wpf_browser + '</b> <span id="wpfbsysinfo_browser-' + comment_count + '">' + wpf_config_browser + '</span></li><li><b>' + wpf_user_name + '</b> <span id="wpfbsysinfo_user_name-' + comment_count + '">' + wpf_config_author_name + '</span></li><li><b>' + wpf_task_id + '</b> <span id="wpfbsysinfo_task_id-' + comment_count + '">' + wpf_config_task_id + '</span></li>';

    if (wpf_task_type == 1 || wpf_task_type == 2) {
	    tabs_html += '<li id="wpf_delete_container_' + comment_count + '"><span class="wpfbsysinfo_temp_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_temp_delete_btn" style="color:red;" data-btn_elemid="' + comment_count + '"  ><i class="gg-trash"></i> ' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_temp_delete_task_id_' + comment_count + ' wpf_hide" >' + wpf_delete_conform_text1 + ' ' + wpf_delete_conform_text2 + '<a href="javascript:void(0)" class="wpf_task_temp_delete" data-elemid="' + comment_count + '" style="color:red;"> ' + wpf_yes + '</a></p></li>';
    } else {
        if (wpf_tab_permission.delete_task == 'yes') {
            tabs_html += '<li><span class="wpfbsysinfo_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_delete_btn" data-btn_taskid="' + wpfb_task_id + '" style="color:red;"><i class="gg-trash"></i>' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_delete_task_id_' + wpfb_task_id + ' wpf_hide" ><b>' + wpf_delete_conform_text1 + '</b><br>' + wpf_delete_conform_text2 + ' <a href="javascript:void(0)" class="wpf_task_delete" data-taskid="' + wpfb_task_id + '" data-elemid="' + comment_count + '" style="color:red;"><b>' + wpf_yes + '</b></a></p></li>';
        } else if (wpf_tab_permission.delete_task == 'no') {
            if (wpfb_metas.task_config_author_id == current_user_id) {
            tabs_html += '<li><span class="wpfbsysinfo_delete_btn_task_id_' + comment_count + '"><a href="javascript:void(0)" class="wpf_task_delete_btn" data-btn_taskid="' + wpfb_task_id + '" style="color:red;"><i class="gg-trash"></i> ' + wpf_delete_ticket + '</a></span><p class="wpfbsysinfo_delete_task_id_' + wpfb_task_id + ' wpf_hide" ><b>' + wpf_delete_conform_text1 + '</b><br>' + wpf_delete_conform_text2 + ' <a href="javascript:void(0)" class="wpf_task_delete" data-taskid="' + wpfb_task_id + '" data-elemid="' + comment_count + '" style="color:red;"><b>' + wpf_yes + '</b></a></p></li>';
            }
        }
    }

    tabs_html += '</ul></div>';
    if (wpf_task_type == 3) {
        if (wpfb_task_id != 0) {
            var task_link_div = '<div class="wpf_task_link_' + wpfb_task_id + '">';
            var task_link = current_page_url + '?wpf_general_taskid=' + wpfb_task_id + '&wpf_login=1';
            var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + wpfb_task_id + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + wpfb_task_id + '","general")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + wpfb_task_id + '"> ' + wpf_remove_login_parameter + '</label></div>';
        } else {
            var task_link_div = '<div class="wpf_task_link_">';
            var task_link = current_page_url + '?wpf_general_taskid=' + wpfb_task_id + '&wpf_login=1';
            var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + wpfb_task_id + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + wpfb_task_id + '","general")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + wpfb_task_id + '"> ' + wpf_remove_login_parameter + '</label></div>';
        }
    } else {
        if (wpfb_task_id != 0) {
            var task_link_div = '<div class="wpf_task_link_' + comment_count + '">';
            var task_link = current_page_url + '?wpf_taskid=' + comment_count + '&wpf_login=1';
            var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + comment_count + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + comment_count + '","normal")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + comment_count + '">' + wpf_remove_login_parameter + '</label></div>';
        } else {
            var wpf_remove_login_checkbox = '<div class="wpf_remove_login_box"><input type="checkbox" id="wpf_remove_login_task_link' + comment_count + '" class="wpf_remove_login_task_link wpf_checkbox" onclick=\'wpf_remove_login_to_clipboard("' + comment_count + '","normal")\'><label class="wpf_remove_login_label wpf_checkbox_label" for="wpf_remove_login_task_link' + comment_count + '">' + wpf_remove_login_parameter + '</label></div>';
            var task_link_div = '<div class="wpf_task_link_">';
            var task_link = current_page_url + '?wpf_taskid=' + comment_count + '&wpf_login=1';
        }
    }

    tabs_html += '<div class="tab-pane" id="sharetasklink-' + comment_count + '" role="tabpanel" aria-labelledby="sharetasklink-tab"><div class="wpf_icon_title">' + wpf_share_task_link + ' </div><input type="text" id="wpf_share_link_' + wpfb_task_id + '" value="' + task_link + '" style="position: absolute; z-index: -999; opacity: 0;"><span class="wpf_share_task_link">' + task_link_div + task_link + '</div><a href="javascript:void(0);" onclick=\'wpf_copy_to_clipboard("wpf_share_link_' + wpfb_task_id + '")\' class="wpf_copy_task_icon" style="display: inline-block;"><i class="gg-copy"></i></a><span class="wpf_success_wpf_share_link" id="wpf_success_wpf_share_link_' + wpfb_task_id + '" style="display: none;">The link was copied to your clipboard.</span></span>' + wpf_remove_login_checkbox + '</div>';

    tabs_html += '<div class="tab-pane" id="wpfbuser-' + comment_count + '" role="tabpanel" aria-labelledby="home-tab">' + wpfb_users_html + '</div>';
    var wpf_screenshot = '';
    if (wpfb_metas.wpf_task_screenshot != undefined) {
	    wpf_screenshot = '<a target="_blank" href="' + wpfb_metas.wpf_task_screenshot + '" class="wpf_screenshot_img_link"><img src="' + wpfb_metas.wpf_task_screenshot + '" id="screenshot_img_' + comment_count + '" alt="screenshot" style="margin-top:10px; border:1px solid #dee2e6;padding: 5px;width: 100%;" /></a>';
    } else {
	    wpf_screenshot = '<a target="_blank" href="#" class="wpf_screenshot_img_link"><img src="#" id="screenshot_img_' + comment_count + '" alt="screenshot" style="margin-top:10px; border:1px solid #dee2e6;padding: 5px; display: none;width: 100%;" /></a>';
    }
    if (wpf_task_type == 1 || wpf_task_type == 2) {

        if (wpf_tab_permission.display_stickers == 'yes') {
            tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider"><input id="priority_low-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="low" class="wpfbpriority low_radio" checked><label for="priority_low-' + comment_count + '" class="low_label">' + wpf_priority_low + '</label><input id="priority_medium-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="medium" class="wpfbpriority medium_radio"><label for="priority_medium-' + comment_count + '" class="medium_label">' + wpf_priority_medium + '</label><input id="priority_high-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="high" class="wpfbpriority high_radio"><label for="priority_high-' + comment_count + '" class="high_label">' + wpf_priority_high + '</label><input id="priority_critical-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="critical" class="wpfbpriority critical_radio"><label for="priority_critical-' + comment_count + '" class="critical_label">' + wpf_priority_critical + '</label></div></div>';
            tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider"><input id="status_open-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="open" data-elemid="' + comment_count + '" class="wpfbtaskstatus open_radio" checked><label for="status_open-' + comment_count + '" class="open_label">' + wpf_status_open_task + '</label><input id="status_progress-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="in-progress" data-elemid="' + comment_count + '" class="wpfbtaskstatus in_progress_radio" ><label for="status_progress-' + comment_count + '" class="in_progress_label">' + wpf_status_in_progress + '</label><input id="status_pending-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="pending-review" data-elemid="' + comment_count + '" class="wpfbtaskstatus pending_radio" ><label for="status_pending-' + comment_count + '" class="pending_label">' + wpf_status_pending_review + '</label><input id="status_complete-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="complete" data-elemid="' + comment_count + '" class="wpfbtaskstatus complete_radio" ><label for="status_complete-' + comment_count + '" class="complete_label">' + wpf_status_complete + '</label></div></div>';
        } else {
            tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider"><input id="priority_low-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="low" class="wpfbpriority" checked><label for="priority_low-' + comment_count + '">' + wpf_priority_low + '</label><input id="priority_medium-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="medium" class="wpfbpriority"><label for="priority_medium-' + comment_count + '">' + wpf_priority_medium + '</label><input id="priority_high-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="high" class="wpfbpriority"><label for="priority_high-' + comment_count + '">' + wpf_priority_high + '</label><input id="priority_critical-' + comment_count + '" type="radio" name="wpfbpriority' + comment_count + '" data-elemid="' + comment_count + '" value="critical" class="wpfbpriority"><label for="priority_critical-' + comment_count + '">' + wpf_priority_critical + '</label></div></div>';
            tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider"><input id="status_open-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="open" data-elemid="' + comment_count + '" class="wpfbtaskstatus" checked><label for="status_open-' + comment_count + '">' + wpf_status_open_task + '</label><input id="status_progress-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="in-progress" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_progress-' + comment_count + '">' + wpf_status_in_progress + '</label><input id="status_pending-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="pending-review" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_pending-' + comment_count + '">' + wpf_status_pending_review + '</label><input id="status_complete-' + comment_count + '" type="radio" name="wpfbtaskstatus' + comment_count + '" value="complete" data-elemid="' + comment_count + '" class="wpfbtaskstatus" ><label for="status_complete-' + comment_count + '">' + wpf_status_complete + '</label></div></div>';
        }

	    tabs_html += '<div class="tab-pane" id="wpfbscreenshot-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbscreenshot-tab"><a href="javascript:void(0)" onclick="screenshot(' + comment_count + ');"><div class="wpf_screenshot_button">' + wpf_screenshot_view + '</div></a>' + wpf_screenshot + '</div><div  id="task_comments_section_' + comment_count + '"><ul class="wpf_current_chat_box scrollbar-outer" id="task_comments_' + comment_count + '"></ul></div>';
    } else {
        tabs_html += '<div class="tab-pane" id="wpfbpriority-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbpriority-tab"><div class="anim-slider">' + wpfb_task_priority_html + '</div></div>';
        tabs_html += '<div class="tab-pane" id="wpfbtaskstatus-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbtaskstatus-tab"><div class="anim-slider">' + wpfb_task_status_html + '</div></div>';
        tabs_html += '<div class="tab-pane" id="wpfbscreenshot-' + comment_count + '" role="tabpanel" aria-labelledby="wpfbscreenshot-tab"><a href="javascript:void(0)" onclick="screenshot(' + comment_count + ');"><div class="wpf_screenshot_button">' + wpf_screenshot_view + '</div></a>' + wpf_screenshot + '</div><div id="task_comments_section_' + comment_count + '"><ul class="wpf_current_chat_box scrollbar-outer" id="task_comments_' + comment_count + '">' + wpfb_messages_html + '</ul></div>';
    }

    tabs_html += '</div>';
    jQuery("#myTab-"+comment_count).after(tabs_html);
    jQuery("#myTabContent-"+comment_count).find('.wpf-editor').each(function() {
        if ( ! jQuery_WPF(this).hasClass('activee') ) {
            var $this = jQuery_WPF(this);
            jQuery_WPF(this).addClass('activee');
            $c_id = jQuery_WPF(this).data('id');
            var quill = new Quill(this, {
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['link', 'code-block'],
                    ]
                },
                placeholder: '',
                theme: 'bubble'   // Specify theme in configuration
            });
            quill.on('text-change', function(delta, oldDelta, source) {
                var isempty = isQuillEmpty( quill );
                if ( !isempty ) {
                    $this.closest('.wpf-comment-container').find('textarea').val(quill.root.innerHTML);
                } else {
                    $this.closest('.wpf-comment-container').find('textarea').val('');
                }
            });
            $this.on('keydown', function(event) {
                // Check if the pressed key is Enter (keyCode 13 or key "Enter")
                if ( (event.keyCode == 13 || event.key === "Enter") && !event.shiftKey ) {
                    $this.closest('.wpf-comment-container').find('.wpf_comment_btn.task_comment').trigger('click');
                }
            });
            setTimeout(() => { 
                quill.focus();
            },100);
        }
    });
}
function close_popover(comment_count){
    // This actually trigger the same function that opens the popup.
    // passed a value while the close button clicked on the triggred function so that it can determine
    // when close button clicked, ignore rest of the function => v2.1.1
    jQuery_WPF('#bubble-'+comment_count)[0].click();
}
function new_task_screenshot( id, base64URL ){
    const rollSound = new Audio(wpf_screenshot_sound);
    if(tasks_on_page[id] > 0) {
        task_screenshot['post_id'] = tasks_on_page[id];
        task_screenshot['task_config_author_name'] = current_user_name;
        task_screenshot['task_config_author_id'] = current_user_id;
        var new_task_screenshot_obj = jQuery_WPF.extend({}, task_screenshot);
        jQuery_WPF.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {action:'wpfb_save_screenshot',wpf_nonce:wpf_nonce,task_screenshot:new_task_screenshot_obj, image: base64URL, autoscreen:1},
            success: function(data){
                jQuery_WPF('#screenshot_img_'+id).parent().attr('href', data);
                jQuery_WPF('#screenshot_img_'+id).attr('src', data);
                jQuery_WPF('#screenshot_img_'+id).show();
            }
        });
    } else {
        jQuery_WPF('#wpf_error_'+id).hide();
        //jQuery_WPF('#wpf_task_error_'+id).show();
    }
}
function wpf_delete_comment( comment_id ) {
    var task_info = [];

    task_info['comment_id'] = comment_id;
    task_info['from_wp'] = true;

    var task_info_obj = jQuery_WPF.extend({}, task_info);

    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {
            action: "wpf_delete_comment",
            wpf_nonce: wpf_nonce,
            task_info: task_info_obj
        },
        beforeSend: function(){
        },
        success : function(data){
            data = JSON.parse( data );
            jQuery_WPF("#wpf-chat-text-"+comment_id).html(data['comment']);
            jQuery_WPF("#wpfb-edit-comment-wrapper-"+comment_id).hide();

            // remove the edit delete UI
            jQuery_WPF("#wpf-chat-text-"+comment_id).closest('li.wpf_author').find('div.wpf-edit-delete-wrapper').remove();
        }
    });
}
jQuery_WPF(document).on('click', '.wpfbpriority', function(e){
    var id = jQuery_WPF(this).attr('data-elemid');
    var task_priority = jQuery_WPF(this).val();
    var previous_prio = jQuery_WPF(this).closest('.anim-slider').find('.checked').val();
    jQuery_WPF('.wpfbpriority').removeClass('checked');
    jQuery_WPF(this).addClass('checked');
    set_task_prioirty(id, task_priority, previous_prio);
    e.stopImmediatePropagation();
});
function set_task_prioirty(id, task_priority, previous_prio = 'low') {
    var task_info = [];
    let custom_status_class = '';

    task_info['task_id'] = tasks_on_page[id];
    task_info['task_priority'] = task_priority;
    task_info['method'] = 'priority';

    var task_info_obj = jQuery_WPF.extend({}, task_info);
    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {action: "wpfb_set_task_priority",wpf_nonce:wpf_nonce,task_info:task_info_obj},
        beforeSend: function() {
            jQuery_WPF('.wpf_loader_'+id).hide();
            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").removeClass('low').removeClass('medium').removeClass('high').removeClass('critical');
            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").addClass(task_priority);
            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").find('span.sticker').removeAttr('class').addClass('sticker');
            if(wpf_tab_permission.display_stickers == 'yes'){
                custom_status_class = task_priority+'_custom';
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").find('span.sticker').addClass(task_priority).addClass(custom_status_class).addClass('sticker');
                jQuery_WPF('#bubble-'+id+'  span.sticker').removeAttr('class').addClass('sticker');
                jQuery_WPF('#bubble-'+id+'  span.sticker').addClass(custom_status_class);
            }
            author_img = plugin_url + 'images/bell.svg';
            author_html = '<img src="' + author_img + '" alt="author" ></img>';
            var data = to_capitalize(logged_user.author) + ' marked as <span class="taskStatusMsg task-content">' + task_priority + '</span> from ' + to_capitalize(previous_prio);
            jQuery_WPF("#task_comments_"+id).append('<li class="wpf_author is_info" data-comment_id=""><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><span>1s</span></level><div class="meassage_area_main"><div class="chat_text">'+data+'</div></div></div></div></li>');

            // update the status on the sidebar task item
            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']").closest('li').find('span.priority').attr('title','Priority : '+task_priority);

            const $li = jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']");

            // clear old priority class from the element
            if ( $li.hasClass('low') ) {
                $li.removeClass('low');
            } else if ($li.hasClass('high')) {
                $li.removeClass('high');
            } else if ( $li.hasClass('medium') ) {
                $li.removeClass('medium');
            } else {
                $li.removeClass('critical');
            }

            // add new priority class to the element
            $li.addClass(task_priority);

            // fix scroll to bottom when status update => v2.1.0
            jQuery_WPF('#task_comments_'+id).animate({scrollTop: jQuery_WPF('#task_comments_'+id).prop("scrollHeight")}, 2000);
        },
        success : function(data){            
        }
    });
}
jQuery_WPF(document).on( 'click', '.wpfbtaskstatus', function(e){
    var id = jQuery_WPF(this).attr('data-elemid');
    var task_status = jQuery_WPF(this).val();
    var previous_status = jQuery_WPF(this).closest('.anim-slider').find('.checked').val();
    jQuery_WPF('.wpfbtaskstatus').removeClass('checked');
    jQuery_WPF(this).addClass('checked');
    set_task_status(id, task_status, previous_status);
    e.stopImmediatePropagation();
});
function set_task_status(id, task_status, previous_status = 'open'){
    var task_info = [];
    var task_notify_users = [];
    var task_comment = jQuery_WPF('#comment-'+id).val();
    jQuery_WPF.each(jQuery_WPF('input[name=author_list_'+id+']:checked'), function(){
        task_notify_users.push(jQuery_WPF(this).val());
    });
    task_notify_users = task_notify_users.join(",");
    let custom_status_class = '';

    task_info['task_id'] = tasks_on_page[id];
    task_info['task_status'] = task_status;
    task_info['task_notify_users'] = task_notify_users;
    task_info['method'] = 'status';

    var task_info_obj = jQuery_WPF.extend({}, task_info);
    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {
            action: "wpfb_set_task_status",
            wpf_nonce: wpf_nonce,
            task_info: task_info_obj
        },
        beforeSend: function() {
            var status_class_str = "";
            if(wpf_tab_permission.display_stickers == 'yes') {
                status_class_str = " "+task_status+"_custom";
            }
            if(jQuery_WPF('#wpf_mark_internal_'+id).hasClass('wpf_is_internal')) {
                internal_icon=internal_icon_html;
            } else {
                internal_icon='';
            }
            var view_id='<span class="wpf_bubble_num_wrapper">'+jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number,#wpf_backend [data-taskid='" + id + "'] .wpf_task_number").attr("data-disp-id")+'</span>'+internal_icon;

            var view_id_sidebar='<span class="wpf_bubble_num_wrapper">'+jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number,#wpf_backend [data-taskid='" + id + "'] .wpf_task_number").attr("data-disp-id")+'</span>';

            if(task_status == 'complete'){
                let display_check_mark = '';
                 if(wpf_tab_permission.display_task_id != 'yes'){
                     display_check_mark = '<i class="gg-check"></i>';
                }else{
                    display_check_mark = view_id;
                }
                
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'],#wpf_allpages [data-taskid='" + id + "']").removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom');
                
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'],#wpf_allpages [data-taskid='" + id + "']").addClass(task_status+status_class_str);
                let task_priority = jQuery_WPF('input[name=wpfbpriority'+id+']:checked').val();

                if(wpf_tab_permission.display_stickers == 'yes'){
                    jQuery_WPF('#bubble-'+id).html('<span class="sticker '+task_priority+' '+task_priority+'_custom"></span> '+display_check_mark);
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").html('<span class="sticker '+task_priority+' '+task_priority+'_custom"></span> '+display_check_mark);
                }else{
                    jQuery_WPF('#bubble-'+id).html(display_check_mark);
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number,#wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").html(display_check_mark);
                }
                jQuery_WPF('#bubble-'+id).removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom').addClass(task_status+' '+status_class_str);
                jQuery_WPF('#bubble-'+id).css('display',"block");

                // checked the mark complete checkbox
                jQuery_WPF("#mark_complete_" + id).attr("checked", true);
            } else {
                let task_priority = jQuery_WPF('input[name=wpfbpriority'+id+']:checked').val();
                jQuery_WPF('#bubble-'+id).removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom').addClass(task_status+' '+status_class_str);
                jQuery_WPF('#bubble-'+id).find('.gg-check').remove();
                if(jQuery_WPF('#bubble-'+id).find('span .'+task_priority).length == 0 && wpf_tab_permission.display_stickers == 'yes'){
                    jQuery_WPF('#bubble-'+id).html('<span class="sticker '+task_priority+' '+task_priority+'_custom"></span>'+view_id);
                } else {
                    jQuery_WPF('#bubble-'+id).html(view_id);
                }
                if(jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number, #wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").find('span .'+task_priority).length == 0 && wpf_tab_permission.display_stickers == 'yes'){
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number, #wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").html('<span class="sticker '+task_priority+' '+task_priority+'_custom"></span>'+view_id_sidebar);
                } else {
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_task_number, #wpf_allpages [data-taskid='" + id + "'] .wpf_task_number").html(view_id_sidebar);
                }
                
                jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']").removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom');

                if(wpf_tab_permission.display_stickers == 'yes'){
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']").addClass(task_status+' '+task_status+'_custom');    
                } else {
                    jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']").addClass(task_status);
                }

                // unchecked the mark complete checkbox
                jQuery_WPF("#mark_complete_" + id).attr("checked", false);
            }
            author_img = plugin_url + 'images/bell.svg';
            author_html = '<img src="' + author_img + '" alt="author" ></img>';
            var data = to_capitalize(logged_user.author) + ' marked as <span class="taskStatusMsg task-content">' + task_status + '</span> from ' + to_capitalize(previous_status);
            jQuery("#task_comments_"+id).append('<li class="wpf_author is_info" data-comment_id=""><div class="wpf-comment-container"><div class="wpf-author-img">' + author_html + '</div><div class="wpf-comment-wrapper"><level class="task-author"><span>1s</span></level><div class="meassage_area_main"><div class="chat_text">'+data+'</div></div></div></div></li>');

            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'], #wpf_allpages [data-taskid='" + id + "']").closest('li').find('span.task_status').attr('title','Status : '+task_status);

            // fix scroll to bottom when status update => v2.1.0
            jQuery_WPF('#task_comments_'+id).animate({scrollTop: jQuery_WPF('#task_comments_'+id).prop("scrollHeight")}, 2000);
        },
        success : function(data) {
        }
    });
}
jQuery_WPF(document).on( 'click', '.wpfbtasknotifyusers', function(e){
    var id = jQuery_WPF(this).attr('data-elemid');
    set_task_notify_users(id);
});
function set_task_notify_users(id) {
    var task_info = [];
    var task_notify_users = [];
    var task_notify_usernames = [];
    jQuery_WPF.each(jQuery_WPF('input[name=author_list_'+id+']:checked'), function(){
        task_notify_users.push(jQuery_WPF(this).val());
        task_notify_usernames.push(jQuery_WPF(this).data('wp-usrn'));
    });
    task_notify_users = task_notify_users.join(",");
    task_info['task_id'] = tasks_on_page[id];
    task_info['task_notify_users'] = task_notify_users;
    var task_info_obj = jQuery_WPF.extend({}, task_info);

    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {
            action : "wpfb_set_task_notify_users",
            wpf_nonce: wpf_nonce,
            task_info: task_info_obj
        },
        beforeSend: function(){
            var user_html = '';
            if( Object.keys(task_notify_usernames).length > 0 ) {
                jQuery_WPF.each( task_notify_usernames, function (index, value) {
                    user_html += '<span class="wpf_user_avat">' + value.slice(0, 2) + '</span>';
                });
            }
            jQuery_WPF(document).find("#wpf_thispage [data-taskid='" + id + "'] .wpf_user_avatar, #wpf_allpages [data-taskid='" + id + "'] .wpf_user_avatar").html(user_html);
        },
        success : function(data){
        }
    });
}
jQuery_WPF(document).on( 'click', '.wpf_task_delete_btn', function(e){
    var btn_taskid = jQuery_WPF(this).attr('data-btn_taskid');
    jQuery_WPF('.wpfbsysinfo_delete_task_id_'+btn_taskid).removeClass('wpf_hide');
});
jQuery_WPF(document).on( 'click', '.wpf_task_delete', function(e){
    var id = jQuery_WPF(this).data('elemid');
    var task_id = jQuery_WPF(this).data('taskid');
    wpf_delete_task(id, task_id);
});
function wpf_is_valid_url( string ) {
    regexp = /^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/;
    if ( regexp.test( string ) ) {
        return true;
    } else {
        return false;
    }
}
function wpf_is_valid_video_url( string ) {
    var regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=|\?v=)([^#\&\?]*).*/;
    var match = string.match(regExp);
    if ( match && match[2].length == 11 ) {
        return '<iframe width="100%" height="150" src="https://www.youtube.com/embed/' + match[2] + '" type="text/html" width="500" height="265" frameborder="0" allowfullscreen></iframe>';
    } else {
        return string;
    }
}
function wpf_edit_box_active(comment_id){
    var com_html = jQuery_WPF( '#wpf-chat-text-' + comment_id ).html();
    jQuery_WPF( '#wpfb-edit-comment-wrapper-' + comment_id + ' .wpf-editor .ql-editor').html(com_html);
    jQuery_WPF("#wpfb-edit-comment-wrapper-"+comment_id).show();
}
function wpfb_cancel_edit_comment(comment_id){
    jQuery_WPF("#wpfb-edit-comment-wrapper-"+comment_id).hide();
}
jQuery_WPF(document).find("#wpf_thispage").on("click","li.current_page_general_task",function(e) {
    var taskid = jQuery_WPF(this).data('taskid');
    jQuery_WPF('#wpf_thispage li.current_page_task .wpf_task_sum').parent().removeClass('wpf_active');
    jQuery_WPF('#wpf_thispage li.current_page_general_task .wpf_task_sum').parent().removeClass('wpf_active');
    jQuery_WPF(this).parent().addClass('wpf_active');
    wpf_load_general_task(taskid);
    setup_upload_file(taskid);
});
jQuery_WPF(document).find("#wpf_allpages_container_today,#wpf_allpages_container_yesterday,#wpf_allpages_container_this_week,#wpf_allpages_container_this_month,#wpf_allpages_container_year,#wpf_allpages_container_other").on("click","li.current_page_task",function(e) {
    var task_url = jQuery_WPF(this).attr('data-task_url');
    window.location.assign(task_url);
});
jQuery_WPF(document).find("#wpf_allpages_container_today,#wpf_allpages_container_yesterday,#wpf_allpages_container_this_week,#wpf_allpages_container_this_month,#wpf_allpages_container_year,#wpf_allpages_container_other").on("click","li.current_page_general_task",function(e) {
    var taskid = jQuery_WPF(this).data('taskid');
    wpf_load_general_task(taskid);
    setup_upload_file(taskid);
});
jQuery_WPF(document).find("#wpf_thispage").on("click","li.current_page_task .wpf_task_number",function(e) {
    e.stopPropagation();
    jQuery_WPF('#wpf_reconnecting_enabled').show().delay(2000).fadeOut();
    wpf_reconnect_taskid = jQuery_WPF(this).parents('li').data('postid');
    wpf_reconnect_tasknumber = jQuery_WPF(this).parents('li').data('taskid');
    wpf_reconnect = true;
});
jQuery_WPF(document).find("#wpf_thispage").on("click","li.current_page_general_task .wpf_task_number",function(e) {
    e.stopPropagation();
    jQuery_WPF('#wpf_reconnecting_enabled').show().delay(2000).fadeOut();
    wpf_reconnect_taskid = jQuery_WPF(this).parents('li').data('postid');
    wpf_reconnect_tasknumber = jQuery_WPF(this).parents('li').data('taskid');
    wpf_reconnect = true;
});
jQuery_WPF(document).on('click', '.wpf_upload_button', function() {
    jQuery_WPF('.wpf_multifile_wrapper').show();
});
jQuery_WPF(document).on('click', '.wpf_multifile_close, .wpf_multifile_cancel', function() {
    jQuery_WPF('.wpf_uploadfile').val('');
    jQuery_WPF('.wpf_selectedfile_list').html('');
    jQuery_WPF('.wpf_multifile_wrapper').hide();
    temp_selected_files = [];
});
var temp_files = [];
jQuery_WPF(document).on('click', '.wpf_multifile_submit', function() {
    if( jQuery_WPF(this).hasClass('wpf_multifile_submit_disabled') == false ) {
        allFiles = allFiles.concat(temp_selected_files);
        var len = allFiles.length;
        temp_files = [];
        if(allFiles.length > 0) {
            allFiles.forEach(function(file) {
                var reader = new FileReader();
                reader.onload = (function(file) {
                    return function(e) {
                        temp_files.push({ name: 'temp_' + file.name, type: file.type, size: file.size, url: e.target.result });
                    };
                })(file);
                reader.readAsDataURL(file)
            });
        }
        show_total_file_count(len);
        setTimeout(function () {
            get_files_preview_html(temp_files);
        }, 500);
        jQuery_WPF('.wpf_multifile_wrapper').hide();
        temp_selected_files = [];
        display_selected_files(temp_selected_files);
    }
});
function get_files_html(files) {
    var files_html = '';
    if( files.length > 0 ) {
        img_html = '';
        docu_html = '';
        each_img_html = '';
        each_docu_html = '';
        has_img = false;
        has_docu = false;
        jQuery_WPF.each(files, function(index, value) {
            var file_name = value.name.split('_')[1];
            var file_size = get_file_size(value.size);
            var bg_class = '';
            if( value.type == 'image/png' || value.type == 'image/jpeg' || value.type == 'image/gif' ) {
                has_img = true;
                each_img_html += '<div class="wpf_comment_each_img wpf_uploaded_doc"><img src="' + value.url + '" alt="file upload"><div class="wpf_file_icons" data-file-id="' + value.id + '">' + preview_image_icon + delete_icon + '</div></div>';
            } else {
                has_docu = true;
                if( value.type == 'application/pdf' ) {
                    src = plugin_url + 'images/pdf.svg';
                    bg_class = 'pdf';
                } else if( value.type == 'text/plain' ) {
                    src = plugin_url + 'images/txt.svg';
                    bg_class = 'txt';
                }  else if( value.type == 'application/x-zip-compressed' ) {
                    src = plugin_url + 'images/zip.svg';
                    bg_class = 'zip';
                } else if( value.type == 'video/mp4' ) {
                    src = plugin_url + 'images/video.svg';
                    bg_class = 'txt';
                } else {
                    src = plugin_url + 'images/docs.svg';
                }
                each_docu_html += '<div class="wpf_comment_each_doc wpf_uploaded_doc"><div class="wpf_doc_container"><div class="wpf_doc_img_container ' + bg_class + '"><img src="' + src + '" alt="file upload"></div><div class="wpf_doc_meta_container"><div class="wpf_doc_name" data-link="' + value.url + '">' + file_name + '</div><span class="wpf_doc_size">' + file_size + '</span></div></div><div class="wpf_file_icons" data-file-id="' + value.id + '">' + download_file_icon + delete_icon + '</div></div>';
            }
        });
        if( has_img ) {
            img_html = '<div class="wpf_comment_images">' + each_img_html + '</div>';
        }
        if( has_docu ) {
            docu_html = '<div class="wpf_comment_documents">' + each_docu_html + '</div>';
        }
        files_html += '<div class="wpf_comment_files_wrapper">' + img_html + docu_html + '</div>';
    }
    return files_html;
}
function get_files_preview_html(files) {
    if( files.length > 0 ) {
        img_html = '';
        docu_html = '';
        each_img_html = '';
        each_docu_html = '';
        has_img = false;
        has_docu = false;
        jQuery_WPF.each(files, function(index, value) {
            var file_name = value.name.split('_')[1];
            var file_size = get_file_size(value.size);
            var bg_class = '';
            if( value.type == 'image/png' || value.type == 'image/jpeg' || value.type == 'image/gif' ) {
                has_img = true;
                each_img_html += '<div class="wpf_each_upload_img_preview  wpf_each_file_parent"><img src="' + value.url + '" class="wpf_upload_img_preview" alt="file upload"><span class="wpf_upload_prev_delete" data-id="' + index + '">' + image_close_icon + '</span></div>';
            } else {
                has_docu = true;
                if( value.type == 'application/pdf' ) {
                    src = plugin_url + 'images/pdf.svg';
                    bg_class = 'pdf';
                } else if( value.type == 'text/plain' ) {
                    src = plugin_url + 'images/txt.svg';
                    bg_class = 'txt';
                } else if( value.type == 'application/x-zip-compressed' ) {
                    src = plugin_url + 'images/zip.svg';
                    bg_class = 'zip';
                } else if( value.type == 'video/mp4' ) {
                    src = plugin_url + 'images/video.svg';
                    bg_class = 'txt';
                } else {
                    src = plugin_url + 'images/docs.svg';
                }
                each_docu_html += '<div class="wpf_comment_each_doc wpf_each_file_parent"><div class="wpf_doc_container"><div class="wpf_doc_img_container ' + bg_class + '"><img src="' + src + '" alt="file upload"></div><div class="wpf_doc_meta_container"><div class="wpf_doc_name" data-link="' + value.url + '">' + file_name + '</div><span class="wpf_doc_size">' + file_size + '</span></div></div><span class="wpf_upload_prev_delete" data-id="' + index + '">' + image_close_icon + '<span></div>';
            }
        });
        if( has_img ) {
            img_html = '<div class="wpf_upload_image_preview">' + each_img_html + '</div>';
        }
        if( has_docu ) {
            docu_html = '<div class="wpf_upload_doc_preview">' + each_docu_html + '</div>';
        }
        if(has_img || has_docu) {
            jQuery_WPF('.wpf_upload_file_view_container').html(img_html + docu_html);
            jQuery_WPF('.wpf_upload_file_view_wrapper').show();
        } else {
            jQuery_WPF('.wpf_upload_file_view_container').html('');
            jQuery_WPF('.wpf_upload_file_view_wrapper').hide();
        }
        jQuery_WPF('.form-group').find('.wpf_comment_btn, .wpf_mark_note').removeClass('disabled');
    } else {
        jQuery_WPF('.wpf_upload_file_view_container').html('');
        jQuery_WPF('.wpf_upload_file_view_wrapper').hide();
    }
}
let allFiles = [];
let temp_selected_files = [];
jQuery_WPF(document).on('change', '.wpf_uploadfile', function(event) {
    var selectedFiles = event.target.files;
    if (selectedFiles.length > 0) {
      handleFiles(selectedFiles);
    }
});
jQuery_WPF('.wpf_multifile_form').on('dragenter dragover dragleave drop', function(event) {
    event.preventDefault();
    event.stopPropagation();
});
// Highlight drop area when a file is dragged over it
jQuery_WPF('.wpf_multifile_form').on('dragenter dragover', function(event) {
    jQuery_WPF(this).addClass('highlight_file_form');
});
// Unhighlight drop area when a file is dragged out of it
jQuery_WPF('.wpf_multifile_form').on('dragleave drop', function(event) {
    jQuery_WPF(this).removeClass('highlight_file_form');
});
jQuery_WPF('.wpf_multifile_form').on('drop', function(event) {
    var droppedFiles = event.originalEvent.dataTransfer.files;
    if (droppedFiles.length > 0) {
      handleFiles(droppedFiles);
    }
});
function handleFiles(files) {
    temp_selected_files = temp_selected_files.concat(Array.from(files));
    display_selected_files(temp_selected_files);
}
function display_selected_files(files) {
    var file_html = '';
    jQuery_WPF.each(files, function(index, file) {
        var file_size = get_file_size(file.size);
        file_html += '<div class="wpf_each_selected_file"><div class="wpf_selected_file_name">' + file.name + '</div><div class="wpf_selected_file_meta"><div class="wpf_selected_file_size">' + file_size + '</div><div class="wpf_selected_file_delete" data-id="' + index + '"><img src="' + plugin_url + '/images/delete.svg" ></div></div></div>';
    });
    jQuery_WPF('.wpf_selectedfile_list').html(file_html);
    if(files.length > 0) {
        jQuery_WPF('.wpf_multifile_submit').removeClass('wpf_multifile_submit_disabled');
    } else {
        jQuery_WPF('.wpf_multifile_submit').addClass('wpf_multifile_submit_disabled');
        jQuery_WPF('.wpf_uploadfile').val('');
    }
}
jQuery_WPF(document).on('click', '.wpf_selected_file_delete', function() {
    var index = jQuery_WPF(this).data('id');
    temp_selected_files.splice(index, 1);
    display_selected_files(temp_selected_files);
});
jQuery_WPF(document).on('click', '.wpf_upload_prev_delete', function() {
    var index = jQuery_WPF(this).data('id');
    allFiles.splice(index, 1);
    temp_files.splice(index, 1);
    get_files_preview_html(temp_files);
    var len = allFiles.length;
    show_total_file_count(len);
});
function get_file_size(x) {
    const units = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
    let l = 0, n = parseInt(x, 10) || 0;
    while(n >= 1000 && ++l){
        n = n/1000;
    } 
    return(n.toFixed(n < 10 && l > 0 ? 1 : 0) + ' ' + units[l]);
}
function show_total_file_count(len) {
    if( len > 0 ) {
        jQuery_WPF('.wpf_total_files').html(len).addClass('active');
    } else {
        jQuery_WPF('.wpf_total_files').html(len).removeClass('active');
    }
}
function reset_file_upload_field() {
    jQuery_WPF('.wpf_uploadfile').val('');
    jQuery_WPF('.wpf_total_files').html('').removeClass('active');
    jQuery_WPF('.wpf_upload_file_view_container').html('');
    jQuery_WPF('.wpf_upload_file_view_wrapper').hide();
    allFiles = [];
    temp_files = [];
    temp_selected_files = [];
}
jQuery_WPF(document).on('click', '.wpf_preview_icon', function() {
    var img = jQuery_WPF(this).closest('.wpf_comment_each_img').find('img').attr('src');
    jQuery_WPF('.wpf_preview_image').attr('src', img);
    jQuery_WPF('.wpf_image_preview_wrappper').show();
});
jQuery_WPF(document).on('click', '.wpf_close_image_preview', function() {
    jQuery_WPF('.wpf_preview_image').attr('src', '');
    jQuery_WPF('.wpf_image_preview_wrappper').hide();
});
jQuery_WPF(document).on('click', '.wpf_download_file', function() {
    var file = jQuery_WPF(this).closest('.wpf_comment_each_doc').find('.wpf_doc_container .wpf_doc_meta_container .wpf_doc_name');
    var filename = file.text();
    var fileurl = file.data('link');
    // Fetch the file using fetch API
    fetch(fileurl)
    .then(response => response.blob())
    .then(blob => {
        // Create a temporary URL for the blob
        var url = window.URL.createObjectURL(blob);

        // Create a temporary anchor element
        var a = document.createElement('a');
        a.href = url;
        a.download = filename; // Specify the filename

        // Programmatically click on the anchor element to trigger download
        document.body.appendChild(a);
        a.click();

        // Cleanup
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    });
});
function openWPFTab(wpfTab) {
    // remove the no found image if exists
    if ( jQuery_WPF('.wpf_sidebar_content').hasClass('nothingfound') ) {
        jQuery_WPF('.wpf_sidebar_content').removeClass('nothingfound');
    }
    if ( wpfTab == 'wpf_allpages' ) {
        jQuery_WPF('.wpf_thispage .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_allpages .wpf_filter_check').addClass('active_check');
        jQuery_WPF('.wpf_sidebar_content').find('#wpf_thispage').hide();
        jQuery_WPF('.wpf_sidebar_content').find('#wpf_allpages').show();
        jQuery_WPF('button.wpf_tab_sidebar').removeClass('wpf_active');
        jQuery_WPF('button.wpf_tab_sidebar.'+wpfTab).addClass('wpf_active');
        jQuery_WPF('.wpf_sidebar_content .wpf_container').removeClass('wpf_active_filter');
        jQuery_WPF('#'+wpfTab).addClass('wpf_active_filter');
        jQuery_WPF('#wpf_sidebar_filter_task_status input[name="wpf_filter_task_status"]:checked').prop('checked',false);
        jQuery_WPF('#wpf_sidebar_filter_task_priority input[name="wpf_filter_task_priority"]:checked').prop('checked',false);
        jQuery_WPF('.wpf_container.wpf_active_filter ul li').show();
        if ( all_page_tasks_loaded == 0 ) {
            all_page_tasks_loaded = 1;
            load_all_page_tasks();
        }
    }
    if ( wpfTab == 'wpf_thispage' ) {
        jQuery_WPF('.wpf_allpages .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_thispage .wpf_filter_check').addClass('active_check');
        jQuery_WPF('.wpf_sidebar_content').find('#wpf_allpages').hide();
        jQuery_WPF('.wpf_sidebar_content').find('#wpf_thispage').show();
        jQuery_WPF('button.wpf_tab_sidebar').removeClass('wpf_active');
        jQuery_WPF('button.wpf_tab_sidebar.'+wpfTab).addClass('wpf_active');
        jQuery_WPF('.wpf_sidebar_content .wpf_container').removeClass('wpf_active_filter');
        jQuery_WPF('#'+wpfTab).addClass('wpf_active_filter');
        jQuery_WPF('#wpf_sidebar_filter_task_status input[name="wpf_filter_task_status"]:checked').prop('checked',false);
        jQuery_WPF('#wpf_sidebar_filter_task_priority input[name="wpf_filter_task_priority"]:checked').prop('checked',false);
        jQuery_WPF('.wpf_container.wpf_active_filter ul li').show();
    }
    if ( wpfTab == 'wpf_bydate' ) {
        jQuery_WPF('#wpf_thispage_container_today .critical').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .high').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .medium').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .low').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .complete').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .pending-review').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .in-progress').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .open').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .critical').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .high').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .medium').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .low').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .complete').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .pending-review').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .in-progress').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .open').css('order', '');
        jQuery_WPF('.wpf_byprior .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_bystatus .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_bydate .wpf_filter_check').addClass('active_check');
    }
    if ( wpfTab == 'wpf_byprior' ) {
        jQuery_WPF('#wpf_thispage_container_today .critical').css('order', '1');
        jQuery_WPF('#wpf_thispage_container_today .high').css('order', '2');
        jQuery_WPF('#wpf_thispage_container_today .medium').css('order', '3');
        jQuery_WPF('#wpf_thispage_container_today .low').css('order', '4');
        jQuery_WPF('#wpf_allpages_container_today .critical').css('order', '1');
        jQuery_WPF('#wpf_allpages_container_today .high').css('order', '2');
        jQuery_WPF('#wpf_allpages_container_today .medium').css('order', '3');
        jQuery_WPF('#wpf_allpages_container_today .low').css('order', '4');
        jQuery_WPF('.wpf_bydate .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_bystatus .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_byprior .wpf_filter_check').addClass('active_check');
    }
    if ( wpfTab == 'wpf_bystatus' ) {
        jQuery_WPF('#wpf_thispage_container_today .critical').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .high').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .medium').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .low').css('order', '');
        jQuery_WPF('#wpf_thispage_container_today .complete').css('order', '1');
        jQuery_WPF('#wpf_thispage_container_today .pending-review').css('order', '2');
        jQuery_WPF('#wpf_thispage_container_today .in-progress').css('order', '3');
        jQuery_WPF('#wpf_thispage_container_today .open').css('order', '4');
        jQuery_WPF('#wpf_allpages_container_today .critical').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .high').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .medium').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .low').css('order', '');
        jQuery_WPF('#wpf_allpages_container_today .complete').css('order', '1');
        jQuery_WPF('#wpf_allpages_container_today .pending-review').css('order', '2');
        jQuery_WPF('#wpf_allpages_container_today .in-progress').css('order', '3');
        jQuery_WPF('#wpf_allpages_container_today .open').css('order', '4');
        jQuery_WPF('.wpf_byprior .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_bydate .wpf_filter_check').removeClass('active_check');
        jQuery_WPF('.wpf_bystatus .wpf_filter_check').addClass('active_check');
    }
    if ( wpfTab == 'wpf_showcomp' ) {
        if ( jQuery_WPF('.wpf_showcomp .wpf_filter_check').hasClass('active_check') ) {
            jQuery_WPF('.wpf_showcomp .wpf_filter_check').removeClass('active_check');
            jQuery_WPF('.wpfb-point').each(function() {
                if ( jQuery_WPF(this).hasClass('complete') ) {
                    jQuery_WPF(this).hide();
                }
            });
        } else {
            jQuery_WPF('.wpf_showcomp .wpf_filter_check').addClass('active_check');
            jQuery_WPF('.wpfb-point').each(function() {
                if ( jQuery_WPF(this).hasClass('complete') ) {
                    jQuery_WPF(this).show();
                }
            });
        }
    }
    if ( wpfTab == 'wpf_showint' ) {
        if ( jQuery_WPF('.wpf_showint .wpf_filter_check').hasClass('active_check') ) {
            jQuery_WPF('.wpf_showint .wpf_filter_check').removeClass('active_check');
            jQuery_WPF('.wpfb-point').each(function() {
                if ( jQuery_WPF(this).hasClass('wpfb-internal') ) {
                    jQuery_WPF(this).hide();
                }
            });
        } else {
            jQuery_WPF('.wpf_showint .wpf_filter_check').addClass('active_check');
            jQuery_WPF('.wpfb-point').each(function() {
                if ( jQuery_WPF(this).hasClass('wpfb-internal') ) {
                    jQuery_WPF(this).show();
                }
            });
        }
    }
}
jQuery_WPF('.wpf_sidebarmenu_img').on('click', function() {
    jQuery_WPF('.wpf_sidebar_submenu').toggleClass('wpf_sidebar_showsubmenu');
});
jQuery_WPF('.wpf_sidebar_left').on('click', function() {
    jQuery_WPF(this).toggleClass('down');
});
jQuery_WPF('.wpf_task_tab').on('click', function() {
    jQuery_WPF('.wpf_page_tab').removeClass('wpf_active_tab');
    jQuery_WPF('.wpf_tab_active').removeClass('right');
    if ( jQuery_WPF('.wpf_tab_sidebar.wpf_thispage .wpf_filter_check').hasClass('active_check') ) {
        if ( jQuery_WPF('ul#wpf_thispage_container_today li').length == 0 ) {
            jQuery_WPF('.wpf_no_task').show();
        }
        jQuery_WPF('#wpf_thispage').show();
    } else {
        if ( jQuery_WPF('ul#wpf_allpages_container_today li').length == 0 ) {
            jQuery_WPF('.wpf_no_task').show();
        }
        jQuery_WPF('#wpf_allpages').show();
    }
    jQuery_WPF('#wpf_all_pages').hide();
    jQuery_WPF(this).addClass('wpf_active_tab');
});
jQuery_WPF('.wpf_page_tab').on('click', function() {
    jQuery_WPF('.wpf_task_tab').removeClass('wpf_active_tab');
    jQuery_WPF('.wpf_no_task').hide();
    jQuery_WPF('#wpf_thispage').hide();
    jQuery_WPF('#wpf_allpages').hide();
    jQuery_WPF('#wpf_all_pages').show();
    jQuery_WPF('.wpf_tab_active').addClass('right');
    jQuery_WPF(this).addClass('wpf_active_tab');
});
jQuery_WPF(document).on('click', '#wpf_comment_mode_general_task', function() {
    wpf_new_general_task();
});
function wpf_new_general_task() {
    if ( !comment_mode() ) {
        return;
    }
    tasks_on_page[comment_count]=0;
    var wpfb_users_arr = JSON.parse(wpfb_users);
    var wpfb_users_html = get_user_list(wpfb_users_arr, comment_count, '');
    var wpf_popover_html = wpf_task_popover_html(2,comment_count,0,'',wpfb_users_html,'','','',1);
    jQuery_WPF('#wpf_general_comment_tabs').html(wpf_popover_html);
    setTimeout(function(){ 
        jQuery_WPF('#comment-'+comment_count).focus(); 
    }, 100);
    jQuery_WPF('#wpfbsysinfo-' + comment_count + ' .wpf_tag_autocomplete').hide();
    jQuery_WPF('#wpfbsysinfo-' + comment_count + ' .wpf_icon_title').hide();
    jQuery_WPF('#sharetasklink-tab-' + comment_count).show();
    jQuery_WPF('#wpf_general_comment').addClass('active_class ');
    jQuery_WPF('#wpf_general_comment').removeClass('wpf_hide ');
    // add rich text editor for Task center by Pratap
    jQuery(document).find('.wpf-editor').each(function() {
        if ( ! jQuery_WPF(this).hasClass('activee') ) {
            var $this = jQuery_WPF(this);
            jQuery_WPF(this).addClass('activee');
            var quill = new Quill(this, {
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ list: 'ordered' }, { list: 'bullet' }],
                        ['link', 'code-block'],
                    ]
                },
                placeholder: wpf_comment_box_placeholder,
                theme: 'bubble'   // Specify theme in configuration
            });
            quill.on('text-change', function(delta, oldDelta, source) {
                if(quill.root.innerText != '\n') {
                    $this.closest('.form-group').find('.wpf_comment_btn, .wpf_mark_note').removeClass('disabled');
                } else {
                    $this.closest('.form-group').find('.wpf_comment_btn, .wpf_mark_note').addClass('disabled');
                }
                var isempty = isQuillEmpty( quill );
                if ( !isempty ) {
                    $this.closest('.form-group').find('textarea').val(quill.root.innerHTML);
                } else {
                    $this.closest('.form-group').find('textarea').val('');
                }
            });
            $this.on('keydown', function(event) {
                // Check if the pressed key is Enter (keyCode 13 or key "Enter")
                if ( (event.keyCode == 13 || event.key === "Enter") && !event.shiftKey ) {
                    $this.closest('.form-group').find('.wpf_comment_btn.task_comment').trigger('click');
                }
            });
        }
    });
    setup_upload_file(comment_count);
    jQuery_WPF(document).find('.wpf_task_temp_delete_btn').click(function(){
        var btn_taskid = jQuery_WPF(this).data('btn_elemid');
        jQuery_WPF('.wpfbsysinfo_temp_delete_task_id_'+btn_taskid).show();
    });
    jQuery_WPF('.wpf_task_temp_delete').click(function(){
        var elemid = jQuery_WPF(this).data('elemid');
        jQuery_WPF('#wpf_general_comment .wpf_general_task_close').trigger('click');
    });    
}
function comment_mode() {
    var comment_mode = localStorage.getItem('wpf_comment_mode');
    if ( comment_mode == 'yes' ) {
        return true;
    } else {
        return false;
    }
}
var not_comment_cursor = '.wpf-uf-pop-wrapper, .wpf-le-pop-wrapper, .wpf_comment_container, .popover, .popover a, #wpf_launcher, .wpf_multifile_wrapper, .wpf_image_preview_wrappper, .wpf_responsive_modal_wrap, .wpfb-point';
var not_red_box = '.wpf-uf-pop-wrapper, .wpf-le-pop-wrapper, #wpf_launcher, .wpf_multifile_wrapper, .wpf_image_preview_wrappper, .wpf_responsive_modal_wrap, .wpfb-point';
var area = '';
jQuery_WPF(document).ready(function() {
    var isDirectChild = jQuery_WPF('body > #wpf_launcher').length > 0;
    if (isDirectChild) {
        area = 'body > :not(' + not_comment_cursor + ')';
    } else {
        var wpf_launcher_parent = jQuery_WPF('#wpf_launcher').parent();
        if (wpf_launcher_parent.length > 0) {
            var tagName = wpf_launcher_parent.prop("tagName").toLowerCase();
            var classes = wpf_launcher_parent.attr("class");
            var id = wpf_launcher_parent.attr("id");
            var parentSelector = tagName;
            if (classes) {
                parentSelector += '.' + classes.replace(/\s+/g, '.');
            }
            if (id) {
                parentSelector += '#' + id;
            }
            // If class or id is not available, get the position of the parent element relative to its siblings with the same tag
            if (!classes && !id) {
                var position = jQuery_WPF('body > ' + tagName).index(wpf_launcher_parent) + 1;
                parentSelector += ":eq(" + position + ")";
            }
            //area = 'body > ' + parentSelector + ' > :not(' + not_comment_cursor + ')';
            area = 'body > :not(' + parentSelector + ')';
        }
    }
    if( jQuery_WPF('body > #wpwrap').length ) {
        area = 'body #wpwrap > :not(' + not_comment_cursor + ')';
    }
});
function enable_comment(){
    /*if( restrict_plugin == 1 && comment_mode() ) {
        jQuery(".wpf_locked_modal_container").removeClass('wpf_hide');
        return;
    }*/
    comments = true;
    jQuery_WPF(area + ' a').each(function(){
        if(this.id!='disable_comment_a'){
            jQuery_WPF(this).addClass('active_comment');
        }
    });
    jQuery_WPF(area + ' input[type="button"]').each(function(){
        if(this.id!='disable_comment_a'){
            jQuery_WPF(this).addClass('active_comment');
        }
    });
    jQuery_WPF('form').each(function(){
        if(this.id!='disable_comment_a'){
            jQuery_WPF(this).addClass('active_comment');
        }
    });
    if(wpf_reconnect == true){
        jQuery_WPF("a").each(function(){
            jQuery_WPF(this).removeClass('active_comment');
        });
        jQuery_WPF('body').removeClass('active_comment');
        jQuery_WPF('body').addClass('wpf_remap');
    }
    else{
        jQuery_WPF('body').removeClass('wpf_remap');
        jQuery_WPF('body').css('cursor','crosshair');
        jQuery_WPF(not_comment_cursor).css('cursor','default !important');
        jQuery_WPF(area + ' a').css('cursor','crosshair');
    }
    jQuery_WPF('body').addClass('active_comment');
    box = new Overlay(0, 0, 0, 0);
    // hide the old overlay border when user click on "+ Comment" => v2.0.9
    if ( old_rendered_box_el !== null ) {
        old_rendered_box_el.hide();
    }
    jQuery_WPF(area).mouseover(function(e){
        if(comments==true){
            var el = jQuery_WPF(e.target);
            var offset = el.offset();
            var top = offset.top;
            if ( typeof pagetype !== 'undefined' && istheme.adjust == 'true' ) {
                top = top - 33;
            }
            box.render(el.outerWidth()-2, el.outerHeight(), offset.left, top);
            // store current overlay target point
            // this is needed to remove the border from the current element if we click the "+ Comment" button => v2.0.9
            old_rendered_box_el = box;
        }
    });
    jQuery_WPF('body').on('mouseover', not_red_box, function() {
        if ( old_rendered_box_el !== null ) {
            old_rendered_box_el.hide();
        }
    });
    jQuery_WPF('body').on('mousemove', not_comment_cursor, function() {
        jQuery('#cursor_html').hide();
    });
    if(comments==true){
        jQuery_WPF(this).addClass('wpf_enable_comment');
        jQuery_WPF(document).on('keyup',function(evt) {
            if (evt.keyCode == 27) {
                jQuery_WPF('#disable_comment_a').trigger('click');
                wpf_reconnect = false;
                wpf_reconnect_taskid = '';
            }
        });
    }
    /* Add text with the cursor text when user click on the "+ Comment" button on frontend => v2.0.9 */
    const cursor_html = '<span class="wpf_cursor_note" id="cursor_html"></span>';
    // add the empty tag on the body
    jQuery('body').append(cursor_html);
    jQuery(area).mousemove(function(e){
        var cpos = { top: e.pageY + 10, left: e.pageX + 10 };
        // show the cursor text only when the popup is not showing
        if ( jQuery('#cursor_html') && !jQuery('.wpf_comment_container').hasClass('show') ) {
            jQuery('#cursor_html').show();
            jQuery('#cursor_html').text(wpf_create_task);
        } else {
            jQuery('#cursor_html').remove();
        }
        jQuery('#cursor_html').offset(cpos);
    });
    jQuery_WPF('.popover.wpf_comment_container').show();
    if ( jQuery_WPF('#wpf_general_comment').hasClass('active_class') ) {
        jQuery_WPF('#wpf_general_comment').removeClass('wpf_hide');
    }
    jQuery_WPF('.wpf_sidebar_container').animate({right: '30px'}, 1000);
    jQuery_WPF('.wpf_bottombar_section').animate({bottom: '20px'}, 1000);
    var show_completed = '';
    var show_internal = '';
    if ( jQuery_WPF('.wpf_showcomp .wpf_filter_check').hasClass('active_check') ) {
        show_completed = 'true';
    } else {
        show_completed = 'false';
    }
    wpf_show_tasks(show_completed, show_internal);
}
function disable_comment() {
    comments = false;
    wpf_reconnect = false;
    jQuery_WPF("#wpf_enable_comment").hide();
    jQuery_WPF("#wpf_panel").show();
    jQuery_WPF("a").each(function(){
        jQuery_WPF(this).removeClass('active_comment');
    });
    jQuery_WPF('body').removeClass('active_comment');
    jQuery_WPF('body').css('cursor','default');
    jQuery_WPF('a').css('cursor','pointer');
    box = {};

    /* Remove the cursor text UI if user cancel comment on frontend => v2.0.9 */
    if ( jQuery('#cursor_html') ) {
        jQuery('#cursor_html').remove();
    }
    jQuery_WPF('.popover.wpf_comment_container').hide();
    jQuery_WPF('#wpf_general_comment').addClass('wpf_hide');
    jQuery_WPF('.wpf_responsove_options').css('visibility','hidden');
    jQuery('.wpf_sidebar_container').animate({right: '-300px'}, 1000);
    jQuery('.wpf_sidebar_container').attr('style', '');
    jQuery_WPF('.wpf_bottombar_section').animate({bottom: '-100px'}, 1000);
    jQuery('.wpf_bottombar_section').attr('style', '');
    jQuery('.wpfb-point').hide();
    jQuery(".wpf_locked_modal_container").addClass('wpf_hide');
}
function wpf_show_tasks(completed, internal) {
    if ( completed == 'false' ) {
        jQuery_WPF('.wpfb-point').each(function() {
            if (jQuery_WPF(this).hasClass('complete')) {
                jQuery_WPF(this).hide();
            } else {
                jQuery_WPF(this).show();
            }
        });
    } else {
        jQuery('.wpfb-point').show();
    }
}
function wpf_delete_task(id, task_id){
    var task_info = [];
    task_info['task_id'] = task_id;
    task_info['task_no'] = id;
    var task_info_obj = jQuery_WPF.extend({}, task_info);
    jQuery_WPF.ajax({
        method : "POST",
        url : ajaxurl,
        data : {action: "wpfb_delete_task",wpf_nonce:wpf_nonce,task_info:task_info_obj},
        beforeSend: function(){
            jQuery_WPF('#popover-content-c' + id).closest('.popover').remove();
            jQuery_WPF('.wpf_general_task_close').trigger('click');
            jQuery_WPF('#bubble-'+id).remove();
            jQuery_WPF('#wpf_thispage_container_today [data-taskid="'+id+'"],#wpf_thispage_container_yesterday [data-taskid="'+id+'"],#wpf_thispage_container_this_week [data-taskid="'+id+'"],#wpf_thispage_container_this_month [data-taskid="'+id+'"],#wpf_thispage_container_year [data-taskid="'+id+'"],#wpf_thispage_container_other [data-taskid="'+id+'"]').remove();
            jQuery_WPF('#wpf_allpages_container_today [data-taskid="'+id+'"],#wpf_allpages_container_yesterday [data-taskid="'+id+'"],#wpf_allpages_container_this_week [data-taskid="'+id+'"],#wpf_allpages_container_this_month [data-taskid="'+id+'"],#wpf_allpages_container_year [data-taskid="'+id+'"],#wpf_allpages_container_other [data-taskid="'+id+'"]').remove();
            if(onload_wpfb_tasks[task_id] != null){
                jQuery_WPF(onload_wpfb_tasks[task_id].task_element_path).removeClass('wpfb_task_bubble');
            }
            if ( jQuery_WPF('ul#wpf_thispage_container_today li').length == 0 ) {
                jQuery_WPF('.wpf_no_task').show();
            }
        },
        success : function(data){
            
        }
    });
}
jQuery_WPF(document).on('keydown', function(event) {
    if (event.key == "Escape") {
        if ( old_rendered_box_el !== null ) {
            old_rendered_box_el.hide();
        }
        localStorage.setItem('wpf_comment_mode', 'no');
        jQuery_WPF('.wpf_bottom_middle .wpf_bc_switch_slider').addClass('active_browse');
        jQuery_WPF('.wpf_bottombar_section').addClass('wpf_hide');
        jQuery_WPF('.wpf_launch_comment_mode').removeClass('hide_comment_mode');
        disable_comment();
    }
});
jQuery_WPF(document).ready(function() {
    if(disable_for_admin == 0){
        // check if the page is not inside an iframe
        if ( window.location === window.parent.location || window.frameElement.id != 'vcv-editor-iframe' ) {
            load_wpfb_tasks();
            load_wpfb_pages();
        }
        jQuery_WPF( function() {
            // added drag on the parent of the wpf_launch_buttons => v2.1.0
            jQuery_WPF( "#wpf_launcher > #wpf_launch_buttons_wrapper" ).draggable({ containment: "body" });
        });
    }
    jQuery_WPF('.wpf_sidebar_container').draggable();
    jQuery_WPF('#wpf_bottom_bar').draggable();  
    var previous_element = [];
    jQuery_WPF(area).find('*').on('click', function(event) {
        var no_of_elements = jQuery_WPF(this).parents().addBack().not('html').length-1, temp_count = 0;
        if(this.id!="disable_comment_a"){
            if(comments==true){
                rightArrowParents = [];
                if ( jQuery_WPF( this ).hasClass( "wpfb_task_bubble" )) {
                    jQuery_WPF('#wpf_already_comment').show().delay(5000).fadeOut();
                    jQuery_WPF('#disable_comment_a').trigger('click');
                    jQuery_WPF('[rel="popover-'+jQuery_WPF(this).data('task_id')+'"]').trigger('click');
                    event.stopPropagation();
                    return false;
                }
                if(jQuery_WPF(this).attr('id')=='wpf_launcher' || jQuery_WPF( this ).hasClass( "gg-math-plus" ) || jQuery_WPF( this ).hasClass( "wpf_start_comment" ) ){
                    jQuery_WPF('#disable_comment_a').trigger('click');
                    return false;
                }
                if (jQuery_WPF( this ).hasClass( "wpf_none_comment" ) ) {
                    alert('Task cannot be created for this element');
                    return false;
                }
                temp_tasks[comment_count] = [];
                curr_browser_temp = get_browser();
                browser = curr_browser_temp['name']+' '+curr_browser_temp['version'];
                relative_location = mousePositionElement(event);
                temp_tasks[comment_count]['relative_location']=relative_location;
                html_element_location = getOffset(this);
                temp_tasks[comment_count]['html_element_location']=html_element_location;
                html_element_width = jQuery_WPF(this).width();
                temp_tasks[comment_count]['html_element_width']=html_element_width;
                html_element_height = jQuery_WPF(this).height();
                temp_tasks[comment_count]['html_element_height']=html_element_height;
                dompath = getDomPath(this);
                wpf_clean_dom_elem_path = dompath.join(' > ');
                temp_tasks[comment_count]['wpf_clean_dom_elem_path']=wpf_clean_dom_elem_path;
                jQuery_WPF(this).parents().addBack().not('html').each(function() {
                    var entry = this.tagName.toLowerCase();
                    if(entry!='body'){
                        if (this.className) {
                            this.className = jQuery_WPF.trim(this.className);
                            var wpf_class_arr = this.className.split(" ");
                            var wpf_class_format = /[ !@#$%^&*()+\=\[\]{};':"\\|,<>\/?]/;
                            for (var i = 0; i < wpf_class_arr.length; i++) {
                                if (wpf_class_format.test(wpf_class_arr[i]) == true) {
                                    wpf_class_arr[i] = '';
                                }
                            }
                            var wpf_new_classname = jQuery_WPF.trim(wpf_class_arr.join(' '));
                            wpf_new_classname = wpf_new_classname.replace(/\s+/g, '.');
                            entry += "." + wpf_new_classname;
                        }
                    }
                    current_html_element = entry;
                    temp_tasks[comment_count]['current_html_element']=current_html_element;
                    if(temp_count==no_of_elements){
                        var temp_element = rightArrowParents.join(" > ");
                        temp_element = temp_element+' > '+entry;
                        var temp_index = jQuery_WPF(this).index(temp_element);
                        rightArrowParents.push(entry+':eq('+temp_index+')');
                    }
                    else{
                        rightArrowParents.push(entry);
                    }
                    temp_count++;
                });
                temp_tasks[comment_count]['rightArrowParents']=rightArrowParents;
                /*=====================Start reconnect task feature ===============*/
                if(wpf_reconnect==true && wpf_reconnect_taskid != ''){
                    wpf_reconnect_meta['wpf_reconnect_taskid']=wpf_reconnect_taskid;
                    rightArrowParents = rightArrowParents.join(' > ');
                    wpf_reconnect_meta['rightArrowParents']=rightArrowParents;
                    wpf_reconnect_meta['dompath']=wpf_clean_dom_elem_path;
                    wpf_reconnect_meta['html_element_height']=html_element_height;
                    wpf_reconnect_meta['html_element_width']=html_element_width;
                    var new_reconnect_obj = jQuery_WPF.extend({}, wpf_reconnect_meta);
                    jQuery_WPF.ajax({
                        method:"POST",
                        url: ajaxurl,
                        data: {action:'wpf_reconnect_task',wpf_nonce:wpf_nonce,new_reconnect_obj:new_reconnect_obj},
                        beforeSend: function(){
                            jQuery_WPF('#wpf_reconnecting_task').show();
                        },
                        success: function(data){
                            jQuery_WPF('#wpf_reconnecting_task').show().delay(2000).fadeOut();
                            var element_center = getelementcenter(rightArrowParents);
                            element_center['left']=element_center['left']-25;
                            element_center['top']=element_center['top']-25;
                            jQuery_WPF('#bubble-'+wpf_reconnect_tasknumber).attr('style','top:'+element_center['top']+'px; left:'+element_center['left']+'px;');
                            jQuery_WPF(rightArrowParents).addClass('wpfb_task_bubble');
                        }
                    });
                    wpf_reconnect = false;
                    wpf_reconnect_taskid = '';
                    return false;
                }
                var wpfb_users_arr = JSON.parse(wpfb_users);
                var wpfb_users_html = get_user_list(wpfb_users_arr, comment_count, '');
                var element_center = getelementcenter(rightArrowParents.join(" > "));
                element_center['left']=element_center['left']-25;
                element_center['top']=element_center['top']-25;
                jQuery_WPF(rightArrowParents.join(" > ")).addClass('wpfb_task_bubble');
                jQuery_WPF(rightArrowParents.join(" > ")).attr('data-task_id', comment_count);
                //remove sticker if task not saved by Pratap
                if ( unsaved_task ) {
                    var popid = jQuery_WPF( '#bubble-' + bubble_comment_count ).attr('aria-describedby');
                    jQuery_WPF( '#bubble-' + bubble_comment_count ).remove();
                    jQuery_WPF( '#' + popid ).remove();
                    jQuery_WPF(previous_element.join(" > ")).removeClass('wpfb_task_bubble');
                    jQuery_WPF(previous_element.join(" > ")).attr('data-task_id', '');
                }
                previous_element = rightArrowParents;
                var wpf_popover_html = wpf_task_popover_html(1,comment_count,0,'',wpfb_users_html,'','','',1,'');
                jQuery_WPF('#wpf_launcher').after(wpf_popover_html);
                close_open_tasks();
                init_custom_popover(comment_count);
                setup_upload_file(comment_count);
                tasks_on_page[comment_count]=0;
                unsaved_task = true;
                event.preventDefault();
            }
        }
        if(comments==true){
            //disable_comment();
            event.stopPropagation();
        }
    });
    jQuery_WPF('.wpf_bottom_middle .wpf_bc_switch_slider').click(function() {
        if ( jQuery_WPF(this).hasClass('active_browse') ) {
            localStorage.setItem('wpf_comment_mode', 'yes');
            jQuery_WPF(this).removeClass('active_browse');
            jQuery_WPF('.wpf_launch_comment_mode').addClass('hide_comment_mode');
            enable_comment();
        } else {
            if ( old_rendered_box_el !== null ) {
                old_rendered_box_el.hide();
            }
            localStorage.setItem('wpf_comment_mode', 'no');
            jQuery_WPF(this).addClass('active_browse');
            jQuery_WPF('.wpf_launch_comment_mode').removeClass('hide_comment_mode');
            disable_comment();
        }
    });
    jQuery_WPF('.wpf_launch_comment_mode').on('click', function() {
        jQuery_WPF('.wpf_bottom_middle .wpf_bc_switch_slider').trigger('click');
    });
    jQuery_WPF('.wpf_general_task_close').on('click',function () {
        jQuery_WPF('#wpf_general_comment_tabs').html('');
        jQuery_WPF('#wpf_general_comment').addClass('wpf_hide');
        jQuery_WPF('#wpf_general_comment').removeClass('active_class');
    });
});
function close_open_tasks() {
    jQuery_WPF(document).find('.popover.wpf_comment_container').each(function() {
        jQuery_WPF(this).find('.close').trigger('click');
    });
}
function get_user_list(wpfb_users_arr, comment_count, notify_users) {
    var users_html = '<ul class="wp_feedback_filter_checkbox user">'
    for (var key in wpfb_users_arr) {
        var checked = '';
        if (wpfb_users_arr.hasOwnProperty(key)) {
            var user_name = (wpfb_users_arr[key]['first_name']) ? wpfb_users_arr[key]['first_name'] + ' ' + wpfb_users_arr[key]['last_name'] : wpfb_users_arr[key]['displayname'];
            if( notify_users == '' && ( current_user_id === key || wpf_website_builder.includes(key) ) ) {
                checked = 'checked';
            }
            if(notify_users.includes(key)){
                checked = 'checked';
            }
            users_html += '<li>';
                users_html +=  '<input type="checkbox" name="author_list_' + comment_count + '" value="' + key + '" class="wp_feedback_task wpfbtasknotifyusers wpf_checkbox" data-elemid="' + comment_count + '" id="author_list_' + comment_count + '_' + key + '" data-wp-usrn="' + wpfb_users_arr[key]['username'] + '" ' + checked + '>';
                users_html +=  '<label for="author_list_' + comment_count + '_' + key + '">';
                    users_html +=  '<div class="wpf_notify_user_container">';
                        users_html +=  '<div class="wpf_notify_user_avatar">' + user_name.substr(0,2) + '</div>';
                        users_html += '<div class="wpf_notify_user_name">' + user_name + '</div>';
                        users_html += '<div class="wpf_notify_status">';
                            users_html +=  '<span class="wpf_will_notify">Will be notified ' + user_checked + '</span>';
                            users_html += '<span class="wpf_will_not_notify">Won\'t be notified</span>';
                        users_html += '</div>';
                    users_html += '</div>';
                users_html +=  '</label>';
            users_html +=  '</li>';
        }
    }
    users_html += '</ul>';
    return users_html;
}
function setup_upload_file(id) {
    jQuery_WPF('.wpf_multifile_wrapper .wpf_uploadfile').attr('name', 'wpf_uploadfile_' + id + '[]');
    jQuery_WPF('.wpf_multifile_wrapper .wpf_uploadfile').attr('id', 'wpf_uploadfile_' + id);
    jQuery_WPF('.wpf_multifile_wrapper .wpf_uploadfile').attr('data-elemid', 'wpf_uploadfile_' + id);
}
// status prioty bottom bar filter
jQuery_WPF(document).ready(function(){
    jQuery_WPF('a.wpf_filter_tab_btn_bottom').click(function(event){
        if(jQuery_WPF(this).hasClass('wpf_active')){
            jQuery_WPF('a.wpf_filter_tab_btn_bottom').removeClass('wpf_active');
            jQuery_WPF(this).removeClass('wpf_active');
            jQuery_WPF('.wpf_list').removeClass('wpf_active').addClass('wpf_hide');
        }else{
            // Do not proceed if it is admin and share button is clicked as the share version 2 is active by Pratap.
            if( jQuery_WPF('.avc_invite_share_wrapper').length > 0 && jQuery_WPF(this).data('tag') == 'wpf_share_page_btn') {
                return;
            }
            jQuery_WPF('a.wpf_filter_tab_btn_bottom').removeClass('wpf_active');
            jQuery_WPF(this).addClass('wpf_active');
            var tagid = jQuery_WPF(this).data('tag');
            jQuery_WPF('.wpf_list').removeClass('wpf_active').addClass('wpf_hide');
            jQuery_WPF('#'+tagid).addClass('wpf_active').removeClass('wpf_hide');

            // search expand
            if ( jQuery(this).parent().hasClass('search') ) {
                jQuery('#sidebar_search').addClass('active');
                jQuery_WPF("#wpf_search_title").focus();
            }
        }
    });
});
jQuery_WPF('#confirm_approve_page').on('click',function(){
    let complete_tasks=Number(jQuery_WPF("#wpf_approve_all").is(":checked"))
        jQuery_WPF.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {action:'wpfb_approve_page',wpf_nonce:wpf_nonce,page_id:current_page_id,complete_tasks:complete_tasks,current_user_id:current_user_id},
            beforeSend: function(){
                jQuery_WPF('.wpf_loader_approve_page').show();
            },
            success: function(data){
                jQuery_WPF('.wpf_loader_approve_page').hide();
                if(data == 1){
                    jQuery_WPF('#confirm_approve_page').find('span').html('Approved');
                    jQuery_WPF('#confirm_approve_page').attr('data-is-approve',1);
                    jQuery_WPF('.approve_confirm_modal').hide();
                    jQuery_WPF('.wpf_page_approved').show();
                    if(complete_tasks==1){
                    jQuery_WPF('.popover').hide();
                    jQuery_WPF('.wpf_total_task_number').text('0');
                    jQuery_WPF(".wpfb-point").removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom').addClass('complete complete_custom');
                    jQuery_WPF(".current_page_task").removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom').addClass('complete complete_custom');
                    jQuery_WPF(".current_page_general_task").removeClass('open').removeClass('complete').removeClass('pending-review').removeClass('in-progress').removeClass('complete_custom').removeClass('open_custom').removeClass('pending-review_custom').removeClass('in-progress_custom').addClass('complete complete_custom');
                }
                }else{
                    jQuery_WPF("#approve_error").show().delay(5000).fadeOut();
                }
            }
        });
});

jQuery_WPF('#open_approve_modal').on('click',function(){
    let page_approve = jQuery_WPF('#open_approve_modal').attr('data-is-approve');
    if(page_approve == 0){
        jQuery_WPF('#approve_pg').show();
    }
});
jQuery_WPF('.wpf_approve_pg_close').on('click',function(){
    jQuery_WPF('#approve_pg').hide();
});
jQuery_WPF('#open_responsive_modal').on('click',function(){
        jQuery_WPF('#responsive_modal').show();
});
jQuery_WPF('.wpf_responsive_modal_wrap .wpf_close').click(function(){
    location.reload();
});
function inIframe () {
    try {
        return window.self !== window.top;
    } catch (e) {
        return true;
    }
}
if(inIframe()!=true && !jQuery_WPF('body').hasClass('wpf_graphics') && !jQuery_WPF('body').hasClass('wp-admin')){
    jQuery_WPF(".wpf_responsive_icons_bar").show();
}
jQuery_WPF('.wpf_responsive_icons_bar').on('click', function() {
    if( jQuery_WPF('.wpf_responsove_options').css('visibility') == 'hidden' && comment_mode() ) {
        jQuery_WPF('.wpf_responsove_options').css('visibility','visible');
    } else {
        jQuery_WPF('.wpf_responsove_options').css('visibility','hidden');
    }
});
jQuery_WPF('.wpf_collab_user_list').on('click', function() {
    if( jQuery_WPF('.wpf_collab_users_wrapper').css('visibility') == 'hidden' && comment_mode() ) {
        jQuery_WPF('.wpf_collab_users_wrapper').css('visibility','visible');
    } else {
        jQuery_WPF('.wpf_collab_users_wrapper').css('visibility','hidden');
    }
});
jQuery_WPF('.wpf_visibility_container').on('click', function() {
    if( jQuery_WPF('#wpf_task_visibility').css('display') == 'none' && comment_mode() ) {
        jQuery_WPF('#wpf_task_visibility').css('display','flex');
    } else {
        jQuery_WPF('#wpf_task_visibility').css('display','none');
    }
});
jQuery_WPF('.wpf_responsive_desk').on('click',function(){
    jQuery_WPF('.wpf_responsive_icon').removeClass('wpf_responsive_active_tab');
    jQuery_WPF('.wpf_responsive_desk').addClass('wpf_responsive_active_tab');
    jQuery_WPF(".iframe_holder iframe").removeAttr('src');
    jQuery_WPF('.iframe_holder').css('width','calc(80% + 30px )').css('height','calc(80% + 120px)');
    jQuery_WPF('#responsive_modal').show();
    setTimeout(function(){
        jQuery_WPF(".iframe_holder iframe").attr("src",location.href);
    },50);
});
jQuery_WPF('.wpf_responsive_tablet').on('click',function(){
    jQuery_WPF('.wpf_responsive_icon').removeClass('wpf_responsive_active_tab');
    jQuery_WPF('.wpf_responsive_tablet').addClass('wpf_responsive_active_tab');
    jQuery_WPF(".iframe_holder iframe").removeAttr('src');
    jQuery_WPF('.iframe_holder').css('width','1024px').css('height','100vh');
    jQuery_WPF('#responsive_modal').show();
    setTimeout(function(){
        jQuery_WPF(".iframe_holder iframe").attr("src",location.href);
    },50);
});
jQuery_WPF('.wpf_responsive_mobile').on('click',function(){
    jQuery_WPF('.wpf_responsive_icon').removeClass('wpf_responsive_active_tab');
    jQuery_WPF('.wpf_responsive_mobile').addClass('wpf_responsive_active_tab');
    jQuery_WPF(".iframe_holder iframe").removeAttr('src');
    jQuery_WPF('.iframe_holder').css('width','600px').css('height','100vh');
    jQuery_WPF('#responsive_modal').show();
    setTimeout(function(){
        jQuery_WPF(".iframe_holder iframe").attr("src",location.href);
    },50);
});
jQuery_WPF('#wpf_scale_effect').on('change',function(){
    let scale_effect='';
    scale_effect=jQuery_WPF(this).val();
    jQuery_WPF('.iframe_holder').removeClass('wpf_scale_50').removeClass('wpf_scale_75').removeClass('wpf_scale_100').removeClass('wpf_scale_125').removeClass('wpf_scale_150').addClass('wpf_scale_'+scale_effect);
});
jQuery_WPF("#wpfb_display_completed_tasks").change(function() {
    if(this.checked) {
        jQuery_WPF('.wpfb-point').each(function(){
            if(jQuery_WPF(this).hasClass('complete')){
                jQuery_WPF(this).show();
            }
        });
    }
    else{
        jQuery_WPF('.wpfb-point').each(function(){
            if(jQuery_WPF(this).hasClass('complete')){
                jQuery_WPF(this).hide();
            }
        });
    }
});
jQuery_WPF("#wpfb_display_internal_tasks").change(function() {
    if(this.checked) {
        jQuery_WPF('.wpfb-point').each(function(){
            if(jQuery_WPF(this).hasClass('wpfb-internal')){
                jQuery_WPF(this).show();
            }
        });
    }
    else{
        jQuery_WPF('.wpfb-point').each(function(){
            if(jQuery_WPF(this).hasClass('wpfb-internal')){
                jQuery_WPF(this).hide();
            }
        });
    }
});
function wpf_display_tasks() {
    if(document.getElementById('wpfb_display_tasks').checked) {
        jQuery_WPF('.wpfb-point').each(function(){

            // First it will check if the task is completed or not by inspecting the class
            // If completed class has present then it will check if "Show Completed" checkbox has checked or not
            // If not checked, then it will hide it otherwise it will show the task => v2.1.1.
            if ( jQuery_WPF(this).hasClass('complete') && (!jQuery_WPF('#wpfb_display_completed_tasks').is(':checked')) ) {
                jQuery_WPF(this).hide();
            } else {
                jQuery_WPF(this).show();
            }
        });
    } else {
        jQuery_WPF('.wpfb-point').each(function(){
            jQuery_WPF(this).hide();
        });
    }
}
function wpf_remove_login_to_clipboard_sidebar(){
    const params = getParams(window.location.href);
    if(document.getElementById('wpf_remove_login_task_link').checked) {
        var task_link =  (window.location.href.lastIndexOf('graphic/?id') > 0 ) ? current_page_url+ '?id=' + params['id']
            : current_page_url;
        jQuery_WPF(document).find('#wpf_share_page_link').val(task_link);
        jQuery_WPF(document).find('.wpf_task_link').text(task_link);
    }else{
        var task_link =  (window.location.href.lastIndexOf('graphic/?id') > 0 ) ? current_page_url+ '?id=' + params['id'] + '&wpf_login=1'
            : current_page_url + '?wpf_login=1';
        jQuery_WPF(document).find('#wpf_share_page_link').val(task_link);
        jQuery_WPF(document).find('.wpf_task_link').text(task_link);
    }
}
function wpf_copy_to_clipboard(id) {
    var copyText = document.getElementById(id);
    copyText.select();
    copyText.setSelectionRange(0, 99999);
    document.execCommand("copy");

    jQuery_WPF('#wpf_success_'+id).show();
    setTimeout(function() {
        jQuery_WPF('#wpf_success_'+id).fadeOut();
    }, 500);

    return false;
}
function wpf_image_open_new_tab(e){
    jQuery_WPF(e).parent().find('a')[0].click();
}
function wpf_task_image_delete(e){
    var task_img_url = jQuery_WPF(e).parent().find('a')[0].getAttribute('href');
    var comment_li = jQuery_WPF(e).closest('li');
    var comment_id = comment_li.data('comment_id');
    jQuery_WPF.ajax({
        type: 'POST',
        url: ajaxurl,
        data : {action: "wpfb_delete_task_image",wpf_nonce:wpf_nonce,task_img_url:task_img_url,comment_id:comment_id},
        beforeSend: function (){
        },
        success: function(data){
            if(data == 1){
                comment_li.remove();
            }
        }
    });
}
function wpf_image_download_action(){
    let anchor = jQuery_WPF('#wpf_image_download').parent().find('a')[0];
    var anchorTag = document.createElement('a');
    anchorTag.href = jQuery_WPF(anchor).attr('href');
    anchorTag.download = "download";
    anchorTag.target = "_blank";
    anchorTag.click();
    var element = document.getElementById('wpf_image_download');
    element.appendChild(anchorTag);
    anchorTag.remove();
}
function search_filter(task_title) {

    const $sidebar = jQuery(".wpf_sidebar_container");
    let active_tab = jQuery_WPF("#wpf_thispage");
    let count = 0;

    jQuery(active_tab).find('ul > li').each(function(index, element) {

        if ( jQuery(element).find('.current_page_task_list').text().toLowerCase().includes(task_title.toLowerCase()) ) {
            jQuery_WPF('.wpf_sidebar_content').removeClass('nothingfound');
            jQuery(element).show();
        } else {
            jQuery(element).hide();
            count++;
        }
    });

    if ( jQuery(active_tab).find('ul > li').length === count ) {
        jQuery_WPF('.wpf_sidebar_content').addClass('nothingfound');
    }
}
jQuery_WPF('.wpf_sidebar_search').click(function() {
    if ( jQuery_WPF('.wpf_search_field').hasClass('active') ) {
        jQuery_WPF('.wpf_search_field').removeClass('active');
    } else {
        jQuery_WPF('.wpf_search_field').addClass('active');
        jQuery_WPF(".wpf_search_field .wpf_search_title").focus();
    }
});
// Search filter tasks on the sidebar.
function wp_feedback_task_filter(event, element) {
    var task_types = [];
    const task_title = jQuery('#wpf_search_title').val();

    // esc to hide the search field
    if ( event.keyCode === 27 ) {
        jQuery("#wpf_search_title").val('');
        search_filter('');
        return;
    }

    search_filter(task_title);
}
// Convert URLs in a string to anchor links
function URLify(text){
    if ( typeof text !== "undefined" ) {
        const exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        const text1=text.replace(exp, "<a href='$1'>$1</a>");
        const exp2 =/(^|[^\/])(www\.[\S]+(\b|$))/gim;
        
        return text1.replace(exp2, '$1<a target="_blank" href="http://$2">$2</a>');
    }
    return text;
}
function to_capitalize(string) {
    string = string.toLowerCase().replace(/\b[a-z]/g, function(letter) {
        return letter.toUpperCase();
    });
    return string;
}
function is_video_Url(url) {
    var p = /^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;
    var matches = url.match(p);
    if(matches){
        return matches[1];
    }
    
    return false;
}
function countdownTimeStartBackword(deadline, offset=0) {
    
    const countDownDate = deadline.getTime();

    // Update the count down every 1 second
    var x = setInterval(function () {const dateNow = new Date();
    
        // Get todays date and time
        var now = eval(new Date(
            dateNow.getUTCFullYear(),
            dateNow.getUTCMonth(),
            dateNow.getUTCDate(),
            dateNow.getUTCHours(),
            dateNow.getUTCMinutes(),
            dateNow.getUTCSeconds(),
            dateNow.getUTCMilliseconds()   
        ).getTime());

        // Find the distance between now an the count down date
        var distance = (countDownDate > now) 
        ? countDownDate - now
        : now - countDownDate;

        // Time calculations for days, hours, minutes and seconds
        var days = Math.floor(distance / (1000 * 60 * 60 * 24));
        var hours = Math.floor(
            (distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        
        var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        var seconds = Math.floor((distance % (1000 * 60)) / 1000);

        if (countDownDate < now) {

             // add the nagetive sign (-) based on the deadline
            days    = ( (days > 0) && (countDownDate < now) ) ? `-${days}` : days;
            hours   = ( (days > 0 && days===0) && (countDownDate < now) ) ? `-${hours}` : hours;
            minutes = ( (minutes > 0 && hours===0 && days===0) && (countDownDate < now) ) ? `-${minutes}` : minutes;
        }

        // Output the result in an element with id="demo"
        const timer = `${days}d ${hours}h ${minutes}m`;
        jQuery_WPF('#wpf_site_milestone #wpf_countdown_timer').html(timer);
    
    }, 1000);
}
function start_milestone_timer(milestone)
{
    const date_time_str = `${milestone['due_date_at']} ${milestone['due_time_at']}`;    
    const deadline      = new Date(date_time_str);
    const now           = new Date();
    countdownTimeStartBackword(deadline);
}
// milestone popover
jQuery_WPF( document ).on( 'click', '#wpf_site_milestone', () => {

    const element = jQuery_WPF('#wpf_site_milestone');

    if( jQuery_WPF(element).next().hasClass('wpf_active'))
        jQuery_WPF(element).next().removeClass('wpf_active').addClass('wpf_hide');
    else {
        jQuery_WPF(element).next().removeClass('wpf_hide').addClass('wpf_active');

        const loader_html = `<div class="wpf_loader wpf_loader_3 wpf_active"></div>`;
        jQuery_WPF(element).next().html( loader_html );

        // fetch site's milestone API to list the phases (milestones)
        jQuery_WPF.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {action:'wpf_fetch_milestones', wpf_nonce: wpf_nonce },
            beforeSend: function(){
            },
            success: function(data){
                const milestones = JSON.parse(data);

                let html = `<div class="wpf_milestone_item_container"><div class="wpf_milestone_item_container_header">`;
                html += `<label class="wpf_visibility_title">Project Stages</label>`; // title
                html += `<a href="javascript:void(0)" onclick="close_milestone_popup(this);" class="close" data-dismiss="alert">×</a></div>`; // close button

                jQuery_WPF.each(milestones['result'], function (key, milestone) {
                    let icon        = milestone_calender_icon;
                    let icon_class  = 'pending';

                    if ( milestone['is_active'] ) {
                        icon = milestone_calender_plus_icon;
                        icon_class = 'in_progress';
                    } else if ( milestone['status'] ) {
                        icon = milestone_calender_check_icon;
                        icon_class = 'done';
                    }
                    
                    html += `
                    <div class="wpf_milestone_item">
                        <ul ${milestone['status'] ? 'class="completed"' : ''}>                        
                            <li class="wpf_${icon_class}">
                                <span>${icon}</span>
                                ${milestone['title']}
                            </li>
                            <li>${milestone['days_left']}</li>
                        </ul>
                    </div>`;
                });

                html += `</div>`;

                jQuery_WPF(element).next().html( html );
            }
        });
    }
} );
// Show share popup by Pratap.
jQuery_WPF(document).on( 'click', '.wpf_share_btn', function() {
    if ( jQuery_WPF('.avc_invite_share_wrapper').length > 0 ) {
        jQuery_WPF('.avc_invite_share_wrapper').css('display', 'flex');
    }
});
// Hide share popup by Pratap.
jQuery_WPF(document).on( 'click', '.avc_close_share_container', function() {
    jQuery_WPF('.avc_invite_share_wrapper').hide();
});
// Copy to clipboard by Pratap.
function avc_copy_to_clipboard( id ) {
    var text_con = jQuery_WPF('#' + id).closest('.avc_share_button').find('.avc_copy_link_icon span');
    var init_text = text_con.text();
    var copyText = document.getElementById( id ).value;

    // Check if the Clipboard API is available and the site is served over HTTPS
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(copyText)
            .then(() => {
                text_con.text('Link Copied');
                setTimeout(function () {
                    text_con.text(init_text);
                }, 1500);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
            });
    } else {
        // Fallback method for copying text in HTTP context
        var textArea = document.createElement('textarea');
        textArea.value = copyText;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            text_con.text('Link Copied');
            setTimeout(function () {
                text_con.text(init_text);
            }, 1500);
        } catch (err) {
            console.error('Could not copy text: ', err);
        }
        document.body.removeChild(textArea);
    }

    return false;
}
// Copy to clipboard by Pratap.
function avc_copypagelink_to_clipboard( id ) {
    var inputValue = document.getElementById(id).value; // Get the value of the input field

    // Check if the Clipboard API is available and the site is served over HTTPS
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(inputValue)
            .then(() => {
                jQuery_WPF('.avc_copy_pagelink').text('Copied');
                setTimeout(function () {
                    jQuery_WPF('.avc_copy_pagelink').text('Copy');
                }, 1500);
            })
            .catch(err => {
                console.error('Could not copy text: ', err);
            });
    } else {
        // Fallback method for copying text in HTTP context
        var textArea = document.createElement('textarea');
        textArea.value = inputValue;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            jQuery_WPF('.avc_copy_pagelink').text('Copied');
            setTimeout(function () {
                jQuery_WPF('.avc_copy_pagelink').text('Copy');
            }, 1500);
        } catch (err) {
            console.error('Could not copy text: ', err);
        }
        document.body.removeChild(textArea);
    }

    return false;
}
// Add row to invite more users by Pratap.
jQuery_WPF(document).on( 'click', '.avc_add_invite', function() {
    jQuery_WPF(this).closest('.avc_each_invite').after('<div class="avc_each_invite"><div class="avc_invite_fields"><input tpye="text" name="invite_name" class="avc_invite_name" placeholder="Full name" ><input type="email" name="invite_email" class="avc_invite_email" placeholder="Email address" ></div><div class="avc_add_remove_invite"><button class="avc_add_invite" tabindex="0" type="button"><svg class="avc_add_inivite_svg" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg></button><button class="avc_remove_invite" tabindex="0" type="button"><svg class="avc_remove_inivite_svg" focusable="false" viewBox="0 0 24 24" aria-hidden="true"><path d="M19 13H5v-2h14v2z"></path></svg></button></div></div>');
    jQuery_WPF('.avc_remove_invite').css('visibility', 'visible');
});
// Remove unwanted row from invite by Pratap.
jQuery_WPF(document).on( 'click', '.avc_remove_invite', function() {
    jQuery_WPF(this).closest('.avc_each_invite').remove();
    if ( jQuery_WPF('.avc_each_invite').length < 2 ) {
        jQuery_WPF('.avc_remove_invite').css('visibility', 'hidden');
    }
});
// Validate email by Pratap.
function IsEmail(email) {
    var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
    if ( !regex.test( email ) ) {
        return false;
    } else {
        return true;
    }
}
var is_empty = 1;
jQuery_WPF(document).on( 'change keyup', '.avc_invite_name, .avc_invite_email', function() {
    is_empty = 0;
    jQuery_WPF('.avc_invite_name, .avc_invite_email').each(function() {
        if( jQuery_WPF(this).val() == '' ) {
            is_empty = 1;
        }
    });
    if( is_empty == 1 ) {
        jQuery_WPF('#send_invite').removeClass('send_invite_active');
    } else {
        jQuery_WPF('#send_invite').addClass('send_invite_active');
    }
});
// Send invitation Share version 2 js by Pratap.
jQuery_WPF(document).on( 'click', '#send_invite', function() {
    jQuery_WPF('.avc_invite_error_msg1').hide();
    jQuery_WPF('.avc_invite_error_msg2').hide();
    jQuery_WPF('.avc_invite_error_msg3').hide();
    jQuery_WPF('.avc_invite_error_msg4').hide();
    jQuery_WPF('.avc_invite_name').removeClass('avc_red_border');
    jQuery_WPF('.avc_invite_email').removeClass('avc_red_border');
    if( is_empty == 0 ) {
        var user_data = [];
        jQuery_WPF('.avc_each_invite').each(function() {
            var name = jQuery_WPF('.avc_invite_name', this).val();
            var email = jQuery_WPF('.avc_invite_email', this).val();
            if ( email != '' ) {
                if ( IsEmail( email ) == true ) {
                    if ( name != '' ) {
                        if ( name.length >= 3 ) {
                            arr = [email, name];
                            user_data.push(arr);
                        } else {
                            jQuery_WPF('.avc_invite_error_msg3').show();
                            jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                            user_data = [];
                        }
                    } else {
                        jQuery_WPF('.avc_invite_error_msg1').show();
                        jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                        user_data = [];
                    }
                } else {
                    jQuery_WPF('.avc_invite_error_msg4').show();
                    jQuery_WPF('.avc_invite_email', this).addClass('avc_red_border');
                    if ( name != '' ) {
                        if ( name.length < 3 ) {
                            jQuery_WPF('.avc_invite_error_msg3').show();
                            jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                        }
                    } else {
                        jQuery_WPF('.avc_invite_error_msg1').show();
                        jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                    }
                    user_data = [];
                }
            } else {
                jQuery_WPF('.avc_invite_error_msg2').show();
                jQuery_WPF('.avc_invite_email', this).addClass('avc_red_border');
                if ( name != '' ) {
                    if ( name.length < 3 ) {
                        jQuery_WPF('.avc_invite_error_msg3').show();
                        jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                    }
                } else {
                    jQuery_WPF('.avc_invite_error_msg1').show();
                    jQuery_WPF('.avc_invite_name', this).addClass('avc_red_border');
                }
                user_data = [];
            }
        });
    }
    
    if ( user_data.length < 1 ) {
        jQuery_WPF('.avc_invite_error_container').animate({'right':'1px'}, 'slow');
        setTimeout(function() {
            jQuery_WPF('.avc_invite_error_container').animate({'right':'-375px'}, 'slow');
        }, 5000);
    }
    if ( user_data.length > 0 ) {
        var current_page  = jQuery_WPF('#avc_current_page').val();
        var site_title  = jQuery_WPF('#avc_site_title').val();
        jQuery_WPF.ajax({
            url: ajaxurl,
            type: 'POST',
            data: {
                action:'avc_send_invitations',
                wpf_nonce: wpf_nonce,
                user_data: user_data,
                current_page: current_page,
                site_title: site_title
            },
            beforeSend: function() {
                jQuery_WPF('.wpf_loader').show();
            },
            success: function( data ) {
                if ( data != '' ) {
                    data = JSON.parse( data );
                    if ( data.sent == 1 ) {
                        jQuery_WPF('.avc_invite_name').val('');
                        jQuery_WPF('.avc_invite_email').val('');
                        jQuery_WPF('.avc_invite_success').css('display', 'flex');
                        jQuery_WPF('.avc_suc_err_container').animate({'right':'1px'}, 'slow');
                        setTimeout(function() {
                            jQuery_WPF('.avc_suc_err_container').animate({'right':'-375px'}, 'slow', function() {
                                jQuery_WPF('.avc_invite_success').css('display', 'none');
                            });
                        }, 5000);
                        jQuery_WPF('.avc_each_invite').slice(1).remove();
                        jQuery_WPF('.avc_remove_invite').css('visibility', 'hidden');
                        if ( jQuery_WPF.isEmptyObject( data.success ) == false ) {
                            jQuery_WPF('.avc_shared_container').show();
                            var count = jQuery_WPF('.avc_shared_user_list .avc_invited_user').length;
                            count = count + 1;
                            jQuery_WPF.each( data.success, function( key, value ) {
                                var cloned = jQuery_WPF('.avc_hidden_user_structure .avc_invited_user').clone();
                                jQuery_WPF('.avc_ivi_user_img', cloned).html(value.initial);
                                jQuery_WPF('.avc_ivi_user_name', cloned).html('<span>' + value.name + '</span><br>' + value.email );
                                jQuery_WPF('.avc_delete_ivi_user', cloned).attr('data-id', value.id);
                                jQuery_WPF('.avc_share_page_link_input', cloned).attr('id', 'share_link_input' + count);
                                jQuery_WPF('.avc_share_page_link_input', cloned).attr('value', value.link);
                                jQuery_WPF('.avc_copy_link_icon', cloned).attr( 'onclick', 'avc_copy_to_clipboard(\'share_link_input' + count + '\')');
                                jQuery_WPF('.avc_shared_user_list').append(cloned);
                                cloned.hide().show('slow');
                                count = count + 1;
                            });
                        }
                    } else {
                        jQuery_WPF('.avc_invite_fail').css('display', 'flex');
                        jQuery_WPF('.avc_suc_err_container').animate({'right':'1px'}, 'slow');
                        setTimeout(function() {
                            jQuery_WPF('.avc_suc_err_container').animate({'right':'-375px'}, 'slow', function() {
                                jQuery_WPF('.avc_invite_fail').css('display', 'none');
                            });
                        }, 5000);
                    }
                }
                jQuery_WPF('.wpf_loader').hide();
            }
        });
    }
});
// Delete invitation Share version 2 js by Pratap.
jQuery_WPF(document).on( 'click', '.avc_delete_ivi_user', function() {
    if ( confirm( "Are you sure you want to delete this user? Deleting them from here will remove their WordPress user and their name from all tasks and comments they created." ) ) {
        var user_id = jQuery_WPF(this).data('id');
        var $this   = jQuery_WPF(this);
        if ( user_id > 0 ) {
            jQuery_WPF.ajax({
                url: ajaxurl,
                type: 'POST',
                data: {
                    action:'avc_delete_invitations',
                    wpf_nonce: wpf_nonce,
                    id: user_id,
                },
                beforeSend: function() {
                    jQuery_WPF('.wpf_loader').show();
                },
                success: function( data ) {
                    if ( data == 'true' ) {
                        $this.closest('.avc_invited_user').remove();
                        var count = jQuery_WPF('.avc_shared_user_list .avc_invited_user').length;
                        if ( count == 0 ) {
                            jQuery_WPF('.avc_shared_container').hide();
                        }
                        jQuery_WPF('.wpf_loader').hide();
                        jQuery_WPF('.avc_delete_success').css('display', 'flex');
                        jQuery_WPF('.avc_suc_err_container').animate({'right':'1px'}, 'slow');
                        setTimeout(function() {
                            jQuery_WPF('.avc_suc_err_container').animate({'right':'-375px'}, 'slow', function() {
                                jQuery_WPF('.avc_delete_success').css('display', 'none');
                            });
                        }, 5000);
                    }
                }
            });
        }
    }
});
// Add page for collaboration in sidebar script by Pratap.
jQuery_WPF('.wpf_add_page').on('click', function() {
    if(jQuery_WPF(this).hasClass('wpf_disabled')) {
        return;
    }
    jQuery_WPF(this).addClass('wpf_disabled');
    var page_title = '';
    if ( logged_user.wpside == 'backend' ) {
        page_title = wpf_current_screen;
    } else {
        page_title = current_page_title;
    }
    jQuery_WPF.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
            action:'wpf_add_page',
            wpf_nonce: wpf_nonce,
            current_page_id: current_page_id,
            current_page_url: current_page_url,
            current_page_title: page_title,
        },
        beforeSend: function() {
        },
        success: function( data ) {
            if( data != '403' ) {
                jQuery_WPF('.wpf_no_page_found').hide();
                jQuery_WPF('.wpf_page_list').prepend(jQuery_WPF(data).hide().delay(500).slideToggle('slow'));
            }
        }
    });
});
// Delete page from sidebar script by Pratap.
jQuery_WPF(document).on('click', '.wpf_delete_page', function() {
    var page_id = jQuery_WPF(this).parents('.wpf_each_page').data('page-id');
    var page = jQuery_WPF(this).parents('.wpf_each_page');
    jQuery_WPF.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
            action:'wpf_delete_page',
            wpf_nonce: wpf_nonce,
            page_id: page_id
        },
        beforeSend: function() {
            page.remove();
            if( jQuery_WPF('.wpf_each_page').length == 0 ) {
                jQuery_WPF('.wpf_no_page_found').show();
            }
        },
        success: function( data ) { 
        }
    });
});
// Redirect to page on click in sidebar page section script by Pratap.
jQuery_WPF(document).on('click', '.wpf_each_page', function(event) {
    $page_url = jQuery_WPF(this).data('page-url');
    if ( event.target.matches('.wpf_delete_page') || event.target.matches('.wpf_delete_page_icon') ) {
        return;
    }
    window.location.href = $page_url;
});
var lottie = '<lottie-player class="wpf_complete_task_anim" id="wpf_complete_task_anim" src="' + plugin_url + 'js/animation-complete.json" background="transparent"  speed="1" forceFlag preserveAspectRatio="xMidYMid slice"></lottie-player>';
jQuery_WPF(document).on('change', '.mark_as_complete_checkbox', function() {
    var task_id = jQuery_WPF(this).attr('data-id');
    if ( tasks_on_page[task_id] == 0 ) {
        jQuery_WPF('#wpf_task_error_'+task_id).show();
        jQuery("#mark_complete_"+task_id).removeAttr('checked');
    } else {
        jQuery_WPF('#wpf_task_error_'+task_id).hide();
        if(this.checked) {
            let status = "complete";
            jQuery("#wpfbtaskstatus-"+task_id+" .anim-slider input").prop('checked', false);
            jQuery("#wpfbtaskstatus-"+task_id+" .anim-slider .complete_radio").prop('checked', true);
            set_task_status(task_id,status);
            jQuery_WPF(this).after(lottie);
            setTimeout(() => {
                var player = document.getElementById("wpf_complete_task_anim");
                if (player) {
                    player.play();
                    setTimeout(function () {
                        player.stop();
                        jQuery_WPF('#wpf_complete_task_anim').remove();
                    }, 2000);
                }
            }, 50);
        }else{
            let status = "open";
            jQuery("#wpfbtaskstatus-"+task_id+" .anim-slider input").prop('checked', false);
            jQuery("#wpfbtaskstatus-"+task_id+" .anim-slider .open_radio").prop('checked', true);
            set_task_status(task_id,status);
        }
    }
});
// Delete uploaded file from task by Pratap.
jQuery_WPF(document).on('click', '.wpf_delete_icon', function() {
    var file_id = jQuery_WPF(this).parents('.wpf_file_icons').data('file-id');
    var doc = jQuery_WPF(this).closest('.wpf_uploaded_doc');
    jQuery_WPF.ajax({
        url: ajaxurl,
        type: 'POST',
        data: {
            action:'wpf_delete_file',
            wpf_nonce: wpf_nonce,
            file_id: file_id
        },
        beforeSend: function() {
            doc.remove();
        },
        success: function( data ) {
        }
    });
});
// Hide sidebar on small device by Pratap.
jQuery_WPF(document).on('click', '.wpf_hide_sidebar', function() {
    jQuery_WPF('.wpf_sidebar_container').animate({'right': '-300px'});
});